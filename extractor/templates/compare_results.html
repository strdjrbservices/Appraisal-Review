{% extends 'base.html' %}

{% load dict_helpers %}
{% block title %}Update File Review Results{% endblock %}

{% block content %}
<div class="results-container">
    <h1>Update File Review Results</h1>

    {% if results.error %}
        <div class="error-message">
            <p><strong>Error:</strong> {{ results.error }}</p>
        </div>
    {% else %}
    <div class="summary-grid">
        <div class="summary-card">
            <h3>Revised Report</h3>
            <p class="filename">{{ results.filename1 }}</p>
            <p class="page-count">{{ results.page_count_1 }} Page{{ results.page_count_1|pluralize }}</p>
        </div>
        <div class="summary-card">
            <h3>Old Report</h3>
            <p class="filename">{{ results.filename2 }}</p>
            <p class="page-count">{{ results.page_count_2 }} Page{{ results.page_count_2|pluralize }}</p>
        </div>

        <div class="summary-card supporting-docs-card">
            <h3>Supporting Documents</h3>
            {% if html_filename or purchase_filename or engagement_filename %}
                <p class="filename">{% if html_filename %}<strong>Order Form:</strong> {{ html_filename }}{% endif %}</p>
                <p class="filename">{% if purchase_filename %}<strong>Purchase Contract:</strong> {{ purchase_filename }}{% endif %}</p>
                <p class="filename">{% if engagement_filename %}<strong>Engagement Letter:</strong> {{ engagement_filename }}{% endif %}</p>
            {% else %}
                <p style="color: #6b7280; font-style: italic;">No supporting documents were uploaded.</p>
            {% endif %}
        </div>

        {% if results.market_value_1 or results.market_value_2 %}
        <div class="value-comparison-card">
            <h3 style="margin-bottom: 1rem;">Opinion of Market Value Comparison</h3>
            {% if results.market_value_1 != results.market_value_2 %}
                <div class="alert alert-warning">
                    <strong>Value Changed:</strong> The Opinion of Market Value in the revised report is different from the old report.
                </div>
                <p style="margin-top: 1rem;">
                    <strong>Old Report Value:</strong> <span style="text-decoration: line-through;">{{ results.market_value_2|default:"Not Found" }}</span><br>
                    <strong>Revised Report Value:</strong> <strong style="color: #166534;">{{ results.market_value_1|default:"Not Found" }}</strong>
                </p>
            {% else %}
                <div class="alert alert-success">
                    <strong>No Change:</strong> The Opinion of Market Value is consistent across both reports.
                </div>
                <p style="margin-top: 1rem;">
                    <strong>Value:</strong> <strong>{{ results.market_value_1|default:"Not Found" }}</strong>
                </p>
            {% endif %}
        </div>
        {% endif %}
    </div>

        {% if results.rejection_reason %}
        <div class="rejection-reason-card" style="grid-column: 1 / -1;">
            <h4>Original Rejection Reason</h4>
            <p>"{{ results.rejection_reason }}"</p>
            {% if results.revision_check_results %}
                {% with revision=results.revision_check_results %}
                    <div class="revision-status-box revision-{{ revision.status|lower }}">
                        <strong>Revision Status: {{ revision.status }}</strong>
                        <p>{{ revision.summary }}</p>
                        <p><em>Details: {{ revision.details }}</em></p>
                    </div>
                {% endwith %}
            {% endif %}
        </div>
        {% endif %}

        <div class="custom-analysis-section" style="display: flex; gap: 2rem; margin-top: 2rem;">
            <div style="flex: 1;">
                <h2>Custom Document Analysis</h2>
                <div class="analysis-card">
                    <p>Enter a question to perform a custom analysis on the revised and old reports.</p>
                    <div class="suggested-prompts">
                        <button type="button" class="prompt-suggestion-btn" data-prompt="Was the borrower's name corrected in the revised report?">Borrower Name</button>
                        <button type="button" class="prompt-suggestion-btn" data-prompt="Check if the 'Cost Approach' section was completed in the revised report.">Cost Approach</button>
                        <button type="button" class="prompt-suggestion-btn" data-prompt="Verify that the 'Indicated Value by Sales Comparison Approach' was updated in the revised report.">Sales Grid Value</button>
                        <button type="button" class="prompt-suggestion-btn" data-prompt="Please check below revision in Revised Report
                        


Any other updates">Report Rejection Reason Check</button>
                    </div>
                    <form action="{% url 'update_file_custom_analysis' %}" method="post" id="custom-analysis-form">
                        {% csrf_token %}
                        <input type="hidden" name="filename1" value="{{ results.filename1 }}">
                        <input type="hidden" name="filename2" value="{{ results.filename2 }}">
                        {% if html_filename %}<input type="hidden" name="html_filename" value="{{ html_filename }}">{% endif %}
                        {% if purchase_filename %}<input type="hidden" name="purchase_filename" value="{{ purchase_filename }}">{% endif %}
                        {% if engagement_filename %}<input type="hidden" name="engagement_filename" value="{{ engagement_filename }}">{% endif %}
                        
                        <textarea name="custom_prompt" placeholder="e.g., 'Was the borrower name corrected in the revised report?'">{% if custom_prompt %}{{ custom_prompt }}{% endif %}</textarea>
                        <button type="submit" class="btn-submit">Run Custom Analysis</button>
                    </form>
                </div>
            </div>

            <div style="flex: 1;">
                <h2>Analysis Results</h2>
                {% if custom_analysis_results %}
                <div class="custom-analysis-results">
                    {% if custom_analysis_results.error %}
                        <div class="error-message">
                            <p><strong>Custom Analysis Error:</strong> {{ custom_analysis_results.error }}</p>
                        </div>
                    {% else %}
                        <div class="query-display">
                            <p><strong>Your Query:</strong></p>
                            <p><em>{{ custom_prompt }}</em></p>
                        </div>

                        <div class="custom-analysis-summary">
                            <p><strong>Analysis Summary:</strong></p>
                            <p>{{ custom_analysis_results.analysis_summary }}</p>
                        </div>

                        {% if custom_analysis_results.findings %}
                            <h4 style="margin-top: 30px;">Findings:</h4>
                            <table class="findings-table">
                                <thead>
                                    <tr>
                                        <th>Finding</th>
                                        <th>Detail</th>
                                        <th>Source Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for finding in custom_analysis_results.findings %}
                                    <tr><td>{{ finding.finding_title }}</td><td>{{ finding.finding_detail }}</td><td>{{ finding.source_location }}</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>No specific findings were extracted for this query.</p>
                        {% endif %}
                    {% endif %}
                </div>
                {% else %}
                    <div class="placeholder-text" style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 2rem; text-align: center; color: #6b7280;">
                        <p>Your analysis results will appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="diff-section">
            <h2>Textual Differences</h2>
            {% if results.differing_pages %}
                <div class="alert alert-warning">
                    <p>Text content differences were found on matching pages. Click to expand.</p>
                </div>
                {% for diff_item in results.differing_pages %}
                    <div class="diff-details">
                        <div class="diff-header">
                            <span>Page {{ diff_item.page_number }}</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diff-content">
                            {{ diff_item.diff_html|safe }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-success">No textual differences found in the common pages.</div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('custom-analysis-form');
    if (form) {
        form.addEventListener('submit', function() {
            const overlay = document.getElementById('loader-overlay');
            if(overlay) {
                overlay.style.display = 'flex';
            }
        });
    }

    // Add functionality for prompt suggestion buttons
    document.querySelectorAll('.prompt-suggestion-btn').forEach(button => {
        button.addEventListener('click', function() {
            const promptText = this.getAttribute('data-prompt');
            const textarea = document.querySelector('#custom-analysis-form textarea[name="custom_prompt"]');
            textarea.value = promptText;
            textarea.focus();
        });
    });

    // Add functionality for collapsible diff sections
    document.querySelectorAll('.diff-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.arrow');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            arrow.classList.toggle('open');
        });
    });
});
</script>
{% endblock %}
                    