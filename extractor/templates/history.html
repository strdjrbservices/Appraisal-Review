{% extends 'base.html' %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center my-4">
        <h2>Extraction History</h2>
        <a href="{% url 'upload_pdf' %}" class="btn btn-success">New Upload</a>
    </div>

    <form method="get" action="{% url 'history' %}" class="mb-3">
        <div class="row g-2 align-items-center">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control" placeholder="Search by filename..." value="{{ query|default:'' }}">
            </div>
            <div class="col-md-3">
                <input type="date" name="start_date" class="form-control" placeholder="Start Date" value="{{ start_date|default:'' }}" aria-label="Start Date">
            </div>
            <div class="col-md-3">
                <input type="date" name="end_date" class="form-control" placeholder="End Date" value="{{ end_date|default:'' }}" aria-label="End Date">
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary w-100" type="submit">Filter</button>
            </div>
            <div class="col-md-1">
                <a href="{% url 'export_history_csv' %}?{{ request.GET.urlencode }}" class="btn btn-outline-success w-100" title="Export to CSV"><i class="fas fa-file-csv"></i> CSV</a>
            </div>
        </div>
        {% if query or start_date or end_date %}<div class="mt-2 text-end"><a href="{% url 'history' %}" class="text-decoration-none text-secondary"><small>Clear Filters</small></a></div>{% endif %}
    </form>

    <form id="bulk-delete-form" method="post" action="{% url 'bulk_delete_history' %}">
        {% csrf_token %}
    </form>

    {% if extracted_data_list %}
        <div class="d-flex justify-content-end mb-2">
            <button type="submit" form="bulk-delete-form" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete the selected items?');">Delete Selected</button>
        </div>
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 40px;"><input type="checkbox" id="select-all"></th>
                                <th scope="col">Filename</th>
                                <th scope="col">Section</th>
                                <th scope="col">Status</th>
                                <th scope="col">Last Updated</th>
                                <th scope="col" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in extracted_data_list %}
                            <tr>
                                <td><input type="checkbox" name="selected_items" value="{{ item.pk }}" form="bulk-delete-form"></td>
                                <td>{{ item.filename }}</td>
                                <td>{{ item.section_name|title }}</td>
                                <td>
                                    {% if item.data.error %}
                                        <span class="badge bg-danger">Error</span>
                                    {% else %}
                                        <span class="badge bg-success">Success</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.updated_at|date:"M d, Y H:i" }}</td>
                                <td class="text-end">
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'history_detail' item.pk %}" class="btn btn-sm btn-outline-primary">
                                            View
                                        </a>
                                        <form action="{% url 'delete_history' item.pk %}" method="post" style="display: inline-block; margin-left: 5px;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this history item?');">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if extracted_data_list.has_other_pages %}
                <div class="p-3 border-top">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if extracted_data_list.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ extracted_data_list.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                            {% endif %}

                            {% for i in extracted_data_list.paginator.page_range %}
                                {% if extracted_data_list.number == i %}
                                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                {% else %}
                                    <li class="page-item"><a class="page-link" href="?page={{ i }}{% if query %}&q={{ query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if extracted_data_list.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ extracted_data_list.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            No history records found. <a href="{% url 'upload_pdf' %}" class="alert-link">Upload a file</a> to start extracting data.
        </div>
    {% endif %}

{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="selected_items"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
        }
    });
</script>
{% endblock %}