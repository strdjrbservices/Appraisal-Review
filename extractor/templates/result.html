{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'extractor\css\style.css' %}">
    <title>Extraction Result: {{ section_title }}</title>
</head>
<body style="display: flex; margin: 0; background-color: var(--primary-bg); color: var(--text-primary);">
    {% load dict_helpers %}
    <div class="sidebar">
        <div class="sidebar-header">
            {% if user.is_authenticated %}
                <p class="username">Welcome, {{ user.username }}</p>
                <a href="{% url 'logout' %}" class="logout-link">Logout</a>
            {% endif %}
        </div>
        
        <h3 style="margin-top:0;">Sections</h3>
        <ul>
            {% for key, display_name in sections.items %} 
                {% if key != 'additional_comments' %}
                <li>
                    <a href="{% url 'extract_section' filename=filename section_name=key %}" class="section-link {% if key == section_key %}active{% endif %}">
                        {{ display_name }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}
        </ul>
        <div class="sidebar-footer">
            <a href="javascript:history.back()" class="back-btn">← Back</a>
            <a href="{% url 'upload_pdf' %}" class="new-upload-btn">New Upload</a>
        </div>
    </div>

    <div class="main-content">
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
        </div>

        <div class="header-container">
            <div class="header-main">
                <h1>{{ section_title }}</h1>
                <p><strong>Review Time:</strong> <span id="review-timer">00:00:00</span></p>
            </div>
            <button id="validate-btn" class="validate-button">Validate</button>
        </div>
        <div id="validation-container"></div>
        
        {% comment %} Display backend validation messages if they exist {% endcomment %}
        {% if data.backend_validation %}
            <div class="validation-message validation-{{ data.backend_validation.status }}">
                <strong>Backend Validation:</strong> {{ data.backend_validation.message }}
            </div>
        {% endif %}

        {% comment %} Display ADU validation messages if they exist {% endcomment %}
        {% if data.adu_validation %}
            {% with status_lower=data.adu_validation.status|lower %}
            <div class="validation-message validation-{% if 'fail' in status_lower %}error{% elif 'pass' in status_lower %}success{% else %}warning{% endif %}">
                <strong>ADU Validation:</strong> {{ data.adu_validation.message }}
            </div>
            {% endwith %}
        {% endif %}

        {% if data.error %}
            <p class="error">Error: {{ data.error }}</p>
        {% elif section_key == 'sales_grid' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Sales Grid Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Sales Comparison Approach</strong> grid.</p>
                        <ul class="revision-helper-list">
                            <li>Verify sales grid header data (counts, price ranges) is complete and correctly formatted.</li>
                            <li>Ensure at least 3 closed sales are used for the primary comps (not listings).</li>
                            <li>Verify comp data integrity: sale dates are logical (not future, not after effective date), verification sources are noted, proximity is filled.</li>
                            <li>Check for appropriate comp selection (e.g., leasehold comps for a leasehold subject, reasonable proximity).</li>
                            <li>Ensure Subject data (age, GLA, rooms, garage, amenities) is consistent with other sections (Improvements, Sketch, Page 1).</li>
                            <li>Verify ADU details are on a separate line item, not combined with the main unit's GLA/room counts.</li>
                            <li>Check for logical adjustment direction (e.g., superior features get negative adjustments).</li>
                            <li>Verify adjustment amounts are consistent for similar features across all comps (e.g., GLA, baths, condition).</li>
                            <li>Ensure adjustments are explained if not obvious (e.g., for View, Location, or Condition).</li>
                            <li>Verify the 'Indicated Value' is bracketed by the adjusted sale prices of the comparables.</li>
                            <li>Ensure the 'Indicated Value' in the grid matches the final value in the Reconciliation section.</li>
                            <li>Check for data entry errors in grid line items (e.g., a date in the 'Pool' field).</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {# Use the get_item filter to access the value by the field name #} 
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {# Display the final indicated value at the bottom, spanning all columns #}
                    <tr>
                        <td><strong>Indicated Value by Sales Comparison Approach</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Indicated Value by Sales Comparison Approach">
                            <strong>{{ data|get_item:"Indicated Value by Sales Comparison Approach"|default_if_none:"" }}</strong>
                        </td>
                    </tr>
                </tbody>
            </table>
        {% elif section_key == 'subject' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Subject Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    {% if is_fha_case %}
                        <div class="revision-helper-content">
                            <p>Use this checklist to verify common revision requests for an <strong>FHA Subject</strong> section.</p>
                            <ul class="revision-helper-list">
                                <li>Please include the FHA case# on all pages of the report.</li>
                                <li>Per photos the subject has repairs however the report made As-is. Please state whether the subject meets FHA 4000.1 handbook guidelines or not. If not, please revise to subject-to repair.</li>
                                <li>Please comment in the addendum that the intended user of the report is FHA/HUD.</li>
                                <li>Please state whether the subject meets FHA 4000.1 handbook guidelines or not.</li>
                                <li>Please comment if the attic was inspected.</li>
                                <li>Please comment if the crawlspace was inspected.</li>
                                <li>Please label the porch/patio/deck on sketch per the FHA requirement.</li>
                                <li>Comments indicate the report should be made subject to repairs. Please revise accordingly.</li>
                                <li>Please address if well and septic distances meet HUD guidelines.</li>
                            </ul>
                        </div>
                    {% endif %}
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Subject</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Mark that the subject is offered for sale.</li>
                            <li>Add the borrower's middle initial (M).</li>
                            <li>Update unit number in the subject’s address (e.g., Unit 123D).</li>
                            <li>Revise street name to "River Bend" (two words).</li>
                            <li>Revise street suffix from Cir to Dr.</li>
                            <li>Complete lender name (e.g., "aura capital funding mangement LLC").</li>
                            <li>Add street suffix ‘Dr’ in the lender address.</li>
                            <li>Revise property address to match order form (e.g., 3437-3439 Viking St).</li>
                            <li>Add ‘Inc’ at the end of the lender/client name (e.g., OCMBC Inc.).</li>
                            <li>Revise the borrower's last name (e.g., ‘Arnett’).</li>
                            <li>Revise the spelling of the lender's city (e.g., Tucson).</li>
                            <li>Revise the state in the lender's address (e.g., PA).</li>
                            <li>Remove ‘Inc’ from lender/client name (e.g., The Loan Store, JMAC Lending).</li>
                            <li>Add ‘W’ direction in the subject property address.</li>
                            <li>Revise lender/client address city name to match the order form.</li>
                            <li>Revise borrower name to match the order form.</li>
                            <li>Revise the spelling of the borrower’s first name.</li>
                            <li>Ensure ‘Legal Description’ is noted in the report.</li>
                            <li>If Legal Description is "see addendum", verify it's in the addendum.</li>
                            <li>Ensure ‘Assessor's Parcel #’ is noted.</li>
                            <li>Revise borrower name to a single name (e.g., Adam Gleve).</li>
                            <li>Ensure ‘Neighborhood Name’ is noted.</li>
                            <li>Verify occupancy if photos suggest vacant/occupied mismatch.</li>
                            <li>If Zoning is PUD, ensure PUD box is checked.</li>
                            <li>If PUD, ensure PUD Information section is complete.</li>
                            <li>If PUD/HOA amount is noted, ensure ‘per year/month’ is marked.</li>
                            <li>Uncheck the PUD box if not a PUD.</li>
                            <li>If PUD box is marked, verify HOA amount is not 0.</li>
                            <li>If not PUD, ensure PUD Information section is not completed.</li>
                            <li>Remove ‘Trust’ from lender/client name (e.g., BPL Mortgage, LLC).</li>
                            <li>Ensure ‘Property Rights Appraised’ is marked.</li>
                            <li>Revise lender/client name to match order form (e.g., NQM Funding, LLC).</li>
                            <li>Ensure owner of public record is included on page 1.</li>
                            <li>Revise suite number in the lender/client address (e.g., Suite 400).</li>
                            <li>Ensure offering price is noted if offered for sale.</li>
                            <li>Refer to attached legal description if applicable.</li>
                            <li>Ensure 'offered for sale' checkbox is appropriately marked.</li>
                            <li>Ensure 'ANSI Standard Confirmation' is marked.</li>
                            <li>Verify 'Reasonable Exposure Time Comment' is provided.</li>
                            <li>Ensure 'Prior Service Certification' is marked.</li>
                            <li>For investment property, revise occupancy to tenant or vacant.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'contract' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Contract Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Contract</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify 'Contract Price' matches the purchase agreement.</li>
                            <li>Verify 'Date of Contract' matches the purchase agreement.</li>
                            <li>If 'Financial Assistance' is YES, ensure the concession amount is not 0.</li>
                            <li>Verify the concession amount matches the purchase agreement.</li>
                            <li>Ensure transaction type (arm's length or non-arm's length) is provided.</li>
                            <li>If a purchase, ensure 'did' analyze contract is checked.</li>
                            <li>If a purchase, ensure all fields are completed.</li>
                            <li>If a refinance, ensure the entire section is blank.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'neighborhood' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Neighborhood Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Neighborhood</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify predominant price is between Low/High range for 'One-Unit Housing'.</li>
                            <li>Verify Low/High price range is not interchanged for 'One-Unit Housing'.</li>
                            <li>Verify predominant age is between Low/High range for 'One-Unit Housing'.</li>
                            <li>Ensure Low, High, and Predominant values are noted for 'One-Unit Housing'.</li>
                            <li>Ensure 'Neighborhood Boundaries' are provided for all directions (North, South, East, West).</li>
                            <li>Verify 'Present Land Use' percentages sum to 100%.</li>
                            <li>If 'Other' land use has a percentage, ensure a comment is provided.</li>
                            <li>If appraised value is >10% higher than predominant value, check for over-improvement comments.</li>
                            <li>If appraised value is >10% lower than predominant value, check for under-improvement comments.</li>
                            <li>Check for subjective/forbidden words in 'Neighborhood Description' (e.g., "average condition").</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'site' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Site Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Site</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Ensure 'Site Area' unit is specified (e.g., 'sf' or 'ac').</li>
                            <li>If 'Zoning Compliance' is 'Legal Nonconforming' or 'No Zoning', check for comments on rebuild rights.</li>
                            <li>If 'Zoning Compliance' is 'Illegal', check for a detailed explanation.</li>
                            <li>If 'Highest and Best Use' is 'No', ensure a description is provided.</li>
                            <li>If photos show an alley, verify the 'Alley' box is marked.</li>
                            <li>If 'Sanitary Sewer' is 'Septic', check for comments on whether it's typical for the area.</li>
                            <li>If both 'Well' and 'Septic' are present, check for comments on HUD distance requirements.</li>
                            <li>Verify 'Sanitary Sewer' value is consistent (e.g., not marked 'Public' if comments say 'Septic').</li>
                            <li>Verify 'FEMA Special Flood Hazard Area' and 'FEMA Flood Zone' are consistent (e.g., 'No' with 'X', 'Yes' with 'A'/'AE').</li>
                            <li>Ensure 'Adverse Site Conditions' checkbox matches the corresponding comments.</li>
                            <li>Verify 'Utilities typical for market area' checkbox is marked.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'improvements' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Improvements Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Improvements</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify 'One w/ Accessory Unit' (ADU) checkbox matches photos, sketch, and ADU qualifications (e.g., kitchen).</li>
                            <li>Ensure 'Design (Style)' is consistent between Improvements and Sales Grid.</li>
                            <li>Verify 'Existing/Proposed/Under Const.' status matches photos and report context.</li>
                            <li>Ensure all 'Material/Condition' fields (Walls, Roof, etc.) are fully completed.</li>
                            <li>If photos show an attic/crawl space, verify the corresponding box is marked.</li>
                            <li>Ensure 'Heating/Cooling' details are consistent between Improvements and Sales Grid.</li>
                            <li>Verify 'Gross Living Area' (GLA) is a whole number and consistent with the sketch.</li>
                            <li>Verify 'Garage' type (Att./Det.) and count are consistent with photos and sketch.</li>
                            <li>Ensure amenity checkboxes (e.g., 'Porch', 'Pool') are not marked if the description is 'None'.</li>
                            <li>Verify 'Physical Deficiencies' checkbox matches the corresponding comments.</li>
                            <li>Ensure all bedroom and bathroom photos are provided and not duplicated.</li>
                            <li>Verify the building sketch is present and labels (e.g., bath labels) are correct.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'reconciliation' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Reconciliation Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Reconciliation</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify the final 'Opinion of Market Value' matches the 'Indicated Value by Sales Comparison Approach'.</li>
                            <li>Ensure the 'Effective Date of Value' is correct and matches the inspection date.</li>
                            <li>If the report is 'subject to', verify the correct condition is checked (e.g., 'completion per plans', 'repairs', 'inspection').</li>
                            <li>If 'subject to', ensure a clear explanation and/or cost-to-cure is provided for the conditions.</li>
                            <li>If the report is 'as is', confirm there are no required repairs or health/safety issues noted elsewhere.</li>
                            <li>If Cost or Income approaches were developed, ensure their indicated values are present.</li>
                            <li>Confirm the final 'Opinion of Market Value' is bracketed by the adjusted sales prices of the comparables.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'sales_grid_adjustment' %}
            <h3>Adjustment Grid Data</h3>
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="custom-analysis-container" style="margin-top: 40px;">
                <h3>Adjustment Consistency Analysis</h3>
                <p class="custom-analysis-summary">{{ data.adjustment_analysis.summary }}</p>
                <p><strong>Details:</strong></p>
                <ul>{% for detail in data.adjustment_analysis.details %}<li>{{ detail }}</li>{% endfor %}</ul>
            </div>
        {% elif section_key == 'custom_analysis' %}
            <div class="custom-analysis-page-container">
                <div class="analysis-form-column">
                    <div class="analysis-card">
                        <h3>Custom Document Analysis</h3>
                        <p>Enter a question below, or select a suggestion to get started.</p>
                        <div class="suggested-prompts">
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Check for any discrepancies in the Gross Living Area (GLA) across all sections of the report.">GLA Consistency</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Verify that the subject property address is consistent across the Subject section, Sales Grid, Location Map, and Aerial Map

Also please confirm subject street, front and rear photo are present and no duplicates.">Verify Subject Address, Photo(Street, front, rear, Duplicates)</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Compare the bedroom and bathroom counts between the Improvements section, Sales Grid, and all available floor plans/ sktech/ building sketch and all photos.">Compare Room Counts</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Check Consistent values

Indicated Value by Sales Comparison Approach $ from sales grid

Indicated Value by: Sales Comparison Approach $ from Reconciliation

opinion of the market value $ from Reconciliation

APPRAISED VALUE OF SUBJECT PROPERTY $ from APPRAISER CERTIFICATION">Final value $ Consistency</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Match all comparable property addresses between the Sales Grid, photo pages, and the Location Map.

Also please confirm no duplicates.">Verify Comparable Address, Photo(Duplicates)</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Verify all Photo labels and no duplicate photos">Verify Photo Lables</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Check  'One with Accessory Unit' is selected in IMPROVEMENTS section, the following criteria must be met:

1.  This box should be checked if there is an additional dwelling with both a kitchen (containing a stove) and a bath.
    *   If there is interior access, the ADU may be included in the main unit's details.
    *   If there is no interior access, the ADU must be listed as a separate line item.
    *   If the ADU is considered a second floor, it may be included in the main unit's details.

2.  If the additional dwelling lacks either a kitchen or a bath, 'One with Accessory Unit' must be unchecked.

3.  If a basement contains a kitchen and bath, 'One with Accessory Unit' can be checked or unchecked.

4.  A room labeled 'kitchenette' should not have a stove; in this case, no health and safety comment is needed. However, if a kitchenette does contain a stove, escalate with a comment (permitted/health or safety).

    Escalation language: On page #, a room labeled as 'kitchenette' has a stove. Please advise.">ADU Criteria Check</button>
                            <div class="common-prompt-btn-container"> 
                                <button type="button" class="prompt-suggestion-btn" data-prompt="Please check and verify if below revision requests are addressed in the file.&#10;&#10;The date lease begins of rental comp# 3 is noted as Owner, please revise&#10;&#10;If addressed by comments, please verify if particular section is updated.&#10;&#10;If addressed, provide answer as revision and state corrected or not corrected. Keep it short.&#10;&#10;Below are extra points to confirm, don't address or treat as revision, just verify&#10;&#10;Also, please check if any checkboxes, or field are blank, if yes highlight in short&#10;&#10;consider below,&#10;&#10;if assignment type is refinance, then contract section should be blank, even checkboxes.&#10;&#10;If purchase, the appropriate field and checkboxes should be marked.&#10;&#10;In garage, check and validate according to checkboxes marked. &#10;&#10;Check if appraised value is matched at in total 4 locations.&#10;&#10;The signature date should be greater than effective date. Effective date is as of date.&#10;&#10;In signature page Company Name/AMC Name should include Fastapp&#10;&#10;Check for prior services, exposure comment, check is appraiser invoice is attached if yes need to remove.&#10;&#10;Please answer 1 per line not in paragraph">
                                    Common Prompt
                                </button>
                                <div class="common-prompt-details">
                                    <p><strong>This prompt includes checks for:</strong></p>
                                    <ul>
                                        <li>Specific revision requests</li>
                                        <li>Blank fields/checkboxes</li>
                                        <li>Refinance/Purchase logic</li>
                                        <li>Appraised value consistency</li>
                                        <li>Date validation (Signature vs. Effective)</li>
                                        <li>And more...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <form action="{% url 'extract_section' filename=filename section_name='custom_analysis' %}" method="post" id="custom-analysis-form">
                            {% csrf_token %}
                            <textarea name="custom_prompt" placeholder="e.g., 'Check for any discrepancies in the Gross Living Area (GLA) across all sections of the report.'">{{ custom_prompt|default_if_none:"" }}</textarea>
                            <button type="submit" class="btn-submit">Run Custom Analysis</button>
                            <button type="button" id="finish-review-btn" class="btn-finish">Finish Review</button>
                        </form>
                    </div>
                </div>
                <div class="analysis-results-column">
                    {% if data.analysis_summary %}
                        <div class="custom-analysis-container">
                            {% if custom_prompt %}
                            <div class="query-display">
                                <p><strong>Your Query:</strong></p>
                                <p><em>{{ custom_prompt }}</em></p>
                            </div>
                            {% endif %}

                            <div class="custom-analysis-summary">
                                <p><strong>Analysis Summary:</strong></p>
                                <p>{{ data.analysis_summary }}</p>
                            </div>

                            <h4 style="margin-top: 30px;">Findings:</h4>
                            {% if data.findings %}
                                <table class="findings-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Detail</th>
                                            <th>Finding</th>
                                            <th>Source Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for finding in data.findings %}
                                        <tr>
                                            <td>
                                                <span class="status-{{ finding.status|lower }}">{{ finding.status|default:"Info" }}</span>
                                            </td>
                                            <td>{{ finding.finding_detail }}</td>
                                            <td class="finding-title">{{ finding.finding_title }}</td>
                                            <td class="finding-source">{{ finding.source_location }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p>No specific findings were extracted for this query.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="placeholder-text">
                            <p>Your analysis results will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% elif section_key == 'sale_history' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Sale History Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Sale History</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Please check that your research "Did" reveal a prior sale, as Comp 3 sold within a year.</li>
                            <li>Please check that your research "Did Not" reveal any prior sales for the comparables.</li>
                            <li>Please check that your research "Did" reveal a prior sale, as the Subject sold within 3 years.</li>
                            <li>Please check that your research "Did Not" reveal a prior sale, as the Subject has not sold within 3 years.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <h3>Prior Sale History Grid</h3>
            {% if data.subject and data.comparables %}
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Subject</th>
                            {% for comp in data.comparables %}
                                <th>Comparable #{{ forloop.counter }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for field, subject_value in data.subject.items %}
                        <tr>
                            <td>{{ field }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                            {% for comp in data.comparables %}
                                <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                    {{ comp|get_item:field|default_if_none:"" }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
            <h3 style="margin-top: 40px;">Research and Analysis</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if key != 'subject' and key != 'comparables' %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'rental_grid' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Rental Grid Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Rental Grid (1007)</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Please have the 1007 form included in the report.</li>
                            <li>Revise subject's lease dates per the lease agreement on the 1007 form.</li>
                            <li>Provide all rental comps photos in the report.</li>
                            <li>Include the rental comparables on the location map.</li>
                            <li>The occupancy is marked as owner; however, the 1007 form says vacant. Please verify.</li>
                            <li>Revise ‘Date Lease Expires’ for rental comp as it is prior to or the same as its ‘Date Lease Begins’.</li>
                            <li>The opinion of market rent is not bracketed by the adjusted rent price of rental comps, please revise.</li>
                            <li>Please have the opinion of market rent noted on the 1007 form.</li>
                            <li>Please review the GLA adjustments made on 1007 form as they appear excessive.</li>
                            <li>Please have the ‘Date Lease Begins’ and ‘Date Lease Expires’ noted for all rental comps.</li>
                            <li>The occupancy is marked as Owner; however, the photos indicate it is vacant, and the 1007 form shows it is currently rented. Please verify/revise.</li>
                            <li>Please attach the 1007 to the original report and upload. The 1007 does not need to be separately uploaded.</li>
                            <li>Please have the 'Proximity to Subject' noted for all rental comps on the 1007 form.</li>
                            <li>Client requires a minimum of 3 closed rentals to develop market rent. Please provide additional rental comps.</li>
                            <li>The subject cannot be used as a rental comp. Please find an alternate comp.</li>
                            <li>Rental comps appear to be long-term rentals; however, their lease date is noted as “Per Night.” Please revise.</li>
                            <li>Market rent is significantly different from the current rent. Please advise.</li>
                            <li>The subject is in rent control; however, all comps used are not. Please provide a similar comp or comment.</li>
                            <li>Rental comps lease dates reflect 'Active Listing'. Please utilize a minimum of 3 closed rentals.</li>
                            <li>For rent schedule, if the order was for short-term rentals, please utilize short-term rentals to develop market rent.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {# Display the summary fields at the bottom, spanning all columns #}
                    <tr>
                        <td><strong>Indicated Monthly Market Rent</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Indicated Monthly Market Rent">
                            <strong>{{ data|get_item:"Indicated Monthly Market Rent"|default_if_none:"" }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Comments on market data...</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Comments on market data...">
                            {{ data|get_item:"Comments on market data..."|default_if_none:"" }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Final Reconciliation of Market Rent:</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Final Reconciliation of Market Rent:">
                            {{ data|get_item:"Final Reconciliation of Market Rent:"|default_if_none:"" }}
                        </td>
                    </tr>
                </tbody>
            </table>
        {% elif section_key == 'consistancy' %}
            <table>
                <thead>
                    <tr>
                        <th>Consistency Check</th>
                        <th>Finding</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% with value_lower=value|lower %}
                        <tr class="consistency-check {% if 'mismatch' in value_lower or 'discrepancies' in value_lower %}consistency-mismatch{% else %}consistency-success{% endif %}">
                            <td class="check-title" data-field-name="{{ key }}">{{ key }}</td>
                            <td class="check-details editable-value" contenteditable="true" data-field-name="{{ key }} - Finding">
                                {{ value|default_if_none:"" }}
                            </td>
                        </tr>
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'market_conditions' %}
            <h3>Market Conditions Analysis Grid</h3>
            <table>
                <thead>
                    <tr>
                        <th>Inventory and Price Analysis</th>
                        <th>Prior 7–12 Months</th>
                        <th>Prior 4–6 Months</th>
                        <th>Current – 3 Months</th>
                        <th>Overall Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 7–12 Months">{{ value|get_item:"Prior 7–12 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 4–6 Months">{{ value|get_item:"Prior 4–6 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Current – 3 Months">{{ value|get_item:"Current – 3 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Overall Trend">{{ value|get_item:"Overall Trend"|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <h3 style="margin-top: 40px;">Additional Market Information</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if not value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'condo' %}
            <h3>Subject Project Data Grid</h3>
            <table>
                <thead>
                    <tr>
                        <th>Project Data Analysis</th>
                        <th>Prior 7–12 Months</th>
                        <th>Prior 4–6 Months</th>
                        <th>Current – 3 Months</th>
                        <th>Overall Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 7–12 Months">{{ value|get_item:"Prior 7–12 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 4–6 Months">{{ value|get_item:"Prior 4–6 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Current – 3 Months">{{ value|get_item:"Current – 3 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Overall Trend">{{ value|get_item:"Overall Trend"|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <h3 style="margin-top: 40px;">Additional Condo Information</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if not value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'client_lender_requirements' %}
            <table>
                <thead>
                    <tr>
                        <th>Client Requirement Check</th>
                        <th>Finding</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if 'N/A - Rule does not apply' not in value %}
                            {% with value_lower=value|lower %}
                            <tr class="consistency-check {% if 'fail' in value_lower or 'mismatch' in value_lower %}consistency-mismatch{% else %}consistency-success{% endif %}">
                                <td class="check-title">{{ key }}</td>
                                <td class="check-details editable-value" contenteditable="true" data-field-name="{{ key }} - Finding">{{ value|default_if_none:"" }}</td>
                            </tr>
                            {% endwith %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'cost_approach' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Cost Approach Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Cost Approach</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Please include the ‘OPINION OF SITE VALUE’ in the report.</li>
                            <li>Please include the ‘Estimated Remaining Economic Life’ in the report.</li>
                            <li>Please revise the conflicting comment noted on page# 4 which reads “Estimated remaining economic life: 59 Years.” However the same section also comment noted as ‘remaining economic life of 60 years’</li>
                            <li>Please develop the cost approach section of the report per client requirement.</li>
                            <li>1004C: Fannie Mae requires appraisers to complete the cost approach for all manufactured homes. Please include the cost approach.</li>
                            <li>Please have the appropriate checkbox marked in the cost approach section. (i.e. REPRODUCTION OR REPLACEMENT COST NEW)</li>
                            <li>For BPL only: This client requires the Cost Approach to be completed. Even if this approach is not weighted in determining value, it must be completed.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)</td><td contenteditable="true" class="editable-value" data-field-name="Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)">{{ data|get_item:"Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)"|default_if_none:"" }}</td></tr>
                    <tr><td>Source of cost data</td><td contenteditable="true" class="editable-value" data-field-name="Source of cost data">{{ data|get_item:"Source of cost data"|default_if_none:"" }}</td></tr>
                    <tr><td>Quality rating from cost service</td><td contenteditable="true" class="editable-value" data-field-name="Quality rating from cost service">{{ data|get_item:"Quality rating from cost service"|default_if_none:"" }}</td></tr>
                    <tr><td>Effective date of cost data</td><td contenteditable="true" class="editable-value" data-field-name="Effective date of cost data">{{ data|get_item:"Effective date of cost data"|default_if_none:"" }}</td></tr>
                    
                    <tr style="background-color: #f9fafb;"><td colspan="2" style="padding: 8px;"></td></tr>

                    <tr><td>Opinion of Site Value</td><td contenteditable="true" class="editable-value" data-field-name="Opinion of Site Value">{{ data|get_item:"Opinion of Site Value"|default_if_none:"" }}</td></tr>
                    
                    <tr><td>ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)</td><td contenteditable="true" class="editable-value" data-field-name="ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)">{{ data|get_item:"ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)"|default_if_none:"" }}</td></tr>
                    
                    <tr><td>Dwelling</td><td contenteditable="true" class="editable-value" data-field-name="Dwelling">{{ data|get_item:"Dwelling"|default_if_none:"" }}</td></tr>
                    <tr><td>Garage/Carport</td><td contenteditable="true" class="editable-value" data-field-name="Garage/Carport">{{ data|get_item:"Garage/Carport"|default_if_none:"" }}</td></tr>
                    <tr><td><strong>Total Estimate of Cost-New</strong></td><td contenteditable="true" class="editable-value" data-field-name="Total Estimate of Cost-New"><strong>{{ data|get_item:"Total Estimate of Cost-New"|default_if_none:"" }}</strong></td></tr>
                    
                    <tr style="background-color: #f9fafb;"><td colspan="2" style="padding: 8px;"></td></tr>

                    <tr><td>Depreciation</td><td contenteditable="true" class="editable-value" data-field-name="Depreciation">{{ data|get_item:"Depreciation"|default_if_none:"" }}</td></tr>
                    <tr><td><strong>Depreciated Cost of Improvements</strong></td><td contenteditable="true" class="editable-value" data-field-name="Depreciated Cost of Improvements"><strong>{{ data|get_item:"Depreciated Cost of Improvements"|default_if_none:"" }}</strong></td></tr>
                    <tr><td>As-is Value of Site Improvements</td><td contenteditable="true" class="editable-value" data-field-name="As-is Value of Site Improvements">{{ data|get_item:"As-is Value of Site Improvements"|default_if_none:"" }}</td></tr>
                    
                    <tr style="background-color: #f3f4f6;">
                        <td><strong>Indicated Value By Cost Approach</strong></td>
                        <td contenteditable="true" class="editable-value" data-field-name="Indicated Value By Cost Approach"><strong>{{ data|get_item:"Indicated Value By Cost Approach"|default_if_none:"" }}</strong></td>
                    </tr>
                    <tr><td>Comments on Cost Approach (gross living area calculations, depreciation, etc.)</td><td contenteditable="true" class="editable-value" data-field-name="Comments on Cost Approach (gross living area calculations, depreciation, etc.)">{{ data|get_item:"Comments on Cost Approach (gross living area calculations, depreciation, etc.)"|default_if_none:"" }}</td></tr>
                    <tr><td>Estimated Remaining Economic Life (HUD and VA only)</td><td contenteditable="true" class="editable-value" data-field-name="Estimated Remaining Economic Life (HUD and VA only)">{{ data|get_item:"Estimated Remaining Economic Life (HUD and VA only)"|default_if_none:"" }}</td></tr>
                </tbody>
            </table>
        {% else %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timerDisplay = document.getElementById('review-timer');
            if (timerDisplay) {
                let timerInterval;
                // Get start time from session storage, or create it if it doesn't exist
                let startTime = sessionStorage.getItem('reviewStartTime');
                if (!startTime) {
                    startTime = Date.now();
                    sessionStorage.setItem('reviewStartTime', startTime);
                }

                function updateTimer() {
                    const now = Date.now();
                    const elapsed = Math.floor((now - startTime) / 1000); // total seconds

                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const secs = elapsed % 60;

                    const formattedTime =
                        String(hours).padStart(2, '0') + ':' +
                        String(minutes).padStart(2, '0') + ':' +
                        String(secs).padStart(2, '0');
                    timerDisplay.textContent = formattedTime;
                }
                updateTimer(); // Run once immediately
                timerInterval = setInterval(updateTimer, 1000);
            }
            const links = document.querySelectorAll('.section-link');
            const loadingOverlay = document.getElementById('loading-overlay');

            links.forEach(link => {
                link.addEventListener('click', function(event) {
                    // If the link is already disabled, do nothing.
                    if (this.classList.contains('disabled')) {
                        event.preventDefault();
                        return;
                    }
                    // Show the loading spinner
                    loadingOverlay.style.display = 'flex';

                    // "Freeze" all other links to prevent multiple clicks
                    links.forEach(otherLink => otherLink.classList.add('disabled'));
                });
            });

            function runValidations() {
                const validationContainer = document.getElementById('validation-container');
                // Clear previous validation messages before running again
                validationContainer.innerHTML = '';

                const tableRows = document.querySelectorAll('tbody tr');

                {% if section_key == 'subject' %}
                // Hide FHA field if it's blank
                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'FHA') {
                        const valueCell = row.querySelector('td:last-child');
                        const fhaValue = valueCell.textContent.trim();
                        if (!fhaValue || fhaValue === '--' || fhaValue === 'null') {
                            row.style.display = 'none';
                        }
                    }
                });

                // Validation for "Purchase Transaction" requiring "Contract" section
                let assignmentType = null;
                // Clear the session storage flag initially on subject page load
                sessionStorage.removeItem('isPurchaseTransaction');
                // Clear PUD flag to avoid stale data from previous file reviews
                sessionStorage.removeItem('isPUD');
                sessionStorage.removeItem('subjectLenderClient');
                sessionStorage.removeItem('isRefinanceTransaction');
                sessionStorage.removeItem('subjectFullAddress');
                // Clear state-specific flags
                sessionStorage.removeItem('subjectState');

                const getFieldValue = (fieldName) => {
                    const row = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'Assignment Type') {
                        // Capture Assignment Type for conditional validation
                        assignmentType = valueCell.textContent.trim();
                    }
                    // Capture Lender/Client for cross-validation
                    if (fieldCell && fieldCell.textContent.trim() === 'Lender/Client') {
                        const lenderClientName = valueCell.textContent.trim();
                        if (lenderClientName && lenderClientName !== '--' && lenderClientName !== 'null') {
                            sessionStorage.setItem('subjectLenderClient', lenderClientName);
                        }
                    }
                    // Capture State for state-specific validations
                    if (fieldCell && fieldCell.textContent.trim() === 'State') {
                        const state = valueCell.textContent.trim().toUpperCase();
                        if (state) sessionStorage.setItem('subjectState', state);
                    }
                });
                
                // Capture Lender/Client Address for cross-validation
                const lenderAddress = getFieldValue('Address (Lender/Client)');
                if (lenderAddress && lenderAddress !== '--' && lenderAddress !== 'null') {
                    sessionStorage.setItem('subjectLenderAddress', lenderAddress);
                }


                if (assignmentType === 'Purchase Transaction') {
                    // Set a flag in session storage to be used by the 'Contract' section validation
                    sessionStorage.setItem('isPurchaseTransaction', 'true');

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-warning');
                    messageDiv.textContent = "⚠️ Warning: Assignment Type is 'Purchase Transaction'. Please ensure the 'Contract' section is filled out as required.";
                    
                    // Create a link to the 'Contract' section
                    const contractLink = document.createElement('a');
                    contractLink.href = `{% url 'extract_section' filename=filename section_name='contract' %}`;
                    contractLink.textContent = "Contract section";
                    contractLink.onclick = function() {
                        document.getElementById('loading-overlay').style.display = 'flex';
                    };

                    messageDiv.innerHTML = "⚠️ Warning: Assignment Type is 'Purchase Transaction'. Please ensure the ";
                    messageDiv.appendChild(contractLink);
                    messageDiv.innerHTML += " is filled out as required.";
                    validationContainer.appendChild(messageDiv);
                } else if (assignmentType === 'Refinance Transaction') {
                    // Set a flag for refinance transactions
                    sessionStorage.setItem('isRefinanceTransaction', 'true');

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-warning');
                    
                    const contractLink = document.createElement('a');
                    contractLink.href = `{% url 'extract_section' filename=filename section_name='contract' %}`;
                    contractLink.textContent = "Contract section";
                    contractLink.onclick = function() {
                        document.getElementById('loading-overlay').style.display = 'flex';
                    };

                    messageDiv.innerHTML = "ℹ️ Info: Assignment Type is 'Refinance Transaction'. The ";
                    messageDiv.appendChild(contractLink);
                    messageDiv.innerHTML += " should be blank.";
                    validationContainer.appendChild(messageDiv);
                }

                // New Validation: Check for address consistency reminder
                const addressFields = ['Property Address', 'City', 'State', 'Zip Code'];
                let addressValues = {};
                let allAddressFieldsPresent = true;

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        if (addressFields.includes(fieldName)) {
                            const value = valueCell.textContent.trim();
                            if (value && value !== '--' && value !== 'null') {
                                addressValues[fieldName] = value;
                            }
                        }
                    }
                });

                // Check if all parts of the address were found
                if (Object.keys(addressValues).length !== addressFields.length) {
                    allAddressFieldsPresent = false;
                }

                if (allAddressFieldsPresent) {
                    const fullAddress = `${addressValues['Property Address']}, ${addressValues['City']}, ${addressValues['State']} ${addressValues['Zip Code']}`;
                    sessionStorage.setItem('subjectFullAddress', fullAddress);
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-warning');
                    messageDiv.textContent = `ℹ️ Consistency Check: Please verify that the address "${fullAddress}" matches the address shown in the Sales Grid, Location Map, Aerial Map, and on Subject Photos.`;
                    validationContainer.appendChild(messageDiv);
                }

                // --- New Comprehensive Subject Field Validation ---
                const alwaysRequiredFields = [
                    'Property Address', 'City', 'County', 'State', 'Zip Code', 'Borrower', 'Owner of Public Record',
                    'Legal Description', "Assessor's Parcel #", 'Tax Year', 'R.E. Taxes $', 'Neighborhood Name', 'Map Reference',
                    'Census Tract', 'Occupant', 'Special Assessments $', 'PUD',
                    'Property Rights Appraised', 'Assignment Type', 'Lender/Client', 'Address (Lender/Client)',
                    'Offered for Sale in Last 12 Months',
                    'ANSI Standard Confirmation', 'Reasonable Exposure Time Comment', 'Prior Service Certification'
                ];
                const missingRequiredFields = [];
                let pudValue = '';
                let hoaValue = '';
                let hoaTermValue = '';
                let offeredForSaleValue = '';
                let offeredForSaleDetails = '';
                let reTaxesValue = '';

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();

                        // Check if always-required fields are empty
                        if (alwaysRequiredFields.includes(fieldName) && (!value || value === '--' || value === 'null')) {
                            missingRequiredFields.push(fieldName);
                        }

                        // Capture values for conditional checks
                        if (fieldName === 'PUD') pudValue = value.toLowerCase();
                        if (fieldName === 'HOA $') hoaValue = value;
                        if (fieldName === 'HOA(per year/per month)') hoaTermValue = value;
                        if (fieldName === 'Offered for Sale in Last 12 Months') offeredForSaleValue = value.toLowerCase();
                        if (fieldName === 'Report data source(s) used, offering price(s), and date(s)') offeredForSaleDetails = value.toLowerCase();
                        if (fieldName === 'R.E. Taxes $') reTaxesValue = value;
                    }
                });

                // Display message for missing always-required fields
                if (missingRequiredFields.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation warning: The following required fields are empty: ${missingRequiredFields.join(', ')}.`;
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for R.E. Taxes $
                if (reTaxesValue && reTaxesValue !== '--' && reTaxesValue !== 'null') {
                    const taxAmount = parseFloat(reTaxesValue.replace(/[$,]/g, ''));
                    if (!isNaN(taxAmount)) {
                        // Check if the integer part has more than 4 digits
                        if (Math.trunc(taxAmount).toString().length > 4) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: 'R.E. Taxes $' value (${reTaxesValue}) appears to have more than 4 digits. Please verify.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                }

                // Conditional Validation for PUD
                if (pudValue === 'yes') {
                    // Set flag for other sections
                    sessionStorage.setItem('isPUD', 'true');
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    const hoaAmount = parseFloat(hoaValue.replace(/[$,]/g, ''));
                    const isHoaAmountInvalid = isNaN(hoaAmount) || hoaAmount <= 0;
                    const isHoaTermMissing = !hoaTermValue || hoaTermValue === '--' || hoaTermValue === 'null';

                    if (isHoaAmountInvalid || isHoaTermMissing) {
                        messageDiv.classList.add('validation-error');
                        let errorParts = [];
                        if (isHoaAmountInvalid) errorParts.push("'HOA $' must be a number greater than 0");
                        if (isHoaTermMissing) errorParts.push("'HOA(per year/per month)' must be filled");
                        messageDiv.textContent = `⚠️ Validation warning: PUD is 'Yes'. ${errorParts.join(' and ')}.`;
                    } else {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: PUD is 'Yes' and HOA details are correctly filled.`;
                    }
                    validationContainer.appendChild(messageDiv);

                    // Add the warning for the PUD Info section as well
                    const pudInfoWarningDiv = document.createElement('div');
                    pudInfoWarningDiv.classList.add('validation-message', 'validation-warning');
                    pudInfoWarningDiv.textContent = "ℹ️ Info: PUD is marked as 'Yes'. Please ensure the 'PUD Info' section is filled out completely.";
                    validationContainer.appendChild(pudInfoWarningDiv);
                }

                // Conditional Validation for 'Offered for Sale'
                if (offeredForSaleValue === 'yes') {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    const detailsMissing = !offeredForSaleDetails || offeredForSaleDetails === '--' || offeredForSaleDetails === 'null';
                    const keywords = ['dom', 'listed'];
                    const missingKeywords = keywords.filter(kw => !offeredForSaleDetails.includes(kw));
                    const hasMls = offeredForSaleDetails.includes('mls') || offeredForSaleDetails.includes('multiple listing service');

                    if (detailsMissing || missingKeywords.length > 0 || !hasMls) {
                        messageDiv.classList.add('validation-error');
                        let errorMsg = "⚠️ Validation warning: 'Offered for Sale' is 'Yes', but the details are incomplete. ";
                        let errorParts = [];
                        if (detailsMissing) errorMsg += "The details field is empty.";
                        if (missingKeywords.length > 0) errorParts.push(`missing keywords: ${missingKeywords.join(', ')}`);
                        if (!hasMls) errorParts.push("missing 'MLS' or 'Multiple Listing Service'");
                        if (errorParts.length > 0) errorMsg += `Details are incomplete: ${errorParts.join('; ')}.`;
                        messageDiv.textContent = errorMsg;
                    } else {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: 'Offered for Sale' is 'Yes' and the required details (DOM, listing, listing date, MLS) are present.`;
                    }
                    validationContainer.appendChild(messageDiv);
                }
                
                // // Info message for Lender/Client validation
                // if (sessionStorage.getItem('subjectLenderClient')) {
                //     const messageDiv = document.createElement('div');
                //     messageDiv.classList.add('validation-message', 'validation-warning');
                //     messageDiv.textContent = `ℹ️ Info: The Lender/Client name will be cross-referenced with the 'Certification' section for consistency.`;
                //     validationContainer.appendChild(messageDiv);
                // }

                // FHA Validation
                const fhaValue = getFieldValue('FHA');
                if (fhaValue && fhaValue !== '--' && fhaValue !== 'null') {
                    sessionStorage.setItem('isFhaCase', 'true');
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-warning');
                    
                    // Create a link to the custom analysis section that carries the FHA flag
                    const customAnalysisLink = document.createElement('a');
                    // Append ?fha=true to the URL
                    customAnalysisLink.href = `{% url 'extract_section' filename=filename section_name='custom_analysis' %}?fha=true`;
                    customAnalysisLink.textContent = 'Custom Analysis section';
                    customAnalysisLink.onclick = function() {
                        document.getElementById('loading-overlay').style.display = 'flex';
                    };

                    messageDiv.innerHTML = "ℹ️ FHA case detected. Please check FHA instructions in the ";
                    messageDiv.appendChild(customAnalysisLink);
                    messageDiv.innerHTML += ".";
                    
                    validationContainer.appendChild(messageDiv);
                }

                // --- New Rental Form (1007) Detection ---
                {% if is_rental_form %}
                const rentalMessageDiv = document.createElement('div');
                rentalMessageDiv.classList.add('validation-message', 'validation-warning');

                // Create a link to the custom analysis section
                const rentalCustomAnalysisLink = document.createElement('a');
                rentalCustomAnalysisLink.href = `{% url 'extract_section' filename=filename section_name='custom_analysis' %}`;
                rentalCustomAnalysisLink.textContent = 'Custom Analysis section';
                rentalCustomAnalysisLink.onclick = function() {
                    document.getElementById('loading-overlay').style.display = 'flex';
                };

                rentalMessageDiv.innerHTML = "ℹ️ Rental form detected. Please check rental form instructions in the ";
                rentalMessageDiv.appendChild(rentalCustomAnalysisLink);
                rentalMessageDiv.innerHTML += ".";
                validationContainer.appendChild(rentalMessageDiv);
                {% endif %}
                // --- New "Unpaid OK" Lender Validation ---
                const unpaidOkLenders = [
                    'prmg', 'paramount residential mortgage group',
                    'cardinal financial company',
                    'ice lender holdings llc',
                    'np inc', 'nqm funding, llc',
                    'east coast capital',
                    'guaranteed rate. inc',
                    'commercial lender, llc',
                    'direct lending partners',
                    'civic',
                    'cv3',
                    'united faith mortgage',
                    'arixa capital', 'crosswind financial', 'western alliance bank',
                    'rcn capital, llc',
                    'aura mortgage advisors, llc', 'blue hub capital',
                    'nations direct mortgage llc',
                    'sierra pacific mortgage company inc',
                    'champions funding llc'
                ];
                const lenderClient = getFieldValue('Lender/Client')?.toLowerCase() || '';
                const loanNumber = getFieldValue('Loan Number') || '';

                const isUnpaidOkLender = unpaidOkLenders.some(lender => lenderClient.includes(lender));
                const isLoanDepotSpecialCase = lenderClient.includes('loandepot.com') && (loanNumber.startsWith('1') || loanNumber.startsWith('4'));

                if (isUnpaidOkLender || isLoanDepotSpecialCase) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-success');
                    messageDiv.textContent = `✅ Unpaid OK lender`;
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}

                {% if section_key == 'base_info' %}
                // --- Validation for Base Info section ---
                const getFieldValue = (fieldName) => {
                    const row = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                const addValidationMessage = (type, message) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', `validation-${type}`);
                    messageDiv.innerHTML = message;
                    validationContainer.appendChild(messageDiv);
                };

                const appraisalFormType = getFieldValue('APPRAISAL FORM TYPE (1004/1025/1004D/1073)');
                const additionalForm = getFieldValue('Additional Form (1007/216/Rental/STR)');
                // Capture new field values
                const ansiValue = getFieldValue('ANSI Standard Confirmation')?.toLowerCase();
                const exposureCommentValue = getFieldValue('Reasonable Exposure Time Comment');
                const priorServiceValue = getFieldValue('Prior Service Certification')?.toLowerCase();

                // 1. Validate APPRAISAL FORM TYPE
                if (!appraisalFormType || appraisalFormType === '--' || appraisalFormType === 'null') {
                    addValidationMessage('error', "⚠️ Validation warning: 'APPRAISAL FORM TYPE' cannot be blank.");
                } else {
                    const validFormTypes = ['1004', '1025', '1004D', '1073'];
                    if (!validFormTypes.some(type => appraisalFormType.includes(type))) {
                        addValidationMessage('error', `⚠️ Validation warning: 'APPRAISAL FORM TYPE' ('${appraisalFormType}') is not a recognized type (e.g., 1004, 1025, 1004D, 1073).`);
                    } else {
                        addValidationMessage('success', `✅ Validation successful: 'APPRAISAL FORM TYPE' is '${appraisalFormType}'.`);
                    }
                }

                // 2. Validate Additional Form
                if (!additionalForm || additionalForm === '--' || additionalForm === 'null') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Additional Form' cannot be blank. Should state 'None' if not applicable.");
                } else {
                    const validAdditionalForms = ['1007', '216', 'rental', 'str', 'none'];
                    if (!validAdditionalForms.some(type => additionalForm.toLowerCase().includes(type))) {
                        addValidationMessage('error', `⚠️ Validation warning: 'Additional Form' ('${additionalForm}') is not a recognized type (e.g., 1007, 216, Rental, STR, None).`);
                    } else {
                        addValidationMessage('success', `✅ Validation successful: 'Additional Form' is '${additionalForm}'.`);
                    }
                }

                // Validation for ANSI Standard Confirmation
                if (ansiValue === 'did' || ansiValue === 'did not') {
                    addValidationMessage('success', `✅ Validation successful: 'ANSI Standard Confirmation' is correctly marked as '${ansiValue}'.`);
                } else {
                    addValidationMessage('error', `⚠️ Validation warning: 'ANSI Standard Confirmation' must be 'did' or 'did not'. It is currently '${ansiValue || 'blank'}'.`);
                }

                // Validation for Reasonable Exposure Time Comment
                if (exposureCommentValue && exposureCommentValue !== '--' && exposureCommentValue !== 'null') {
                    addValidationMessage('success', `✅ Validation successful: 'Reasonable Exposure Time Comment' is present.`);
                } else {
                    addValidationMessage('error', `⚠️ Validation warning: 'Reasonable Exposure Time Comment' cannot be blank.`);
                }

                // Validation for Prior Service Certification
                if (priorServiceValue === 'have' || priorServiceValue === 'have not') {
                    addValidationMessage('success', `✅ Validation successful: 'Prior Service Certification' is correctly marked as '${priorServiceValue}'.`);
                } else {
                    addValidationMessage('error', `⚠️ Validation warning: 'Prior Service Certification' must be 'have' or 'have not'. It is currently '${priorServiceValue || 'blank'}'.`);
                }
                {% endif %}
                {% if section_key == 'contract' %}
                // Validation for 'Refinance Transaction' requiring a blank 'Contract' section
                if (sessionStorage.getItem('isRefinanceTransaction') === 'true') {
                    let allFieldsBlank = true;
                    const nonEmptyFields = [];

                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        const valueCell = row.querySelector('td:last-child');
                        const value = valueCell.textContent.trim();

                        if (value && value !== '--' && value !== 'null') {
                            allFieldsBlank = false;
                            nonEmptyFields.push(fieldCell.textContent.trim());
                        }
                    });

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    if (allFieldsBlank) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation successful: Contract section is blank as required for a Refinance Transaction.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: For a Refinance Transaction, the Contract section should be blank. The following fields have values: ${nonEmptyFields.join(', ')}.`;
                    }
                    validationContainer.appendChild(messageDiv);
                }
                // Validation for contract analysis based on 'isPurchaseTransaction' flag
                if (sessionStorage.getItem('isPurchaseTransaction') === 'true') {
                    const contractAnalysisField = 'I _____ analyze the contract for sale for the subject purchase transaction.';
                    let analysisValue = null;

                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        if (fieldCell && fieldCell.textContent.trim().startsWith(contractAnalysisField)) {
                            const valueCell = row.querySelector('td:last-child');
                            analysisValue = valueCell.textContent.trim();
                        }
                    });

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    if (analysisValue && analysisValue.toLowerCase() === 'did') {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation successful: Contract analysis is marked as "did", which is required for a Purchase Transaction.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation warning: For a Purchase Transaction, the contract analysis must be "did", not "did not". The current value is not valid.';
                    }
                    validationContainer.appendChild(messageDiv);

                    // New validation: Check if all fields are filled for a Purchase Transaction
                    const missingFields = [];
                    let financialAssistanceValue = null;

                    // First pass to get the value of the financial assistance question
                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        const valueCell = row.querySelector('td:last-child');
                        if (fieldCell && valueCell) {
                            const fieldName = fieldCell.textContent.trim();
                            if (fieldName.includes('Is there any financial assistance')) {
                                financialAssistanceValue = valueCell.textContent.trim().toLowerCase();
                            }
                        }
                    });

                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        const valueCell = row.querySelector('td:last-child');
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();
                        const isFinancialAssistanceDetailsField = fieldName.includes('If Yes, report the total dollar amount');

                        // The details field is only required if financial assistance is 'yes'.
                        if (isFinancialAssistanceDetailsField && financialAssistanceValue !== 'yes') {
                            // Skip this field, it's not required to be filled.
                        } else if (!value || value === '--' || value === 'null') {
                            missingFields.push(fieldCell.textContent.trim());
                        }
                    });

                    const allFieldsMessageDiv = document.createElement('div');
                    allFieldsMessageDiv.classList.add('validation-message');
                    if (missingFields.length > 0) {
                        allFieldsMessageDiv.classList.add('validation-error');
                        allFieldsMessageDiv.textContent = `⚠️ Validation warning: For a Purchase Transaction, all Contract fields must be filled. The following fields are empty: ${missingFields.join(', ')}.`;
                    } else {
                        allFieldsMessageDiv.classList.add('validation-success');
                        allFieldsMessageDiv.textContent = '✅ Validation successful: All fields in the Contract section are filled as required for a Purchase Transaction.';
                    }
                    validationContainer.appendChild(allFieldsMessageDiv);
                }

                // New validation: If contract analysis is 'did', all fields must be filled.
                if (sessionStorage.getItem('isPurchaseTransaction') !== 'true') { // Only run if not already covered by purchase validation
                    const contractAnalysisField = 'I _____ analyze the contract for sale for the subject purchase transaction.';
                    let analysisValue = null;
                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        if (fieldCell && fieldCell.textContent.trim().startsWith(contractAnalysisField)) {
                            const valueCell = row.querySelector('td:last-child');
                            analysisValue = valueCell.textContent.trim().toLowerCase();
                        }
                    });

                    if (analysisValue && analysisValue === 'did') {
                        const missingFields = [];
                        tableRows.forEach(row => {
                            const fieldCell = row.querySelector('td:first-child');
                            const valueCell = row.querySelector('td:last-child');
                            const value = valueCell.textContent.trim();

                            if (!value || value === '--' || value === 'null') {
                                missingFields.push(fieldCell.textContent.trim());
                            }
                        });

                        if (missingFields.length > 0) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Since contract analysis was performed ('did'), all fields in this section must be filled. The following are empty: ${missingFields.join(', ')}.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                }
                // New validation for financial assistance
                let financialAssistanceValue = ''; // Initialize to empty string
                let financialAssistanceDetailsValue = null;
                const financialAssistanceField = 'Is there any financial assistance (loan charges, sale concessions, gift or downpay i etc.) to be paid by any party on behalf of the borrower?(Yes/No)';
                const financialAssistanceDetailsField = 'If Yes, report the total dollar amount and describe the items to be paid.';

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();

                        if (fieldName.includes('Is there any financial assistance')) { // Use includes for robustness
                            financialAssistanceValue = value.toLowerCase();
                        }
                        if (fieldName.includes('If Yes, report the total dollar amount')) { // Use includes for robustness
                            financialAssistanceDetailsValue = value;
                        }
                    }
                });

                // Helper to check if a value is effectively empty
                const isEmpty = (val) => !val || val === '--' || val === 'null';

                if (financialAssistanceValue === 'yes') {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    if (isEmpty(financialAssistanceDetailsValue)) {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: Financial assistance is marked 'Yes', but the description of the dollar amount and items is missing.`;
                    } else {
                        // Check for presence of a dollar amount (e.g., $1,234.56 or 1234.56)
                        const hasDollarAmount = /\$\s*\d{1,3}(?:,\d{3})*(?:\.\d{2})?|\d{1,3}(?:,\d{3})*(?:\.\d{2})?/.test(financialAssistanceDetailsValue);
                        // Check for some descriptive text (more than just a number or simple symbol)
                        // This regex checks for at least 5 non-numeric/non-symbol characters
                        const hasDescription = financialAssistanceDetailsValue.replace(/[\d\s$,.\-]/g, '').length > 5;

                        if (hasDollarAmount && hasDescription) {
                            messageDiv.classList.add('validation-success');
                            messageDiv.textContent = `✅ Validation successful: Financial assistance is marked 'Yes' and the details field contains both a dollar amount and a description.`;
                        } else if (!hasDollarAmount && !hasDescription) {
                            messageDiv.classList.add('validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Financial assistance is marked 'Yes', but the details field appears to be missing both a dollar amount and a description of items.`;
                        } else if (!hasDollarAmount) {
                            messageDiv.classList.add('validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Financial assistance is marked 'Yes', but the details field appears to be missing a dollar amount.`;
                        } else { // !hasDescription
                            messageDiv.classList.add('validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Financial assistance is marked 'Yes', but the details field appears to be missing a description of items.`;
                        }
                    }
                    validationContainer.appendChild(messageDiv);
                } else if (financialAssistanceValue === 'no') {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    // Allow "$0;;" as a valid "empty" value when assistance is 'No'.
                    if (!isEmpty(financialAssistanceDetailsValue) && financialAssistanceDetailsValue !== '$0;;') {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: Financial assistance is marked 'No', but the details field contains information. It should be blank.`;
                    } else {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: Financial assistance is marked 'No' and the details field is blank.`;
                    }
                    validationContainer.appendChild(messageDiv);
                } else { // financialAssistanceValue is blank or invalid
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation warning: 'Is there any financial assistance...' field must be marked 'Yes' or 'No'. It is currently blank.`;
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}
                
                {% if section_key == 'neighborhood' %}
                // Validation for Neighborhood section percentages
                const fieldsToSum = ['One-Unit', '2-4 Unit', 'Multi-Family', 'Commercial', 'Other'];
                let totalPercentage = 0;
                let fieldsFoundCount = 0;

                const missingFields = [];
                let otherPercentage = 0;
                let otherDescription = null;

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');

                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const valueText = valueCell.textContent.trim();

                        // Check if any field is empty, but exclude 'Present Land Use Other Description' for now
                        if (fieldName !== 'Present Land Use Other Description') {
                            if (!valueText || valueText === '--' || valueText === 'null') {
                                missingFields.push(fieldName);
                            }
                        }

                        if (fieldName === 'Other') {
                            const numericValue = parseFloat(valueText);
                            if (!isNaN(numericValue)) {
                                otherPercentage = numericValue;
                            }
                        } else if (fieldName === 'Present Land Use Other Description') {
                            otherDescription = valueText;
                        }

                        if (fieldsToSum.includes(fieldName)) {
                            fieldsFoundCount++;
                            const valueText = valueCell.textContent.trim();
                            // Use parseFloat which ignores trailing non-numeric characters like '%'
                            const numericValue = parseFloat(valueText);
                            if (!isNaN(numericValue)) {
                                totalPercentage += numericValue;
                            }
                        }
                    }
                });

                if (fieldsFoundCount > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    const isTotal100 = Math.abs(totalPercentage - 100) < 0.01;
                    const isOtherDescriptionMissing = !otherDescription || otherDescription === '--' || otherDescription === 'null' || otherDescription === '';

                    if (isTotal100) {
                        if (otherPercentage > 0 && isOtherDescriptionMissing) {
                            // Special case: Total is 100% but 'Other' has a value and needs a description.
                            messageDiv.classList.add('validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: The sum is 100%, but 'Other' is ${otherPercentage}% and its description is missing. Please provide a comment.`;
                        } else {
                            messageDiv.classList.add('validation-success');
                            messageDiv.textContent = `✅ Validation successful: The sum of housing unit types is ${totalPercentage}%.`;
                        }
                    } else if (fieldsFoundCount === 0) {
                        // Do nothing if no percentage fields were found
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: The sum of housing unit types is ${totalPercentage}%, which is not 100%.`;
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Conditionally check if 'Present Land Use Other Description' is required
                const isOtherDescriptionMissing = !otherDescription || otherDescription === '--' || otherDescription === 'null' || otherDescription === '';
                if (otherPercentage > 0 && isOtherDescriptionMissing) {
                    missingFields.push('Present Land Use Other Description');
                }

                // Display message for any missing fields in the section
                if (missingFields.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation warning: The following required fields are empty: ${missingFields.join(', ')}.`;
                    validationContainer.appendChild(messageDiv);
                }

                // Specific validation for Neighborhood Boundaries
                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'Neighborhood Boundaries') {
                        const valueCell = row.querySelector('td:last-child');
                        const valueText = valueCell.textContent.trim().toLowerCase();
                        
                        const missingDirections = [];
                        if (!valueText.includes('north')) missingDirections.push('North');
                        if (!valueText.includes('south')) missingDirections.push('South');
                        if (!valueText.includes('east')) missingDirections.push('East');
                        if (!valueText.includes('west')) missingDirections.push('West');

                        if (valueText && missingDirections.length > 0) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-error');
                            messageDiv.textContent = `⚠️ Validation error: The 'Neighborhood Boundaries' description is missing directional words: ${missingDirections.join(', ')}. Please ensure it is sufficiently detailed (e.g., "North: Main St, South: Oak Ave, East: RR Tracks, West: City Park").`;
                            validationContainer.appendChild(messageDiv);
                        } else if (valueText && valueText.length > 0 && valueText.length < 50) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-warning');
                            messageDiv.textContent = `⚠️ Validation warning: The 'Neighborhood Boundaries' description seems short. Please ensure it is sufficiently detailed.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                });
                {% endif %}

                {% if section_key == 'neighborhood' %}
                // Validation for 'Other' land use description (standalone check)
                let otherPercentageStandalone = 0;
                let otherDescriptionStandalone = null;

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');

                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const valueText = valueCell.textContent.trim();

                        if (fieldName === 'Other') {
                            const numericValue = parseFloat(valueText);
                            if (!isNaN(numericValue)) {
                                otherPercentageStandalone = numericValue;
                            }
                        } else if (fieldName === 'Present Land Use Other Description') {
                            otherDescriptionStandalone = valueText;
                        }
                    }
                });

                if (otherPercentageStandalone > 0) {
                    const isDescriptionMissing = !otherDescriptionStandalone || otherDescriptionStandalone === '--' || otherDescriptionStandalone === 'null' || otherDescriptionStandalone === '';
                    // This message only shows if the main percentage sum validation didn't already cover it.
                    // We check if a similar message already exists.
                    const existingWarning = validationContainer.querySelector('.validation-error');
                    if (isDescriptionMissing && !existingWarning) {
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('validation-message', 'validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: The 'Other' land use is ${otherPercentageStandalone}%, but the description (e.g., 'vacant land', 'garden') is missing.`;
                        validationContainer.appendChild(messageDiv);
                    } else if (!isDescriptionMissing) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: The 'Other' land use is ${otherPercentageStandalone}% and a description is provided.`;
                        validationContainer.appendChild(messageDiv);
                    }
                }
                {% endif %}

                {% if section_key == 'site' %}
                // --- Comprehensive Site Section Validation ---
                const requiredFields = ['Dimensions', 'Area', 'Shape', 'View', 'Specific Zoning Classification', 'Zoning Description'];
                const missingRequiredFields = [];

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();
                        const valueLower = value.toLowerCase();

                        // 1. Check for blank required fields
                        if (requiredFields.includes(fieldName) && (!value || value === '--' || value === 'null')) {
                            missingRequiredFields.push(fieldName);
                        }

                        // 2. Area validation
                        if (fieldName === 'Area' && value) {
                            const areaValue = parseFloat(value.replace(/,/g, ''));
                            if (!isNaN(areaValue) && areaValue > 43500) {
                                if (!valueLower.includes('ac')) { // Check for 'ac' or 'acres'
                                    const messageDiv = document.createElement('div');
                                    messageDiv.classList.add('validation-message', 'validation-error');
                                    messageDiv.textContent = `⚠️ Validation warning: Area is greater than 43,500 sq ft. The unit should be in Acres (AC). Current value: ${value}.`;
                                    validationContainer.appendChild(messageDiv);
                                }
                            }
                        }

                        // 3. Zoning Description validation
                        if (fieldName === 'Zoning Description' && valueLower.includes('agr')) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'error');
                            messageDiv.innerHTML = `<strong>⚠️ CRITICAL WARNING: Zoning Description contains 'Agriculture'/'agr'. This is not acceptable.</strong>`;
                            validationContainer.appendChild(messageDiv);
                        }
                        
                        // 4. Zoning Compliance validation
                        if (fieldName === 'Zoning Compliance') {
                            const complianceValue = value;
                            const commentRow = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.trim() === 'Zoning Compliance Comment');
                            const commentValue = commentRow ? commentRow.querySelector('td:last-child')?.textContent.trim() : null;
                            const isCommentEmpty = !commentValue || commentValue === '--' || commentValue === 'null';

                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message');

                            if (complianceValue === 'Legal') {
                                messageDiv.classList.add('validation-success');
                                messageDiv.textContent = '✅ Zoning Compliance is "Legal".';
                            } else if (['Legal Nonconforming', 'No Zoning'].includes(complianceValue)) {
                                if (isCommentEmpty) {
                                    messageDiv.classList.add('validation-warning');
                                    messageDiv.textContent = `⚠️ Warning: Zoning Compliance is "${complianceValue}". Please ensure a comment/explanation is provided in the report.`;
                                } else {
                                    messageDiv.classList.add('validation-success');
                                    messageDiv.textContent = `✅ Zoning Compliance is "${complianceValue}" and a comment has been provided.`;
                                }
                            } else if (complianceValue === 'Illegal') {
                                messageDiv.classList.add('error');
                                messageDiv.innerHTML = `<strong>⚠️ CRITICAL WARNING: Zoning Compliance is "Illegal". Please stop review and freeze further modules.</strong>`;
                                document.querySelectorAll('.sidebar a:not(.active)').forEach(link => {
                                    link.style.pointerEvents = 'none';
                                    link.style.opacity = '0.5';
                                    link.title = 'Navigation disabled due to critical error.';
                                });
                            }
                            validationContainer.appendChild(messageDiv);
                        }

                        // 5. Highest and Best Use validation
                        if (fieldName === 'Is the highest and best use of subject property as improved (or as proposed per plans and specifications) the present use?') {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message');
                            if (valueLower === 'yes') {
                                messageDiv.classList.add('validation-success');
                                messageDiv.textContent = `✅ Validation successful: Highest and Best Use is 'Yes'.`;
                            } else if (valueLower === 'no') {
                                messageDiv.classList.add('error');
                                messageDiv.innerHTML = `<strong>⚠️ CRITICAL WARNING: Highest and Best Use is 'No'. This is not acceptable.</strong>`;
                            } else {
                                messageDiv.classList.add('validation-error');
                                messageDiv.textContent = `⚠️ Validation error: Highest and Best Use must be marked 'Yes' or 'No'. It is currently blank.`;
                            }
                            validationContainer.appendChild(messageDiv);
                        }

                        // 6. Utilities validation
                        const standardUtilityFields = ['Electricity', 'Gas', 'Water', 'Sanitary Sewer'];
                        const streetAlleyFields = ['Street', 'Alley'];

                        if (standardUtilityFields.includes(fieldName)) {
                            if (valueLower.includes('public') && valueLower.includes('private')) {
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('validation-message', 'validation-error');
                                messageDiv.textContent = `⚠️ Validation warning: Utility '${fieldName}' cannot be both Public and Private.`;
                                validationContainer.appendChild(messageDiv);
                            } else if ((valueLower.includes('private') || valueLower.includes('other')) && value.split(/[\s/]/).length < 2) {
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('validation-message', 'validation-error');
                                messageDiv.textContent = `⚠️ Validation warning: Utility '${fieldName}' is marked 'Private' or 'Other' but is missing a required comment (e.g., 'Private-Well').`;
                                validationContainer.appendChild(messageDiv);
                            } else if (!value || value === '--' || value === 'null') {
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('validation-message', 'validation-error');
                                messageDiv.textContent = `⚠️ Validation warning: Utility '${fieldName}' is blank. A selection (e.g., Public, Private, None) is required.`;
                                validationContainer.appendChild(messageDiv);
                            }
                        } else if (streetAlleyFields.includes(fieldName)) {
                            const validPrefixes = ['public', 'private'];
                            let isCorrectPrefix = false;
                            for (const prefix of validPrefixes) {
                                if (valueLower.startsWith(prefix)) {
                                    isCorrectPrefix = true;
                                    break;
                                }
                            }

                            if (!value || value === '--' || value === 'null') {
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('validation-message', 'validation-error');
                                messageDiv.textContent = `⚠️ Validation warning: '${fieldName}' is blank. It must be 'Public' or 'Private'.`;
                            } else if (!isCorrectPrefix && valueLower !== 'none') {
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('validation-message', 'validation-error');
                                messageDiv.textContent = `⚠️ Validation warning: '${fieldName}' must start with 'Public' or 'Private' (e.g., 'Public/Asphalt', 'Private/Dirt'). Current value: '${value}'.`;
                                validationContainer.appendChild(messageDiv);
                            }
                        }

                        // 7. Utilities/Off-site improvements typical for market area
                        if (fieldName === 'Are the utilities and off-site improvements typical for the market area?') {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message');
                            if (valueLower === 'yes') {
                                messageDiv.classList.add('validation-success');
                                messageDiv.textContent = `✅ Validation successful: Utilities and off-site improvements are typical for the market area.`;
                            } else if (valueLower === 'no') {
                                messageDiv.classList.add('validation-warning');
                                messageDiv.textContent = `⚠️ Warning: Utilities/improvements are marked 'No' (not typical). Please verify an explanation is provided in the report.`;
                            } else {
                                messageDiv.classList.add('validation-error');
                                messageDiv.textContent = `⚠️ Validation error: 'Utilities typical for market area' must be marked 'Yes' or 'No'. It is currently blank.`;
                            }
                            validationContainer.appendChild(messageDiv);
                        }

                        // 8. Adverse site conditions
                        if (fieldName === 'Are there any adverse site conditions or external factors (easements, encroachments, environmental conditions, land uses, etc.)(Yes/No)?') {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message');
                            if (valueLower === 'no') {
                                messageDiv.classList.add('validation-success');
                                messageDiv.textContent = `✅ Validation successful: No adverse site conditions reported.`;
                            } else if (valueLower === 'yes') {
                                messageDiv.classList.add('validation-warning');
                                messageDiv.textContent = `⚠️ Warning: Adverse site conditions are marked 'Yes'. Please verify the description is provided and acceptable.`;
                            } else {
                                messageDiv.classList.add('validation-error');
                                messageDiv.textContent = `⚠️ Validation error: 'Adverse site conditions' must be marked 'Yes' or 'No'. It is currently blank.`;
                            }
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                });

                // Display message for any missing required fields
                if (missingRequiredFields.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation error: The following required fields are empty: ${missingRequiredFields.join(', ')}.`;
                    validationContainer.appendChild(messageDiv);
                }

                // --- Existing Validations (FEMA, ADU, etc.) ---
                let femaHazardAreaValue = null;
                let femaFloodZoneValue = null;

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();

                        if (fieldName === 'FEMA Special Flood Hazard Area') {
                            femaHazardAreaValue = value.toLowerCase();
                        }
                        if (fieldName === 'FEMA Flood Zone') {
                            femaFloodZoneValue = value.toUpperCase();
                        }
                        if (fieldName === 'Type' && value.toLowerCase().includes('one with accessory unit')) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-warning');
                            messageDiv.textContent = `ℹ️ Info: 'One with Accessory Unit' is selected. Please verify that the ADU description is provided in the sales grid, photos, building sketch, and floor plan.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                });
                
                if (femaHazardAreaValue && femaFloodZoneValue) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    let isValid = false;

                    if (femaHazardAreaValue === 'yes' && (femaFloodZoneValue === 'A' || femaFloodZoneValue === 'AE')) {
                        isValid = true; 
                    } else if (femaHazardAreaValue === 'no' && (femaFloodZoneValue === 'X' || femaFloodZoneValue === 'X500')) {
                        isValid = true;
                    }

                    if (isValid) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: FEMA Flood Zone '${femaFloodZoneValue}' is consistent with Special Flood Hazard Area being '${femaHazardAreaValue}'.`;
                    } else { 
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: FEMA Flood Zone '${femaFloodZoneValue}' is inconsistent. It should be 'A' or 'AE' if Hazard Area is 'Yes', or 'X' or 'X500' if Hazard Area is 'No'.`;
                    }
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}
                {% if section_key == 'improvements' %}
                // Validation for required Improvements fields
                // --- Clear session storage for cross-page validation ---
                sessionStorage.removeItem('improvementStatus');

                // --- Helper function to get a field's value ---
                const getFieldValue = (fieldName) => {
                    const row = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                // --- Helper function to add validation messages ---
                const addValidationMessage = (type, message) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', `validation-${type}`);
                    messageDiv.innerHTML = message; // Use innerHTML to allow for bold tags
                    validationContainer.appendChild(messageDiv);
                };

                // --- General Description Validation ---
                const unitValue = getFieldValue('Units');
                if (!unitValue || unitValue === '--' || unitValue === 'null') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Units' field should not be blank.");
                }

                const typeValue = getFieldValue('Type');
                if (typeValue && typeValue.toLowerCase().includes('one with accessory unit')) {
                    addValidationMessage('warning', "ℹ️ Info: 'One with Accessory Unit' is selected. Please verify that the ADU is described and shown in the sales grid, photos, and building sketch.");
                }
                if (!typeValue || typeValue === '--' || typeValue === 'null') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Type' field should not be blank. One option must be selected.");
                }

                const storiesValue = getFieldValue('# of Stories');
                if (!storiesValue || storiesValue === '--' || storiesValue === 'null' || parseFloat(storiesValue) === 0) {
                    addValidationMessage('error', "⚠️ Validation warning: '# of Stories' must be a non-zero number and cannot be blank.");
                }

                const statusValue = getFieldValue('Existing/Proposed/Under Const.');
                if (statusValue) {
                    const statuses = statusValue.split(/[/,]/).map(s => s.trim()).filter(Boolean);
                    if (statuses.length > 1) {
                        addValidationMessage('error', "⚠️ Validation warning: Only one option should be selected for 'Existing/Proposed/Under Const.'.");
                    } else if (statuses.length === 1) {
                        sessionStorage.setItem('improvementStatus', statuses[0].toLowerCase());
                        addValidationMessage('warning', `ℹ️ Info: Improvement status is '${statuses[0]}'. This will be checked against the 'Reconciliation' section.`);
                    }
                } else {
                    addValidationMessage('error', "⚠️ Validation warning: 'Existing/Proposed/Under Const.' cannot be blank.");
                }

                const designValue = getFieldValue('Design (Style)');
                if (!designValue || designValue === '--' || designValue === 'null' || designValue === '0') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Design (Style)' cannot be blank or zero.");
                }

                if (!getFieldValue('Year Built')) addValidationMessage('error', "⚠️ Validation warning: 'Year Built' cannot be blank.");
                if (!getFieldValue('Effective Age (Yrs)')) addValidationMessage('error', "⚠️ Validation warning: 'Effective Age (Yrs)' cannot be blank.");

                // --- Foundation Validation (Updated based on user request) ---
                const foundationTypeValue = getFieldValue('Foundation Type');
                const basementAreaValue = getFieldValue('Basement Area sq.ft.');
                const basementFinishValue = getFieldValue('Basement Finish');

                // Helper to check if a value is effectively zero or empty
                const isEffectivelyZero = (value) => {
                    if (value === null || value === '' || value === '--' || value === 'null') return true;
                    const num = parseFloat(value);
                    return !isNaN(num) && num === 0;
                };

                // Helper to check if a value is effectively greater than zero or non-empty
                const isEffectivelyGreaterThanZero = (value) => {
                    if (value === null || value === '' || value === '--' || value === 'null') return false;
                    const num = parseFloat(value);
                    if (!isNaN(num)) return num > 0;
                    // If it's not a number, assume it's descriptive text, and non-empty means > 0 equivalent
                    return value.trim().length > 0;
                };

                if (foundationTypeValue) {
                    if (foundationTypeValue.includes('Concrete Slab') && foundationTypeValue.includes('Crawl Space')) {
                        addValidationMessage('error', "⚠️ Validation warning: Foundation Type cannot be both 'Concrete Slab' and 'Crawl Space'.");
                    }
                    if (foundationTypeValue.includes('Full Basement') && foundationTypeValue.includes('Partial Basement')) {
                        addValidationMessage('error', "⚠️ Validation warning: Foundation Type cannot be both 'Full Basement' and 'Partial Basement'.");
                    }

                    // User's requested logic:
                    if (foundationTypeValue.toLowerCase().includes('concrete slab') || foundationTypeValue.toLowerCase().includes('crawl space')) {
                        // If Foundation Type is Concrete Slab/Crawl Space, Basement Area and Finish should be 0
                        if (!isEffectivelyZero(basementAreaValue)) {
                            addValidationMessage('error', `⚠️ Validation warning: Foundation Type is '${foundationTypeValue}'. 'Basement Area sq.ft.' should be 0, but is '${basementAreaValue}'.`);
                        }
                        if (!isEffectivelyZero(basementFinishValue)) {
                            addValidationMessage('error', `⚠️ Validation warning: Foundation Type is '${foundationTypeValue}'. 'Basement Finish' should be 0, but is '${basementFinishValue}'.`);
                        }
                    } else {
                        // Otherwise (any other foundation type), Basement Area and Finish should be > 0
                        if (!isEffectivelyGreaterThanZero(basementAreaValue)) {
                            addValidationMessage('error', `⚠️ Validation warning: Foundation Type is '${foundationTypeValue}'. 'Basement Area sq.ft.' should be greater than 0, but is '${basementAreaValue}'.`);
                        }
                        if (!isEffectivelyGreaterThanZero(basementFinishValue)) {
                            addValidationMessage('error', `⚠️ Validation warning: Foundation Type is '${foundationTypeValue}'. 'Basement Finish' should be greater than 0, but is '${basementFinishValue}'.`);
                        }
                    }
                }

                const evidenceValue = getFieldValue('Evidence of');
                if (evidenceValue && evidenceValue.toLowerCase() !== 'none' && evidenceValue.toLowerCase() !== 'n/a' && evidenceValue.trim() !== '') {
                    addValidationMessage('error', `⚠️ Validation warning: 'Evidence of' should be unchecked (None). It is currently marked as '${evidenceValue}'. Please verify with basement photos.`);
                }

                // --- Material/Condition Validation (Exterior & Interior) ---
                const materialConditionFields = [
                    'Exterior Walls (Material/Condition)', 'Roof Surface (Material/Condition)', 'Gutters & Downspouts (Material/Condition)',
                    'Window Type (Material/Condition)', 'Floors (Material/Condition)', 'Walls (Material/Condition)', 'Trim/Finish (Material/Condition)',
                    'Bath Floor (Material/Condition)', 'Bath Wainscot (Material/Condition)'
                ];
                const validLongConditions = ['good', 'average', 'poor', 'fair'];
                const validShortConditions = ['a', 'a+', 'b', 'b+', 'c', 'c+', 'd', 'd+', 'avg', 'ag', 'gd', 'pr', 'fr'];
                const allValidConditions = [...validLongConditions, ...validShortConditions];
                materialConditionFields.forEach(field => {
                    const interiorFields = ['Floors (Material/Condition)', 'Walls (Material/Condition)', 'Trim/Finish (Material/Condition)'];
                    const value = getFieldValue(field);
                    if (!value || value === '--' || value === 'null') {
                        addValidationMessage('error', `⚠️ Validation warning: '${field}' cannot be blank.`);
                    } else if (!value.includes('/')) {
                        addValidationMessage('error', `⚠️ Validation warning: '${field}' is missing either Material or Condition. It should be in 'Material/Condition' format.`);
                    } else {
                        const parts = value.split('/');
                        let condition;
                        // For interior fields, the condition is the last part, even with multiple slashes (e.g., Material/Finish/Condition)
                        if (interiorFields.includes(field)) {
                            condition = parts[parts.length - 1]?.trim().toLowerCase();
                        } else {
                            condition = parts[1]?.trim().toLowerCase();
                        }

                        if (!condition || !allValidConditions.includes(condition)) {
                             addValidationMessage('error', `⚠️ Validation warning: The condition for '${field}' ('${parts[1]?.trim()}') is not valid. It must be one of: Good, Average, Poor, Fair, or a short form like A, B+, C, avg, gd, pr, fr.`);
                        }
                    }
                });

                // --- Attic, Heating, Cooling ---
                const atticValue = getFieldValue('Attic');
                if (atticValue && !atticValue.toLowerCase().includes('none')) {
                    addValidationMessage('warning', `ℹ️ Info: 'Attic' is marked as '${atticValue}'. Please verify photos and sketch.`);
                }

                const heatingValue = getFieldValue('Heating Type');
                if (heatingValue && heatingValue.toLowerCase().includes('other') && heatingValue.split(/[\s/]/).length < 2) {
                    addValidationMessage('error', "⚠️ Validation warning: 'Heating Type' is marked 'Other' but is missing a description.");
                }

                const fuelValue = getFieldValue('Fuel');
                if (fuelValue && fuelValue !== '--' && fuelValue !== 'null') {
                    const validFuels = ['gas', 'oil', 'electric'];
                    // Split by common delimiters like slash, comma, or space
                    const fuelParts = fuelValue.toLowerCase().split(/[\s,\/]+/);
                    
                    // Check if every part is a valid fuel type
                    const allPartsValid = fuelParts.every(part => validFuels.includes(part.trim()));

                    if (!allPartsValid) {
                        addValidationMessage('warning', `⚠️ Validation warning: 'Fuel' is '${fuelValue}'. It contains an atypical type. It should typically be a combination of 'Gas', 'Oil', or 'Electric'. Please verify.`);
                    }
                }

                const coolingValue = getFieldValue('Cooling Type');
                if (coolingValue && coolingValue.toLowerCase().includes('other') && coolingValue.split(/[\s/]/).length < 2) {
                    addValidationMessage('error', "⚠️ Validation warning: 'Cooling Type' is marked 'Other' but is missing a description.");
                }

                // --- Car Storage ---
                const hasValue = (field) => {
                    const value = getFieldValue(field);
                    // A field has a value if it's not null, not a placeholder, and not '0' (for numeric fields)
                    return value && value !== '--' && value !== 'null' && value !== '0';
                };

                const carStorageValue = getFieldValue('Car Storage');
                if (carStorageValue) {
                    const carStorageLower = carStorageValue.toLowerCase();
                    const drivewayFields = ['Driveway # of Cars', 'Driveway Surface'];
                    const garageFields = ['Garage # of Cars', 'Garage (Att./Det./Built-in)'];
                    const carportFields = ['Carport # of Cars'];

                    if (carStorageLower.includes('none')) {
                        // If 'None' is checked, all other car storage fields should be blank.
                        const allOtherFields = [...drivewayFields, ...garageFields, ...carportFields];
                        allOtherFields.forEach(field => {
                            if (hasValue(field)) {
                                addValidationMessage('error', `⚠️ Validation Mismatch: 'Car Storage' is marked 'None', but '${field}' has a value. It should be blank.`);
                            }
                        });
                    } else {
                        // If 'None' is NOT checked, validate the selected options.
                        // Check Driveway
                        if (carStorageLower.includes('driveway') && !hasValue('Driveway # of Cars')) {
                            addValidationMessage('error', "⚠️ Validation Mismatch: 'Car Storage' includes 'Driveway', but 'Driveway # of Cars' is blank or zero.");
                        } else if (!carStorageLower.includes('driveway') && (hasValue('Driveway # of Cars') || hasValue('Driveway Surface'))) {
                            addValidationMessage('error', "⚠️ Validation Mismatch: 'Driveway' is not selected in 'Car Storage', but its related fields have values.");
                        }

                        // Check Garage
                        if (carStorageLower.includes('garage')) {
                            if (!hasValue('Garage # of Cars')) {
                                addValidationMessage('error', "⚠️ Validation Mismatch: 'Car Storage' includes 'Garage', but 'Garage # of Cars' is blank or zero.");
                            }
                            if (!getFieldValue('Garage (Att./Det./Built-in)')) {
                                addValidationMessage('error', "⚠️ Validation Mismatch: 'Car Storage' includes 'Garage', but the type (Att./Det./Built-in) is not selected.");
                            }
                        } else if (!carStorageLower.includes('garage') && (hasValue('Garage # of Cars') || hasValue('Garage (Att./Det./Built-in)'))) {
                            addValidationMessage('error', "⚠️ Validation Mismatch: 'Garage' is not selected in 'Car Storage', but its related fields have values.");
                        }

                        // Check Carport
                        if (carStorageLower.includes('carport') && !hasValue('Carport # of Cars')) {
                            addValidationMessage('error', "⚠️ Validation Mismatch: 'Car Storage' includes 'Carport', but 'Carport # of Cars' is blank or zero.");
                        } else if (!carStorageLower.includes('carport') && hasValue('Carport # of Cars')) {
                            addValidationMessage('error', "⚠️ Validation Mismatch: 'Carport' is not selected in 'Car Storage', but 'Carport # of Cars' has a value.");
                        }
                    }
                }

                // --- Appliances ---
                const appliancesValue = getFieldValue('Appliances (Refrigerator,Range/Oven, Dishwasher, Disposal, Microwave, Washer/Dryer, Other (describe))');
                if (!appliancesValue || appliancesValue === '--' || appliancesValue === 'null') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Appliances' section should not be blank.");
                } else if (appliancesValue.toLowerCase().includes('other') && appliancesValue.split(/[\s,]/).length < 2) {
                     addValidationMessage('error', "⚠️ Validation warning: 'Appliances' is marked 'Other' but is missing a description.");
                }

                // --- Room Counts & GLA ---
                ['Finished area above grade Rooms', 'Finished area above grade Bedrooms', 'Finished area above grade Bath(s)', 'Square Feet of Gross Living Area Above Grade'].forEach(field => {
                    if (!getFieldValue(field)) {
                        addValidationMessage('error', `⚠️ Validation warning: '${field}' cannot be blank.`);
                    }
                });
                addValidationMessage('warning', "ℹ️ Info: Room counts and GLA will be used as a base for consistency checks in other sections.");

                // --- Additional Features & Condition ---
                const additionalFeatures = getFieldValue('Additional features');
                if (!additionalFeatures) { // Allows 'None' but not blank
                    addValidationMessage('error', "⚠️ Validation warning: 'Additional features' cannot be blank. Should state 'None' if not applicable.");
                }

                const conditionDesc = getFieldValue('Describe the condition of the property');
                if (!conditionDesc) {
                    addValidationMessage('error', "⚠️ Validation warning: 'Describe the condition of the property' cannot be blank.");
                } else {
                    const conditionCode = conditionDesc.match(/C[1-6]/);
                    if (!conditionCode) {
                        addValidationMessage('error', "⚠️ Validation warning: The property condition description must include a code from C1 to C6.");
                    } else if (conditionCode[0] === 'C5' || conditionCode[0] === 'C6') {
                        addValidationMessage('error', `<strong>⚠️ CRITICAL WARNING: Property condition is '${conditionCode[0]}'. This requires special attention.</strong>`);
                    }
                }

                // --- Physical Deficiencies & Neighborhood Conformity ---
                const physicalDeficiencies = getFieldValue('Are there any physical deficiencies or adverse conditions that affect the livability, soundness, or structural integrity of the property?');
                if (!physicalDeficiencies) {
                    addValidationMessage('error', "⚠️ Validation warning: 'Physical deficiencies' question cannot be blank.");
                } else if (physicalDeficiencies.toLowerCase() === 'yes') {
                    if (!getFieldValue('If Yes, describe')) {
                        addValidationMessage('error', "⚠️ Validation warning: 'Physical deficiencies' is 'Yes', but the description is missing.");
                    }
                } else if (physicalDeficiencies.toLowerCase() !== 'no') {
                     addValidationMessage('error', "⚠️ Validation warning: 'Physical deficiencies' should be marked 'Yes' or 'No'.");
                }

                const neighborhoodConformity = getFieldValue('Does the property generally conform to the neighborhood (functional utility, style, condition, use, construction, etc.)?');
                if (!neighborhoodConformity) {
                    addValidationMessage('error', "⚠️ Validation warning: 'Neighborhood conformity' question cannot be blank.");
                } else if (neighborhoodConformity.toLowerCase() === 'no') {
                    if (!getFieldValue('If No, describe')) {
                        addValidationMessage('error', "⚠️ Validation warning: 'Neighborhood conformity' is 'No', but the description is missing.");
                    }
                } else if (neighborhoodConformity.toLowerCase() !== 'yes') {
                    addValidationMessage('error', "⚠️ Validation warning: 'Neighborhood conformity' should be marked 'Yes' or 'No'.");
                }


                const requiredFields = [
                    'Units', // GENERAL DESCRIPTION
                    '# of Stories', // GENERAL DESCRIPTION
                    'Type', // GENERAL DESCRIPTION
                    'Existing/Proposed/Under Const.', // GENERAL DESCRIPTION
                    'Design (Style)', // GENERAL DESCRIPTION
                    'Year Built', // GENERAL DESCRIPTION
                    'Effective Age (Yrs)', // GENERAL DESCRIPTION
                    'Foundation Type', // Foundation section
                    'Foundation Walls (Material/Condition)', // Foundation section
                    'Basement Area sq.ft.', // Foundation section
                    'Basement Finish', // Foundation section
                    'Exterior Walls (Material/Condition)', //EXTERIOR DESCRIPTION
                    'Roof Surface (Material/Condition)', //EXTERIOR DESCRIPTION
                    'Gutters & Downspouts (Material/Condition)',
                    'Window Type (Material/Condition)',
                    'Floors (Material/Condition)',
                    'Walls (Material/Condition)',
                    'Trim/Finish (Material/Condition)',
                    'Bath Floor (Material/Condition)',
                    'Bath Wainscot (Material/Condition)',
                    'Describe the condition of the property',
                ];
                const missingFields = [];
                let physicalDeficienciesValue = null;
                let conformsToNeighborhoodValue = null;
                let foundationType = null;
                let basementArea = null;
                let basementFinish = null;

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');
                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();

                        // Check for conditional field triggers
                        if (fieldName === 'Are there any physical deficiencies or adverse conditions that affect the livability, soundness, or structural integrity of the property?') {
                            physicalDeficienciesValue = value.toLowerCase();
                        }
                        if (fieldName === 'Does the property generally conform to the neighborhood (functional utility, style, condition, use, construction, etc.)?') {
                            conformsToNeighborhoodValue = value.toLowerCase();
                        }

                        // Capture values for basement validation
                        if (fieldName === 'Foundation Type') {
                            foundationType = value;
                        }
                        if (fieldName === 'Basement Area sq.ft.') {
                            basementArea = value;
                        }
                        if (fieldName === 'Basement Finish') {
                            basementFinish = value;
                        }

                        // Check if a required field is empty
                        if (requiredFields.includes(fieldName) && (value === '--' || value === '')) {
                            missingFields.push(fieldName);
                        }
                    }
                });

                // Conditionally check the "If Yes, describe" field
                if (physicalDeficienciesValue === 'yes') {
                    const describeField = Array.from(tableRows).find(row => row.querySelector('td:first-child').textContent.trim() === 'If Yes, describe');
                    if (describeField) {
                        const describeValue = describeField.querySelector('td:last-child').textContent.trim();
                        if (!describeValue || describeValue === '--' || describeValue === 'null') {
                            missingFields.push('If Yes, describe (for physical deficiencies)');
                        }
                    }
                }

                // Conditionally check the "If No, describe" field
                if (conformsToNeighborhoodValue === 'no') {
                    const describeField = Array.from(tableRows).find(row => row.querySelector('td:first-child').textContent.trim() === 'If No, describe');
                    if (describeField) {
                        const describeValue = describeField.querySelector('td:last-child').textContent.trim();
                        if (!describeValue || describeValue === '--' || describeValue === 'null') {
                            missingFields.push('If No, describe (for neighborhood conformity)');
                        }
                    }
                }

                if (missingFields.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation warning: The following required fields are missing: ${missingFields.join(', ')}.`;
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}

                {% if section_key == 'sales_grid' %}
                // Store the 'Indicated Value by Sales Comparison Approach' for cross-validation
                // The structure is different for the sales grid, so we find the specific cell
                const lastRow = document.querySelector('tbody tr:last-child');
                if (lastRow) {
                    const fieldCell = lastRow.querySelector('td:first-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'Indicated Value by Sales Comparison Approach') {
                        const valueCell = lastRow.querySelector('td:last-child');
                        // The value is inside a <strong> tag
                        const salesGridValue = valueCell.querySelector('strong').textContent.trim();
                        sessionStorage.setItem('salesGridIndicatedValue', salesGridValue);

                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('validation-message', 'validation-warning');
                        messageDiv.textContent = `ℹ️ Info: Stored 'Indicated Value by Sales Comparison Approach' (${salesGridValue}) for validation in the Reconciliation section.`;
                        validationContainer.appendChild(messageDiv);
                    }
                }

                // Validation for Subject's View field in Sales Grid
                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'View') {
                        // In the sales grid, the second cell of the row is the Subject's value
                        const subjectValueCell = row.querySelector('td:nth-child(2)');
                        if (subjectValueCell && (subjectValueCell.textContent.trim() === '' || subjectValueCell.textContent.trim() === '--')) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-warning');
                            messageDiv.textContent = `⚠️ Warning: The 'View' field for the Subject is missing a description.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                });
                {% else %}
                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    if (fieldCell && fieldCell.textContent.trim() === 'Indicated Value by Sales Comparison Approach') {
                        const valueCell = row.querySelector('td:last-child');
                        const salesGridValue = valueCell.textContent.trim();
                        sessionStorage.setItem('salesGridIndicatedValue', salesGridValue);

                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('validation-message', 'validation-warning');
                        messageDiv.textContent = `ℹ️ Info: Stored 'Indicated Value by Sales Comparison Approach' (${salesGridValue}) for validation in the Reconciliation section.`;
                        validationContainer.appendChild(messageDiv);
                    }
                });
                {% endif %}

                {% if section_key == 'reconciliation' %}
                // Asynchronous validation for value consistency
                async function validateAppraisedValues() {
                    const salesGridValue = sessionStorage.getItem('salesGridIndicatedValue');
                    let reconciliationSalesApproachValue = null;
                    let finalMarketValue = null;

                    // Store Effective Date of Value for certification check
                    tableRows.forEach(row => {
                        const fieldName = row.querySelector('td:first-child')?.textContent.trim();
                        const value = row.querySelector('td:last-child')?.textContent.trim();
                        if (fieldName === 'Effective Date of Value') {
                            sessionStorage.setItem('reconciliationEffectiveDate', value);
                        }
                    });


                    // 1. Get values from the current (Reconciliation) section
                    tableRows.forEach(row => {
                        const fieldName = row.querySelector('td:first-child')?.textContent.trim();
                        const value = row.querySelector('td:last-child')?.textContent.trim();
                        if (fieldName === 'Indicated Value by: Sales Comparison Approach $') {
                            reconciliationSalesApproachValue = value;
                        } else if (fieldName === 'Opinion of Market Value $') {
                            finalMarketValue = value;
                        }
                    });

                    // 2. Fetch Certification data from the backend
                    let certificationAppraisedValue = null;
                    try {
                        const response = await fetch(`/api/data/{{ filename }}/certification/`);
                        const certData = await response.json();
                        if (certData && !certData.error) {
                            certificationAppraisedValue = certData['APPRAISED VALUE OF SUBJECT PROPERTY $'];
                        }
                    } catch (error) {
                        console.error('Error fetching certification data:', error);
                    }

                    // 3. Perform the validation
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    const values = {
                        'Indicated Value by Sales Comparison Approach (from Sales Grid)': salesGridValue,
                        'Indicated Value by: Sales Comparison Approach $ (from Reconciliation)': reconciliationSalesApproachValue,
                        'Opinion of Market Value $ (from Reconciliation)': finalMarketValue,
                        'APPRAISED VALUE OF SUBJECT PROPERTY $ (from Certification)': certificationAppraisedValue
                    };

                    const missing = Object.entries(values).filter(([key, val]) => !val || val === '--' || val === 'null').map(([key, val]) => `'${key}'`);

                    if (missing.length > 0) {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: One or more values for comparison are blank. Missing: ${missing.join(', ')}.`;
                    } else {
                        const normValues = Object.values(values).map(v => v.replace(/[$,]/g, ''));
                        const allMatch = normValues.every(v => v === normValues[0]);

                        if (allMatch) {
                            messageDiv.classList.add('validation-success');
                            messageDiv.textContent = `✅ Validation successful: All four appraised values match (${salesGridValue}).`;
                        } else {
                            messageDiv.classList.add('validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Appraised values do not match. Sales Grid: ${salesGridValue}, Reconciliation Sales: ${reconciliationSalesApproachValue}, Final Market Value: ${finalMarketValue}, Certification Value: ${certificationAppraisedValue}`;
                        }
                    }
                    validationContainer.appendChild(messageDiv);
                }
                // Run the async validation
                validateAppraisedValues();

                // --- Original Reconciliation Validations ---
                // Validation for Improvement Status vs. Reconciliation Status
                const improvementStatus = sessionStorage.getItem('improvementStatus'); // 'existing', 'proposed', etc.
                if (improvementStatus) {
                    let reconciliationAppraisalStatus = null;
                    const reconciliationStatusFieldIdentifier = "This appraisal is made";

                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        if (fieldCell && fieldCell.textContent.trim().startsWith(reconciliationStatusFieldIdentifier)) {
                            const valueCell = row.querySelector('td:last-child');
                            reconciliationAppraisalStatus = valueCell.textContent.trim().toLowerCase();
                        }
                    });

                    if (reconciliationAppraisalStatus) {
                        const statusMessageDiv = document.createElement('div');
                        statusMessageDiv.classList.add('validation-message');
                        let isConsistent = false;
                        let expectedReconStatus = '';

                        if (improvementStatus === 'existing' && reconciliationAppraisalStatus.includes('as is')) {
                            isConsistent = true;
                        } else if ((improvementStatus === 'proposed' || improvementStatus === 'under const.') && reconciliationAppraisalStatus.includes('subject to completion')) {
                            isConsistent = true;
                        }

                        if (isConsistent) {
                            statusMessageDiv.classList.add('validation-success');
                            statusMessageDiv.textContent = `✅ Validation successful: Improvement status '${improvementStatus}' is consistent with Reconciliation status '${reconciliationAppraisalStatus}'.`;
                        } else {
                            statusMessageDiv.classList.add('validation-error');
                            statusMessageDiv.textContent = `⚠️ Validation Mismatch: Improvement status is '${improvementStatus}'. The Reconciliation status should be '${improvementStatus === 'existing' ? 'as is' : 'subject to completion...'}', but it is '${reconciliationAppraisalStatus}'.`;
                        }
                        validationContainer.appendChild(statusMessageDiv);
                    }
                }
                {% endif %}

                // {% if section_key == 'cost_approach' %}
                // // Validation for required Cost Approach fields
                // const missingFields = [];
                // tableRows.forEach(row => {
                //     const fieldCell = row.querySelector('td:first-child');
                //     const valueCell = row.querySelector('td:last-child');
                //     const value = valueCell.textContent.trim();

                //     if (!value || value === '--' || value === 'null') {
                //         missingFields.push(fieldCell.textContent.trim());
                //     }
                // });

                // const messageDiv = document.createElement('div');
                // messageDiv.classList.add('validation-message');
                // if (missingFields.length > 0) {
                //     messageDiv.classList.add('validation-error');
                //     messageDiv.textContent = `⚠️ Validation warning: All Cost Approach fields should be filled. The following fields are empty: ${missingFields.join(', ')}.`;
                // } else {
                //     messageDiv.classList.add('validation-success');
                //     messageDiv.textContent = '✅ Validation successful: All fields in the Cost Approach section are filled.';
                // }
                // validationContainer.appendChild(messageDiv);
                // {% endif %}

                {% if section_key == 'certification' %}
                // --- Helper function to get a field's value ---
                const getFieldValue = (fieldName) => {
                    const row = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                // --- Helper function to add validation messages ---
                const addValidationMessage = (type, message) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', `validation-${type}`);
                    messageDiv.innerHTML = message; // Use innerHTML to allow for bold tags
                    validationContainer.appendChild(messageDiv);
                };

                // 1. Date of Signature vs. Effective Date of Appraisal
                const signatureDateStr = getFieldValue('Date of Signature and Report');
                const effectiveDateStr = getFieldValue('Effective Date of Appraisal');
                if (signatureDateStr && effectiveDateStr) {
                    const sigDate = new Date(signatureDateStr);
                    const effDate = new Date(effectiveDateStr);
                    if (!isNaN(sigDate.getTime()) && !isNaN(effDate.getTime())) {
                        if (sigDate > effDate) {
                            addValidationMessage('success', `✅ Validation successful: 'Date of Signature' (${signatureDateStr}) is after 'Effective Date of Appraisal' (${effectiveDateStr}).`);
                        } else {
                            addValidationMessage('error', `⚠️ Validation warning: 'Date of Signature' (${signatureDateStr}) must be greater than 'Effective Date of Appraisal' (${effectiveDateStr}).`);
                        }
                    } else {
                        addValidationMessage('error', "⚠️ Validation warning: Could not parse one or both dates for comparison.");
                    }
                }

                // 2. Effective Date of Appraisal vs. Reconciliation's "as of" date
                const reconciliationEffectiveDate = sessionStorage.getItem('reconciliationEffectiveDate');
                if (reconciliationEffectiveDate) {
                    if (effectiveDateStr === reconciliationEffectiveDate) {
                        addValidationMessage('success', `✅ Validation successful: 'Effective Date of Appraisal' (${effectiveDateStr}) matches the 'Effective Date of Value' from the Reconciliation section.`);
                    } else {
                        addValidationMessage('error', `⚠️ Validation warning: 'Effective Date of Appraisal' (${effectiveDateStr}) does not match the 'Effective Date of Value' from the Reconciliation section (${reconciliationEffectiveDate}).`);
                    }
                } else {
                    addValidationMessage('warning', "ℹ️ Info: Could not find 'Effective Date of Value' from Reconciliation section to compare. Please visit the Reconciliation section first.");
                }
                
                // 5. LENDER/CLIENT Name should always have "fastapp"
                const lenderClientName = getFieldValue('LENDER/CLIENT Name');
                if (lenderClientName) {
                    if (lenderClientName.toLowerCase().includes('fastapp')) {
                        addValidationMessage('success', "✅ Validation successful: 'LENDER/CLIENT Name' contains the word 'fastapp'.");
                    } else {
                        addValidationMessage('error', `⚠️ Validation warning: 'LENDER/CLIENT Name' ('${lenderClientName}') does not contain the word 'fastapp'.`);
                    }
                }


                // Validation for Lender/Client consistency
                const subjectState = sessionStorage.getItem('subjectState');
                
                const subjectLenderClient = sessionStorage.getItem('subjectLenderClient');
                if (subjectLenderClient) {
                    let certificationLenderClientCompanyName = null;
                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        const valueCell = row.querySelector('td:last-child');
                        if (fieldCell && valueCell && fieldCell.textContent.trim() === 'Lender/Client Company Name') {
                            certificationLenderClientCompanyName = valueCell.textContent.trim();
                        }
                    });

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');

                    if (!certificationLenderClientCompanyName || certificationLenderClientCompanyName === '--' || certificationLenderClientCompanyName === 'null') {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: 'Lender/Client Company Name' is missing in the Certification section. The Subject section lists 'Lender/Client' as '${subjectLenderClient}'.`;
                    } else if (subjectLenderClient.toLowerCase() === certificationLenderClientCompanyName.toLowerCase()) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: 'Lender/Client' ('${subjectLenderClient}') from Subject is consistent with 'Lender/Client Company Name' ('${certificationLenderClientCompanyName}') from Certification.`;
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: 'Lender/Client' from Subject ('${subjectLenderClient}') mismatches 'Lender/Client Company Name' from Certification ('${certificationLenderClientCompanyName}').`;
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // 6. Lender/Client Company Address vs. Subject section lender address
                const subjectLenderAddress = sessionStorage.getItem('subjectLenderAddress');
                const certificationLenderAddress = getFieldValue('Lender/Client Company Address');
                if (subjectLenderAddress) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    const normalize = (str) => str.replace(/,/g, '').replace(/\s+/g, ' ').trim().toLowerCase();
                    if (certificationLenderAddress && normalize(subjectLenderAddress) === normalize(certificationLenderAddress)) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = `✅ Validation successful: 'Lender/Client Company Address' in Certification matches the address from the Subject section.`;
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = `⚠️ Validation warning: Lender address mismatch. Subject section has '${subjectLenderAddress}', but Certification has '${certificationLenderAddress || 'a blank address'}'.`;
                    }
                    validationContainer.appendChild(messageDiv);
                } else {
                    addValidationMessage('warning', "ℹ️ Info: Could not find the lender address from the Subject section to compare. Please visit the Subject section first.");
                }

                // 4. ADDRESS OF PROPERTY APPRAISED vs. Subject Section Address
                const subjectFullAddress = sessionStorage.getItem('subjectFullAddress');
                const certificationAddress = getFieldValue('ADDRESS OF PROPERTY APPRAISED');
                if (subjectFullAddress) {
                    // Normalize by removing commas and extra spaces, and converting to lower case
                    const normalize = (str) => str ? str.replace(/,/g, '').replace(/\s+/g, ' ').trim().toLowerCase() : '';
                    if (certificationAddress && normalize(subjectFullAddress) === normalize(certificationAddress)) {
                        addValidationMessage('success', "✅ Validation successful: 'ADDRESS OF PROPERTY APPRAISED' matches the address from the Subject section.");
                    } else {
                        addValidationMessage('error', `⚠️ Validation warning: Address mismatch. Subject section has '${subjectFullAddress}', but Certification has '${certificationAddress || 'a blank address'}'.`);
                    }
                } else {
                    addValidationMessage('warning', "ℹ️ Info: Could not find the full address from the Subject section to compare. Please visit the Subject section first.");
                }
                {% endif %}

                {% if section_key == 'cost_approach' %}
                // --- Cost Approach vs. Reconciliation Validation ---
                async function validateCostApproachValue() {
                    // Find the specific cell for "Indicated Value By Cost Approach"
                    const costApproachRow = Array.from(document.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child strong')?.textContent.trim() === "Indicated Value By Cost Approach");
                    const costApproachValue = costApproachRow ? costApproachRow.querySelector('td:last-child strong')?.textContent.trim() : null;

                    // Helper function to add messages, defined earlier in the script
                    const addValidationMessage = (type, message) => { validationContainer.innerHTML += `<div class="validation-message validation-${type}">${message}</div>`; };

                    try {
                        const response = await fetch(`/api/data/{{ filename }}/reconciliation/`);
                        const reconData = await response.json();

                        if (reconData && !reconData.error) {
                            const reconValue = reconData["Cost Approach (if developed) $"];

                            const normalize = (val) => val ? String(val).replace(/[$,]/g, '').trim() : null;

                            const normCostApproach = normalize(costApproachValue);
                            const normRecon = normalize(reconValue);

                            if (normCostApproach && normRecon && normCostApproach === normRecon) {
                                addValidationMessage('success', `✅ Value matches Reconciliation: The 'Indicated Value By Cost Approach' (${costApproachValue}) is consistent with the 'Cost Approach (if developed) $' value in the Reconciliation section.`);
                            } else {
                                addValidationMessage('error', `⚠️ Value Mismatch: 'Indicated Value By Cost Approach' (${costApproachValue || 'N/A'}) does not match the 'Cost Approach (if developed) $' value (${reconValue || 'N/A'}) from the Reconciliation section.`);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching reconciliation data for validation:', error);
                    }
                }
                validateCostApproachValue();
                {% endif %}

                {% if section_key == 'income_approach' %}
                // --- Income Approach vs. Reconciliation Validation ---
                async function validateIncomeApproachValue() {
                    // Find the value for "Indicated Value by Income Approach" from the current table
                    const incomeApproachRow = Array.from(document.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === "Indicated Value by Income Approach");
                    const incomeApproachValue = incomeApproachRow ? incomeApproachRow.querySelector('td:last-child')?.textContent.trim() : null;

                    // Helper function to add messages
                    const addValidationMessage = (type, message) => { validationContainer.innerHTML += `<div class="validation-message validation-${type}">${message}</div>`; };

                    try {
                        const response = await fetch(`/api/data/{{ filename }}/reconciliation/`);
                        const reconData = await response.json();

                        if (reconData && !reconData.error) {
                            const reconValue = reconData["Income Approach (if developed) $"];

                            const normalize = (val) => val ? String(val).replace(/[$,]/g, '').trim() : null;

                            const normIncomeApproach = normalize(incomeApproachValue);
                            const normRecon = normalize(reconValue);

                            if (normIncomeApproach && normRecon && normIncomeApproach === normRecon) {
                                addValidationMessage('success', `✅ Value matches Reconciliation: The 'Indicated Value by Income Approach' (${incomeApproachValue}) is consistent with the 'Income Approach (if developed) $' value in the Reconciliation section.`);
                            } else {
                                addValidationMessage('error', `⚠️ Value Mismatch: 'Indicated Value by Income Approach' (${incomeApproachValue || 'N/A'}) does not match the 'Income Approach (if developed) $' value (${reconValue || 'N/A'}) from the Reconciliation section.`);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching reconciliation data for validation:', error);
                        addValidationMessage('error', 'Could not fetch Reconciliation data for validation.');
                    }
                }
                // Run the async validation
                validateIncomeApproachValue();
                {% endif %}

                {% if section_key == 'certification' %}
                // --- Appraiser License Validation ---
                const licenseName = getFieldValue('Appraiser Name on License');
                const licenseNumber = getFieldValue('License Number on License');
                const licenseExpDate = getFieldValue('License Expiration Date on License');

                if (licenseName || licenseNumber || licenseExpDate) {
                    addValidationMessage('success', '✅ Attached license found. Performing validation...');

                    // 1. Validate Name
                    const certName = getFieldValue('Name');
                    if (certName && licenseName && certName.toLowerCase() !== licenseName.toLowerCase()) {
                        // Allow for partial matches (e.g., middle initial vs. full middle name)
                        const certNameParts = certName.toLowerCase().split(' ');
                        const licenseNameParts = licenseName.toLowerCase().split(' ');
                        const isMatch = certNameParts.every(part => licenseName.toLowerCase().includes(part));

                        if (!isMatch) {
                             addValidationMessage('error', `⚠️ Name Mismatch: Certification name is '${certName}' but license name is '${licenseName}'.`);
                        } else {
                             addValidationMessage('success', `✅ Name Consistent: Certification name '${certName}' is consistent with license name '${licenseName}'.`);
                        }
                    }

                    // 2. Validate License Number
                    const certLicenseNumber = getFieldValue('State Certification # or State License #');
                    if (certLicenseNumber && licenseNumber && certLicenseNumber.replace(/\s/g, '') !== licenseNumber.replace(/\s/g, '')) {
                        addValidationMessage('error', `⚠️ License Number Mismatch: Certification number is '${certLicenseNumber}' but license number is '${licenseNumber}'.`);
                    } else if (certLicenseNumber && licenseNumber) {
                        addValidationMessage('success', `✅ License Number Match: '${certLicenseNumber}'.`);
                    }

                    // 3. Validate Expiration Date
                    const certExpDate = getFieldValue('Expiration Date of Certification or License');
                    if (certExpDate && licenseExpDate && new Date(certExpDate).getTime() !== new Date(licenseExpDate).getTime()) {
                        addValidationMessage('error', `⚠️ Expiration Date Mismatch: Certification date is '${certExpDate}' but license date is '${licenseExpDate}'.`);
                    } else if (certExpDate && licenseExpDate) {
                        addValidationMessage('success', `✅ License Expiration Date Match: '${certExpDate}'.`);
                    }

                } else {
                    addValidationMessage('warning', "⚠️ No attached appraiser license was found in the document. Manual verification of license details is required.");
                }

                // --- E&O Insurance Expiration Validation ---
                const eoExpDateStr = getFieldValue('E&O Expiration Date on Document');
                if (eoExpDateStr && eoExpDateStr !== 'null') {
                    const eoExpDate = new Date(eoExpDateStr);
                    const today = new Date();
                    // Set hours to 0 to compare dates only, ignoring time
                    today.setHours(0, 0, 0, 0);

                    if (!isNaN(eoExpDate.getTime())) {
                        if (eoExpDate < today) {
                            addValidationMessage('error', `❌ E&O Insurance Expired: The policy expired on ${eoExpDateStr}.`);
                        } else {
                            addValidationMessage('success', `✅ E&O Insurance is valid. Expires on ${eoExpDateStr}.`);
                        }
                    }
                }
                {% endif %}

                {% if section_key == 'market_conditions' %}
                // Validation for Market Conditions Inventory Analysis
                const inventoryFieldPrefix = "Inventory Analysis";
                const missingInventoryFields = [];

                // Select the first table which is the grid
                const gridTable = document.querySelector('table');
                if (gridTable) {
                    const gridRows = gridTable.querySelectorAll('tbody tr');
                    gridRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        if (fieldCell && fieldCell.textContent.trim().startsWith(inventoryFieldPrefix)) {
                            const valueCells = row.querySelectorAll('td.editable-value');
                            valueCells.forEach(cell => {
                                const value = cell.textContent.trim();
                                if (!value || value === '--' || value === 'null') {
                                    // Get a descriptive name for the missing field
                                    const fieldName = cell.dataset.fieldName || fieldCell.textContent.trim();
                                    missingInventoryFields.push(fieldName);
                                }
                            });
                        }
                    });
                }

                if (missingInventoryFields.length > 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = `⚠️ Validation warning: The following required fields in the Inventory Analysis grid are empty: ${missingInventoryFields.join(', ')}.`;
                    validationContainer.appendChild(messageDiv);
                }

                {% endif %}

                {% if section_key == 'custom_analysis' %}
                // Validation for GLA Consistency custom analysis
                const customPrompt = `{{ custom_prompt|escapejs }}`.toLowerCase().trim();
                const analysisSummary = `{{ data.analysis_summary|escapejs }}`.toLowerCase();
                const glaConsistencyPrompt = "check for any discrepancies in the gross living area (gla) across all sections of the report.";

                if (customPrompt === glaConsistencyPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    if (analysisSummary.includes('consistent') || analysisSummary.includes('no discrepancies') || analysisSummary.includes('consistently') || analysisSummary.includes('verified') || analysisSummary.includes('match')) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The analysis summary indicates that the GLA is consistent.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation Failed: The analysis summary indicates a potential inconsistency in the GLA. Please review the findings.';
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for Subject Address and Photo custom analysis
                const subjectAddressPrompt = "verify that the subject property address is consistent across the subject section, sales grid, location map, and aerial map\n\nalso please confirm subject street, front and rear photo are present and no duplicates.";

                if (customPrompt === subjectAddressPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    if (analysisSummary.includes('consistently') || analysisSummary.includes('verified') || analysisSummary.includes('match') || analysisSummary.includes('no discrepancies') || analysisSummary.includes('consistently') || analysisSummary.includes('present') || analysisSummary.includes('no duplicates')) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The analysis summary indicates that the subject address and photos are consistent and present.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation Failed: The analysis summary indicates a potential issue with the subject address or photos. Please review the findings.';
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for Compare Room Counts custom analysis
                const roomCountsPrompt = "compare the bedroom and bathroom counts between the improvements section, sales grid, and all available floor plans/ sktech/ building sketch and all photos.";

                if (customPrompt === roomCountsPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    if ((analysisSummary.includes('consistent') || analysisSummary.includes('match')) && (analysisSummary.includes('distinct photos') || analysisSummary.includes('no duplicate') || analysisSummary.includes('consistently'))) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The analysis summary indicates that the room counts are consistent.';
                    } else if (analysisSummary.includes('discrepancy') || analysisSummary.includes('however')) {
                        messageDiv.classList.add('validation-warning');
                        messageDiv.textContent = '⚠️ Partial Validation: A discrepancy was noted. Please review the findings manually.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '❌ Validation Failed: The analysis summary indicates a potential inconsistency in room counts. Please review the findings.';
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for Verify Comparable Address and Photos custom analysis
                const compAddressPrompt = "match all comparable property addresses between the sales grid, photo pages, and the location map.\n\nalso please confirm no duplicates.";

                if (customPrompt === compAddressPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    if ((analysisSummary.includes('consistent') || analysisSummary.includes('match')) && (analysisSummary.includes('distinct photos') || analysisSummary.includes('no duplicate') || analysisSummary.includes('consistently') || analysisSummary.includes('distinct'))) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The analysis summary indicates that comparable addresses are consistent and photos are not duplicated.';
                    } else {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation Failed: The analysis summary indicates a potential issue with comparable addresses or duplicate photos. Please review the findings.';
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for Verify Photo Lables custom analysis
                const photoLabelsPrompt = "verify all photo labels and no duplicate photos";

                if (customPrompt === photoLabelsPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    // Check for success keywords vs failure keywords.
                    if (analysisSummary.includes('no duplicate photos were found')) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The analysis summary indicates all photos have labels and no duplicates were found.';
                    } else if (analysisSummary.includes('duplicate photos were found')) {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation Failed: The analysis summary indicates that duplicate photos were found. Please review the findings.';
                    } else {
                        messageDiv.classList.add('validation-warning');
                        messageDiv.textContent = '❓ Validation Inconclusive: The analysis summary for photo labels could not be definitively categorized. Please review manually.';
                    }
                    validationContainer.appendChild(messageDiv);
                }

                // Validation for ADU Criteria Check
                const aduCriteriaPrompt = "check  'one with accessory unit' is selected in improvements section, the following criteria must be met:\n\n1.  this box should be checked if there is an additional dwelling with both a kitchen (containing a stove) and a bath.\n    *   if there is interior access, the adu may be included in the main unit's details.\n    *   if there is no interior access, the adu must be listed as a separate line item.\n    *   if the adu is considered a second floor, it may be included in the main unit's details.\n\n2.  if the additional dwelling lacks either a kitchen or a bath, 'one with accessory unit' must be unchecked.\n\n3.  if a basement contains a kitchen and bath, 'one with accessory unit' can be checked or unchecked.\n\n4.  a room labeled 'kitchenette' should not have a stove; in this case, no health and safety comment is needed. however, if a kitchenette does contain a stove, escalate with a comment (permitted/health or safety).\n\n    escalation language: on page #, a room labeled as 'kitchenette' has a stove. please advise.";

                if (customPrompt === aduCriteriaPrompt && analysisSummary) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message');
                    // Check for success keywords vs failure keywords.
                    if (analysisSummary.includes("report's selection aligns with the provided criteria") || analysisSummary.includes("correctly checked") || analysisSummary.includes("correctly unchecked") || analysisSummary.includes("checked") || analysisSummary.includes("unchecked")) {
                        messageDiv.classList.add('validation-success');
                        messageDiv.textContent = '✅ Validation Passed: The ADU selection aligns with the analysis criteria.';
                    } else if (analysisSummary.includes("does not align") || analysisSummary.includes("incorrectly checked") || analysisSummary.includes("discrepancy")) {
                        messageDiv.classList.add('validation-error');
                        messageDiv.textContent = '⚠️ Validation Failed: The analysis summary indicates a discrepancy with the ADU criteria. Please review the findings.';
                    } else {
                        messageDiv.classList.add('validation-warning');
                        messageDiv.textContent = '❓ Validation Inconclusive: The ADU criteria analysis could not be definitively categorized. Please review manually.';
                    }
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}

                {% if section_key == 'sales_grid_adjustment' %}
                // Validation for Sales Grid Adjustment analysis results
                const analysisDetails = {{ data.adjustment_analysis.details|safe }};

                if (analysisDetails && Array.isArray(analysisDetails)) {
                    analysisDetails.forEach(detail => {
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('validation-message');
                        const detailLower = detail.toLowerCase();

                        // Determine message type based on keywords
                        if (detailLower.includes('failed') || detailLower.includes('inconsistent') || detailLower.includes('exceeds') || detailLower.includes('error')) {
                            messageDiv.classList.add('validation-error');
                            messageDiv.innerHTML = `❌ ${detail}`;
                        } else if (detailLower.includes('passed') || detailLower.includes('consistent')) {
                            messageDiv.classList.add('validation-success');
                            messageDiv.innerHTML = `✅ ${detail}`;
                        } else {
                            messageDiv.classList.add('validation-warning');
                            messageDiv.innerHTML = `⚠️ ${detail}`;
                        }
                        validationContainer.appendChild(messageDiv);
                    });
                } else {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', 'validation-error');
                    messageDiv.textContent = '⚠️ Could not find adjustment analysis details to validate.';
                    validationContainer.appendChild(messageDiv);
                }
                {% endif %}

                {% if section_key == 'sale_history' %}
                // --- Sale History Section Validation ---
                const researchAndAnalysisTable = document.querySelectorAll('table')[1]; // Second table on the page
                const gridTable = document.querySelectorAll('table')[0]; // First table

                const getResearchFieldValue = (fieldName) => {
                    const row = Array.from(researchAndAnalysisTable.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim().startsWith(fieldName));
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                const isEmpty = (val) => !val || val === '--' || val === 'null';

                // Rule 1: Check required fields in Research and Analysis
                const requiredResearchFields = [
                    "I ____ research the sale or transfer history",
                    "My research _____ reveal any prior sales or transfers of the subject property",
                    "Data Source(s) for subject property research",
                    "My research ______ reveal any prior sales or transfers of the comparable sales",
                    "Data Source(s) for comparable sales research",
                    "Analysis of prior sale or transfer history"
                ];
                const missingResearchFields = requiredResearchFields.filter(field => isEmpty(getResearchFieldValue(field)));

                if (missingResearchFields.length > 0) {
                    addValidationMessage('error', `⚠️ Validation Failed: The following required fields in the 'Research and Analysis' section are empty: ${missingResearchFields.join(', ')}.`);
                } else {
                    addValidationMessage('success', `✅ Validation Passed: All required 'Research and Analysis' fields are filled.`);
                }

                // Rule 2: "I ____ research..." must be "did"
                const researchPerformed = getResearchFieldValue("I ____ research the sale or transfer history");
                if (researchPerformed && researchPerformed.toLowerCase() !== 'did') {
                    addValidationMessage('error', `⚠️ Validation Failed: 'I ____ research the sale or transfer history...' must be marked 'did', but it is '${researchPerformed}'.`);
                } else if (researchPerformed) {
                    addValidationMessage('success', `✅ Validation Passed: Research was performed ('did').`);
                }

                // Rule 3: Conditional validation for Subject prior sale
                const subjectHistoryFound = getResearchFieldValue("My research _____ reveal any prior sales or transfers of the subject property");
                if (subjectHistoryFound && subjectHistoryFound.toLowerCase() === 'did') {
                    const subjectDateRow = Array.from(gridTable.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === 'Date of Prior Sale/Transfer');
                    const subjectPriceRow = Array.from(gridTable.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === 'Price of Prior Sale/Transfer');

                    const subjectDate = subjectDateRow ? subjectDateRow.querySelector('td:nth-child(2)')?.textContent.trim() : null;
                    const subjectPrice = subjectPriceRow ? subjectPriceRow.querySelector('td:nth-child(2)')?.textContent.trim() : null;

                    if (isEmpty(subjectDate) || isEmpty(subjectPrice)) {
                        addValidationMessage('error', `⚠️ Validation Failed: Report indicates a prior sale for the Subject was found, but 'Date of Prior Sale/Transfer' or 'Price of Prior Sale/Transfer' is missing in the grid.`);
                    } else {
                        addValidationMessage('success', `✅ Validation Passed: Subject prior sale details are present as required.`);
                    }
                }

                // Rule 4: Conditional validation for Comparables' prior sales
                const compHistoryFound = getResearchFieldValue("My research ______ reveal any prior sales or transfers of the comparable sales");
                if (compHistoryFound && compHistoryFound.toLowerCase() === 'did') {
                    const compDateRow = Array.from(gridTable.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === 'Date of Prior Sale/Transfer');
                    const compPriceRow = Array.from(gridTable.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === 'Price of Prior Sale/Transfer');

                    if (compDateRow && compPriceRow) {
                        const compDateCells = Array.from(compDateRow.querySelectorAll('td')).slice(2); // Skip Feature and Subject columns
                        const compPriceCells = Array.from(compPriceRow.querySelectorAll('td')).slice(2);

                        let allCompsHaveData = true;
                        let compsWithMissingData = [];

                        // Check if at least one comparable has data.
                        let atLeastOneCompHasData = false;
                        for (let i = 0; i < compDateCells.length; i++) {
                            const date = compDateCells[i].textContent.trim();
                            const price = compPriceCells[i].textContent.trim();
                            if (!isEmpty(date) && !isEmpty(price)) {
                                atLeastOneCompHasData = true;
                                break;
                            }
                        }

                        if (!atLeastOneCompHasData) {
                            addValidationMessage('error', `⚠️ Validation Failed: Report indicates prior sales for Comparables were found, but no comparable has both 'Date of Prior Sale/Transfer' and 'Price of Prior Sale/Transfer' filled in the grid.`);
                        } else {
                            addValidationMessage('success', `✅ Validation Passed: At least one comparable has prior sale details as required.`);
                        }
                    }
                }
                {% endif %}

                {% if section_key == 'pud_info' %}
                // Validation for PUD Info section based on 'isPUD' flag
                if (sessionStorage.getItem('isPUD') === 'true') {
                    let devInControl = null;
                    const requiredFields = [
                        "Legal Name of Project", "Total number of phases", "Total number of units",
                        "Total number of units sold", "Total number of units rented",
                        "Total number of units for sale", "Data source(s)"
                    ];
                    const missingFields = [];

                    tableRows.forEach(row => {
                        const fieldCell = row.querySelector('td:first-child');
                        const valueCell = row.querySelector('td:last-child');
                        if (fieldCell && valueCell) {
                            const fieldName = fieldCell.textContent.trim();
                            if (fieldName === "Is the developer/builder in control of the Homeowners' Association (HOA)?") {
                                devInControl = valueCell.textContent.trim().toLowerCase();
                            }
                        }
                    });

                    if (devInControl === 'yes') {
                        tableRows.forEach(row => {
                            const fieldCell = row.querySelector('td:first-child');
                            const valueCell = row.querySelector('td:last-child');
                            const fieldName = fieldCell.textContent.trim();
                            const value = valueCell.textContent.trim();

                            if (requiredFields.includes(fieldName) && (!value || value === '--' || value === 'null')) {
                                missingFields.push(fieldName);
                            }
                        });

                        if (missingFields.length > 0) {
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('validation-message', 'validation-error');
                            messageDiv.textContent = `⚠️ Validation warning: Since the developer is in control of the HOA, the following fields are required but are empty: ${missingFields.join(', ')}.`;
                            validationContainer.appendChild(messageDiv);
                        }
                    }
                }
                {% endif %}
            }
            {% if section_key == 'state_requirement' %}
            function runStateValidations() {
                const validationContainer = document.getElementById('validation-container');
                validationContainer.innerHTML = ''; // Clear previous messages
                const subjectState = sessionStorage.getItem('subjectState');

                const getFieldValue = (fieldName) => {
                    const row = Array.from(document.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim().toLowerCase() : null;
                };

                const addValidationMessage = (type, message) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', `validation-${type}`);
                    messageDiv.innerHTML = message;
                    validationContainer.appendChild(messageDiv);
                };

                if (!subjectState) {
                    addValidationMessage('error', "⚠️ Could not determine the property's state. Please review the 'Subject' section first.");
                    return;
                }

                // addValidationMessage('warning', `ℹ️ Validating requirements for state: <strong>${subjectState}</strong>`);

                // --- Fee & License Requirements ---
                const feeStates = ['AZ', 'CO', 'CT', 'GA', 'IL', 'LA', 'NJ', 'NV', 'NM', 'ND', 'OH', 'UT', 'VA', 'VT', 'WV'];
                const amcLicenseStates = ['GA', 'IL', 'MT', 'NJ', 'OH', 'VT'];
                const amcFeeStates = ['NV', 'NM', 'UT'];
                let hasRules = false;

                const checkRequirement = (applies, fieldName, finding) => {
                    if (!applies) return;
                    hasRules = true;
                    if (finding && (finding.includes('found') || finding.includes('disclosed') || finding.includes('present') || finding.includes('verified'))) {
                        addValidationMessage('success', `✅ <strong>${fieldName}:</strong> Passed. Requirement appears to be met.`);
                    } else if (finding && (finding.includes('not found') || finding.includes('missing') || finding.includes('not present'))) {
                        addValidationMessage('error', `❌ <strong>${fieldName}:</strong> Failed. Requirement was not met according to the analysis.`);
                    } else {
                        addValidationMessage('warning', `⚠️ <strong>${fieldName}:</strong> Needs Review. The analysis was inconclusive. Please verify manually.`);
                    }
                };

                if (feeStates.includes(subjectState)) {
                    const finding = getFieldValue('Appraiser Fee Disclosure');
                    checkRequirement(true, 'Appraiser Fee Disclosure', finding);
                }
                if (amcLicenseStates.includes(subjectState)) {
                    const finding = getFieldValue('AMC License Disclosure');
                    checkRequirement(true, 'AMC License Disclosure', finding);
                }
                if (amcFeeStates.includes(subjectState)) {
                    const finding = getFieldValue('AMC Fee Disclosure');
                    checkRequirement(true, 'AMC Fee Disclosure', finding);
                }

                // --- Specific State Guidelines ---
                switch (subjectState) {
                    case 'CA':
                        checkRequirement(true, 'Smoke/CO Detector Requirements', getFieldValue('Smoke/CO Detector Requirements'));
                        checkRequirement(true, 'Water Heater Strapping', getFieldValue('Water Heater Strapping'));
                        hasRules = true;
                        break;
                    case 'GA':
                        // These are covered by the general checks above, but we can add a summary
                        addValidationMessage('warning', `<strong>GA Specific:</strong> Appraiser’s fee & AMC License # are required.`);
                        hasRules = true;
                        break;
                    case 'IL':
                        checkRequirement(true, 'AMC License Disclosure', getFieldValue('AMC License Disclosure'));
                        checkRequirement(true, 'Appraiser Fee Disclosure', getFieldValue('Appraiser Fee Disclosure'));
                        checkRequirement(true, 'Smoke/CO Detector Requirements', getFieldValue('Smoke/CO Detector Requirements'));
                        checkRequirement(true, 'State-Specific Legal Statements', getFieldValue('State-Specific Legal Statements'));
                        hasRules = true;
                        break;
                    case 'NY':
                        checkRequirement(true, 'Invoice Copy Requirement', getFieldValue('Invoice Copy Requirement'));
                        hasRules = true;
                        break;
                    case 'OH':
                    case 'VT':
                        addValidationMessage('warning', `<strong>${subjectState} Specific:</strong> Appraiser’s fee & AMC License # are required.`);
                        checkRequirement(true, 'Appraiser Fee Disclosure', getFieldValue('Appraiser Fee Disclosure'));
                        checkRequirement(true, 'AMC License Disclosure', getFieldValue('AMC License Disclosure'));
                        hasRules = true;
                        break;
                    case 'UT':
                        checkRequirement(true, 'Water Heater Strapping', getFieldValue('Water Heater Strapping'));
                        checkRequirement(true, 'AMC Fee Disclosure', getFieldValue('AMC Fee Disclosure'));
                        checkRequirement(true, 'Appraiser Fee Disclosure', getFieldValue('Appraiser Fee Disclosure'));
                        hasRules = true;
                        break;
                    case 'VA':
                        checkRequirement(true, 'Smoke/CO Detector Requirements', getFieldValue('Smoke/CO Detector Requirements'));
                        checkRequirement(true, 'Appraiser Fee Disclosure', getFieldValue('Appraiser Fee Disclosure'));
                        hasRules = true;
                        break;
                    case 'WI':
                        checkRequirement(true, 'Smoke/CO Detector Requirements', getFieldValue('Smoke/CO Detector Requirements'));
                        hasRules = true;
                        break;
                }

                // Check if any rules were applied. If not, show the 'no rules' message.
                const allRuleStates = [...new Set([...feeStates, ...amcLicenseStates, ...amcFeeStates, 'CA', 'GA', 'IL', 'NY', 'OH', 'VT', 'UT', 'VA', 'WI'])];
                if (!allRuleStates.includes(subjectState)) {
                     addValidationMessage('success', `✅ No specific state-level requirements found for <strong>${subjectState}</strong> in the defined rules.`);
                }

            }
            // Override the default validate button behavior for this specific section
            document.getElementById('validate-btn').addEventListener('click', runStateValidations);
            // Run validations on initial page load
            runStateValidations();
            {% else %}
            {% comment %} Add client_lender_requirements validation here {% endcomment %}
            {% if section_key == 'client_lender_requirements' %}
            function runClientLenderValidations() {
                const validationContainer = document.getElementById('validation-container');
                validationContainer.innerHTML = ''; // Clear previous messages

                const getFieldValue = (fieldName) => {
                    const row = Array.from(document.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === fieldName);
                    return row ? row.querySelector('td:last-child')?.textContent.trim() : null;
                };

                const addValidationMessage = (type, message) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('validation-message', `validation-${type}`);
                    messageDiv.innerHTML = message;
                    validationContainer.appendChild(messageDiv);
                };

                // Iterate through each row in the table for client/lender requirements
                const tableRows = document.querySelectorAll('tbody tr');
                let clientIdentified = false; // Flag to check if a client was identified

                tableRows.forEach(row => {
                    const fieldCell = row.querySelector('td:first-child');
                    const valueCell = row.querySelector('td:last-child');

                    if (fieldCell && valueCell) {
                        const fieldName = fieldCell.textContent.trim();
                        const value = valueCell.textContent.trim();
                        const valueLower = value.toLowerCase();

                        if (valueLower.includes('n/a - client not identified')) {
                            addValidationMessage('error', `⚠️ <strong>${fieldName}:</strong> ${value}`);
                            return; // Skip further processing for this row if client not identified
                        }

                        if (valueLower.includes('n/a - rule does not apply')) {
                            addValidationMessage('success', `✅ <strong>${fieldName}:</strong> ${value}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('passed:')) {
                            addValidationMessage('success', `✅ <strong>${fieldName}:</strong> ${value.replace(/passed:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('failed:')) {
                            addValidationMessage('error', `❌ <strong>${fieldName}:</strong> ${value.replace(/failed:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('info:')) {
                            addValidationMessage('warning', `ℹ️ <strong>${fieldName}:</strong> ${value.replace(/info:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('advisory:')) {
                            addValidationMessage('warning', `⚠️ <strong>${fieldName}:</strong> ${value.replace(/advisory:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('escalate:')) {
                            addValidationMessage('error', `🚨 <strong>${fieldName}:</strong> ${value.replace(/escalate:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('reviewer reminders:')) {
                            addValidationMessage('warning', `ℹ️ <strong>${fieldName}:</strong> ${value.replace(/reviewer reminders:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.includes('rov handling:')) {
                            addValidationMessage('warning', `ℹ️ <strong>${fieldName}:</strong> ${value.replace(/rov handling:/i, '').trim()}`);
                            clientIdentified = true;
                        } else if (valueLower.startsWith('n/a -')) { // Catch all N/A messages not specifically "rule does not apply"
                            addValidationMessage('success', `✅ <strong>${fieldName}:</strong> ${value}`);
                            clientIdentified = true;
                        } else {
                            // Default handling for any other value, perhaps a general warning or info
                            addValidationMessage('warning', `❓ <strong>${fieldName}:</strong> Uncategorized finding: ${value}`);
                            clientIdentified = true;
                        }
                    }
                });

                if (!clientIdentified) {
                    addValidationMessage('error', `⚠️ <strong>Client Identification:</strong> Could not identify a specific client or apply any rules. Please ensure the client name is present in the report.`);
                }
            }
            // Override the default validate button behavior for this specific section
            document.getElementById('validate-btn').addEventListener('click', runClientLenderValidations);
            // Run validations on initial page load
            runClientLenderValidations();
            {% else %}
            // Add event listener for the validate button for all other sections
            document.getElementById('validate-btn').addEventListener('click', runValidations);
            // Run validations on initial page load (after revision setup)
            runValidations();
            {% endif %}
            {% endif %}

            // --- Custom Analysis Page Specific JS ---
            if (document.body.contains(document.getElementById('custom-analysis-form'))) {
                document.querySelectorAll('.prompt-suggestion-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promptText = this.getAttribute('data-prompt');
                        const textarea = document.querySelector('#custom-analysis-form textarea[name="custom_prompt"]');
                        textarea.value = promptText;
                        textarea.focus();
                    });
                });

                document.getElementById('custom-analysis-form').addEventListener('submit', function(event) {
                    const promptText = this.querySelector('textarea[name="custom_prompt"]').value;
                    if (promptText.trim() === '') {
                        alert('Please enter a question or instruction for the analysis.');
                        event.preventDefault(); // Stop the form from submitting
                    } else {
                        // The loading overlay is in the main content, so we need to show it
                        const loadingOverlay = document.getElementById('loading-overlay');
                        if(loadingOverlay) loadingOverlay.style.display = 'flex';
                    }
                });

                const finishBtn = document.getElementById('finish-review-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', function() {
                        const startTimeISO = new Date(parseInt(sessionStorage.getItem('reviewStartTime'))).toISOString();
                        const endTimeISO = new Date().toISOString();
                        const user = "{{ user.username }}";
                        const filename = "{{ filename }}";

                        const reportData = {
                            user: user,
                            filename: filename,
                            startTime: startTimeISO,
                            endTime: endTimeISO
                        };

                        // Send data to the backend to be logged
                        navigator.sendBeacon("{% url 'generate_report' %}", JSON.stringify(reportData));

                        // Clear session storage for the next review
                        sessionStorage.removeItem('reviewStartTime');
                        // Redirect to the new upload page
                        window.location.href = "{% url 'upload_pdf' %}";
                    });
                }
            }

            // --- Revision Helper Toggle ---
            const revisionHelperCard = document.querySelector('.revision-helper-card');
            if (revisionHelperCard) {
                const header = revisionHelperCard.querySelector('.revision-helper-header');
                const toggleBtn = revisionHelperCard.querySelector('.toggle-revision-helper-btn');

                header.addEventListener('click', function() {
                    revisionHelperCard.classList.toggle('expanded');
                    if (revisionHelperCard.classList.contains('expanded')) {
                        toggleBtn.textContent = 'Hide';
                    } else {
                        toggleBtn.textContent = 'Show';
                    }
                });
            }
        });
    </script>
</body>
</html>