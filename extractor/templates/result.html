{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'extractor\css\style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'extractor/img/logo.png' %}">
    <title>Extraction Result: {{ section_title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Playfair+Display:ital,wght@1,500&display=swap" rel="stylesheet">
    <style>
        /* Loader Overlay Specific Styles */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none; /* Hidden by default, toggled by JS */
            justify-content: center;
            align-items: center;
        }

        .loader-wrapper {
            position: relative;
            width: 130px;
            height: 130px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader-arcs {
            position: absolute;
            inset: 0;
            animation: rotateLoader 4s linear infinite;
        }

        @keyframes rotateLoader {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loader-arc-path {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
        }

        .loader-arc-1 { stroke: url(#loader-grad1); }
        .loader-arc-2 { stroke: url(#loader-grad2); }

        .loader-text-group {
            position: absolute;
            text-align: center;
            z-index: 2;
        }

        .loader-brand {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 700;
            margin: 0;
            letter-spacing: 10px;
            background: linear-gradient(45deg, #00FFFF, #FF00FF, #FFD700);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loader-tag {
            font-family: 'Montserrat', sans-serif;
            font-size: 4px;
            font-style: italic;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: 600;
            background: linear-gradient(90deg, #00FFFF, #FF00FF);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loader-glow {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,255,255,0.3), rgba(255,0,255,0.2), transparent 70%);
            animation: pulse 6s ease-in-out infinite;
            z-index: 1;
        }
    </style>
</head>

<body style="display: flex; margin: 0; background-color: var(--primary-bg); color: var(--text-primary);">
    {% load dict_helpers %}
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container" style="text-align: center; margin-bottom: 15px;">
                <img src="{% static 'extractor/img/logo.png' %}" alt="Logo" style="max-width: 150px; height: auto;">
            </div>
            {% if user.is_authenticated %}
                <p class="username">Welcome, {{ user.username }}</p>
                <a href="{% url 'logout' %}" class="logout-link">Logout</a>
            {% endif %}
        </div>
        
        <h3 style="margin-top:0;">Sections</h3>
        <ul>
            {% for key, display_name in sections.items %} 
                {% if key != 'additional_comments' %}
                <li>
                    <a href="{% url 'extract_section' filename=filename section_name=key %}" class="section-link {% if key == section_key %}active{% endif %}">
                        {{ display_name }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}
        </ul>
        <div class="sidebar-footer">
            <a href="javascript:history.back()" class="back-btn">← Back</a>
            <a href="{% url 'upload_pdf' %}" class="new-upload-btn">New Upload</a>
        </div>
    </div>

    <div class="main-content">
        <div class="loading-overlay" id="loading-overlay">
            <div class="loader-wrapper">
                <div class="loader-glow"></div>
    
                <svg class="loader-arcs" viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="loader-grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#00FFFF" />
                            <stop offset="50%" stop-color="#FF00FF" />
                            <stop offset="100%" stop-color="#FFD700" />
                        </linearGradient>
                        <linearGradient id="loader-grad2" x1="100%" y1="100%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#FFD700" />
                            <stop offset="50%" stop-color="#FF00FF" />
                            <stop offset="100%" stop-color="#00FFFF" />
                        </linearGradient>
                    </defs>
    
                    <path class="loader-arc-path loader-arc-1" d="M 92,50 A 42,42 0 0 0 50,8" />
                    <path class="loader-arc-path loader-arc-2" d="M 8,50 A 42,42 0 0 0 50,92" />
                </svg>
    
                <div class="loader-text-group">
                    <h1 class="loader-brand">DJRB</h1>
                    <div class="loader-tag">Services</div>
                </div>
            </div>
        </div>

        <div class="header-container">
            <div class="header-main">
                <h1>{{ section_title }}</h1>
                <p><strong>Review Time:</strong> <span id="review-timer">00:00:00</span></p>
            </div>
            <button id="validate-btn" class="validate-button">Validate</button>
        </div>
        <div id="validation-container"></div>
        
        {% comment %} Display backend validation messages if they exist {% endcomment %}
        {% if data.backend_validation %}
            <div class="validation-message validation-{{ data.backend_validation.status }}">
                <strong>Backend Validation:</strong> {{ data.backend_validation.message }}
            </div>
        {% endif %}

        {% comment %} Display ADU validation messages if they exist {% endcomment %}
        {% if data.adu_validation %}
            {% with status_lower=data.adu_validation.status|lower %}
            <div class="validation-message validation-{% if 'fail' in status_lower %}error{% elif 'pass' in status_lower %}success{% else %}warning{% endif %}">
                <strong>ADU Validation:</strong> {{ data.adu_validation.message }}
            </div>
            {% endwith %}
        {% endif %}

        {% if data.error %}
            <p class="error">Error: {{ data.error }}</p>
        {% elif section_key == 'all_in_one_check' %}
            <div class="custom-analysis-container" style="margin-top: 20px;">
                <h3>Comprehensive Check Summary</h3>
                <p class="custom-analysis-summary">{{ data.summary|default:"No summary provided." }}</p>
                
                <h3 style="margin-top: 30px;">Detailed Checks</h3>
                {% if data.checks %}
                    <table class="findings-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Section</th>
                                <th>Values</th>
                                <th>Comment</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for check in data.checks %}
                            <tr>
                                <td>
                                    {% with status_lower=check.status|lower %}
                                    <span class="status-{{ status_lower }}">{{ check.status|default:"Info" }}</span>
                                    {% endwith %}
                                </td>
                                <td class="finding-title">{{ check.section|default:"N/A" }}</td>
                                <td class="finding-source">{{ check.values|default:"N/A" }}</td>
                                <td class="check-details">{{ check.comment|default:"No comment." }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>No specific checks were returned from the analysis.</p>
                {% endif %}
            </div>
        {% elif section_key == 'sales_grid' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Sales Grid Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Sales Comparison Approach</strong> grid.</p>
                        <ul class="revision-helper-list">
                            <li>Verify sales grid header data (counts, price ranges) is complete and correctly formatted.</li>
                            <li>Ensure at least 3 closed sales are used for the primary comps (not listings).</li>
                            <li>Verify comp data integrity: sale dates are logical (not future, not after effective date), verification sources are noted, proximity is filled.</li>
                            <li>Check for appropriate comp selection (e.g., leasehold comps for a leasehold subject, reasonable proximity).</li>
                            <li>Ensure Subject data (age, GLA, rooms, garage, amenities) is consistent with other sections (Improvements, Sketch, Page 1).</li>
                            <li>Verify ADU details are on a separate line item, not combined with the main unit's GLA/room counts.</li>
                            <li>Check for logical adjustment direction (e.g., superior features get negative adjustments).</li>
                            <li>Verify adjustment amounts are consistent for similar features across all comps (e.g., GLA, baths, condition).</li>
                            <li>Ensure adjustments are explained if not obvious (e.g., for View, Location, or Condition).</li>
                            <li>Verify the 'Indicated Value' is bracketed by the adjusted sale prices of the comparables.</li>
                            <li>Ensure the 'Indicated Value' in the grid matches the final value in the Reconciliation section.</li>
                            <li>Check for data entry errors in grid line items (e.g., a date in the 'Pool' field).</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {# Use the get_item filter to access the value by the field name #} 
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {# Display the final indicated value at the bottom, spanning all columns #}
                    <tr>
                        <td><strong>Indicated Value by Sales Comparison Approach</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Indicated Value by Sales Comparison Approach">
                            <strong>{{ data|get_item:"Indicated Value by Sales Comparison Approach"|default_if_none:"" }}</strong>
                        </td>
                    </tr>
                </tbody>
            </table>
        {% elif section_key == 'subject' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Subject Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    {% if is_fha_case %}
                        <div class="revision-helper-content">
                            <p>Use this checklist to verify common revision requests for an <strong>FHA Subject</strong> section.</p>
                            <ul class="revision-helper-list">
                                <li>Please include the FHA case# on all pages of the report.</li>
                                <li>Per photos the subject has repairs however the report made As-is. Please state whether the subject meets FHA 4000.1 handbook guidelines or not. If not, please revise to subject-to repair.</li>
                                <li>Please comment in the addendum that the intended user of the report is FHA/HUD.</li>
                                <li>Please state whether the subject meets FHA 4000.1 handbook guidelines or not.</li>
                                <li>Please comment if the attic was inspected.</li>
                                <li>Please comment if the crawlspace was inspected.</li>
                                <li>Please label the porch/patio/deck on sketch per the FHA requirement.</li>
                                <li>Comments indicate the report should be made subject to repairs. Please revise accordingly.</li>
                                <li>Please address if well and septic distances meet HUD guidelines.</li>
                            </ul>
                        </div>
                    {% endif %}
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Subject</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Mark that the subject is offered for sale.</li>
                            <li>Add the borrower's middle initial (M).</li>
                            <li>Update unit number in the subject’s address (e.g., Unit 123D).</li>
                            <li>Revise street name to "River Bend" (two words).</li>
                            <li>Revise street suffix from Cir to Dr.</li>
                            <li>Complete lender name (e.g., "aura capital funding mangement LLC").</li>
                            <li>Add street suffix ‘Dr’ in the lender address.</li>
                            <li>Revise property address to match order form (e.g., 3437-3439 Viking St).</li>
                            <li>Add ‘Inc’ at the end of the lender/client name (e.g., OCMBC Inc.).</li>
                            <li>Revise the borrower's last name (e.g., ‘Arnett’).</li>
                            <li>Revise the spelling of the lender's city (e.g., Tucson).</li>
                            <li>Revise the state in the lender's address (e.g., PA).</li>
                            <li>Remove ‘Inc’ from lender/client name (e.g., The Loan Store, JMAC Lending).</li>
                            <li>Add ‘W’ direction in the subject property address.</li>
                            <li>Revise lender/client address city name to match the order form.</li>
                            <li>Revise borrower name to match the order form.</li>
                            <li>Revise the spelling of the borrower’s first name.</li>
                            <li>Ensure ‘Legal Description’ is noted in the report.</li>
                            <li>If Legal Description is "see addendum", verify it's in the addendum.</li>
                            <li>Ensure ‘Assessor's Parcel #’ is noted.</li>
                            <li>Revise borrower name to a single name (e.g., Adam Gleve).</li>
                            <li>Ensure ‘Neighborhood Name’ is noted.</li>
                            <li>Verify occupancy if photos suggest vacant/occupied mismatch.</li>
                            <li>If Zoning is PUD, ensure PUD box is checked.</li>
                            <li>If PUD, ensure PUD Information section is complete.</li>
                            <li>If PUD/HOA amount is noted, ensure ‘per year/month’ is marked.</li>
                            <li>Uncheck the PUD box if not a PUD.</li>
                            <li>If PUD box is marked, verify HOA amount is not 0.</li>
                            <li>If not PUD, ensure PUD Information section is not completed.</li>
                            <li>Remove ‘Trust’ from lender/client name (e.g., BPL Mortgage, LLC).</li>
                            <li>Ensure ‘Property Rights Appraised’ is marked.</li>
                            <li>Revise lender/client name to match order form (e.g., NQM Funding, LLC).</li>
                            <li>Ensure owner of public record is included on page 1.</li>
                            <li>Revise suite number in the lender/client address (e.g., Suite 400).</li>
                            <li>Ensure offering price is noted if offered for sale.</li>
                            <li>Refer to attached legal description if applicable.</li>
                            <li>Ensure 'offered for sale' checkbox is appropriately marked.</li>
                            <li>Ensure 'ANSI Standard Confirmation' is marked.</li>
                            <li>Verify 'Reasonable Exposure Time Comment' is provided.</li>
                            <li>Ensure 'Prior Service Certification' is marked.</li>
                            <li>For investment property, revise occupancy to tenant or vacant.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'contract' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Contract Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Contract</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify 'Contract Price' matches the purchase agreement.</li>
                            <li>Verify 'Date of Contract' matches the purchase agreement.</li>
                            <li>If 'Financial Assistance' is YES, ensure the concession amount is not 0.</li>
                            <li>Verify the concession amount matches the purchase agreement.</li>
                            <li>Ensure transaction type (arm's length or non-arm's length) is provided.</li>
                            <li>If a purchase, ensure 'did' analyze contract is checked.</li>
                            <li>If a purchase, ensure all fields are completed.</li>
                            <li>If a refinance, ensure the entire section is blank.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'neighborhood' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Neighborhood Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Neighborhood</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify predominant price is between Low/High range for 'One-Unit Housing'.</li>
                            <li>Verify Low/High price range is not interchanged for 'One-Unit Housing'.</li>
                            <li>Verify predominant age is between Low/High range for 'One-Unit Housing'.</li>
                            <li>Ensure Low, High, and Predominant values are noted for 'One-Unit Housing'.</li>
                            <li>Ensure 'Neighborhood Boundaries' are provided for all directions (North, South, East, West).</li>
                            <li>Verify 'Present Land Use' percentages sum to 100%.</li>
                            <li>If 'Other' land use has a percentage, ensure a comment is provided.</li>
                            <li>If appraised value is >10% higher than predominant value, check for over-improvement comments.</li>
                            <li>If appraised value is >10% lower than predominant value, check for under-improvement comments.</li>
                            <li>Check for subjective/forbidden words in 'Neighborhood Description' (e.g., "average condition").</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'site' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Site Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Site</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Ensure 'Site Area' unit is specified (e.g., 'sf' or 'ac').</li>
                            <li>If 'Zoning Compliance' is 'Legal Nonconforming' or 'No Zoning', check for comments on rebuild rights.</li>
                            <li>If 'Zoning Compliance' is 'Illegal', check for a detailed explanation.</li>
                            <li>If 'Highest and Best Use' is 'No', ensure a description is provided.</li>
                            <li>If photos show an alley, verify the 'Alley' box is marked.</li>
                            <li>If 'Sanitary Sewer' is 'Septic', check for comments on whether it's typical for the area.</li>
                            <li>If both 'Well' and 'Septic' are present, check for comments on HUD distance requirements.</li>
                            <li>Verify 'Sanitary Sewer' value is consistent (e.g., not marked 'Public' if comments say 'Septic').</li>
                            <li>Verify 'FEMA Special Flood Hazard Area' and 'FEMA Flood Zone' are consistent (e.g., 'No' with 'X', 'Yes' with 'A'/'AE').</li>
                            <li>Ensure 'Adverse Site Conditions' checkbox matches the corresponding comments.</li>
                            <li>Verify 'Utilities typical for market area' checkbox is marked.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'improvements' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Improvements Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Improvements</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify 'One w/ Accessory Unit' (ADU) checkbox matches photos, sketch, and ADU qualifications (e.g., kitchen).</li>
                            <li>Ensure 'Design (Style)' is consistent between Improvements and Sales Grid.</li>
                            <li>Verify 'Existing/Proposed/Under Const.' status matches photos and report context.</li>
                            <li>Ensure all 'Material/Condition' fields (Walls, Roof, etc.) are fully completed.</li>
                            <li>If photos show an attic/crawl space, verify the corresponding box is marked.</li>
                            <li>Ensure 'Heating/Cooling' details are consistent between Improvements and Sales Grid.</li>
                            <li>Verify 'Gross Living Area' (GLA) is a whole number and consistent with the sketch.</li>
                            <li>Verify 'Garage' type (Att./Det.) and count are consistent with photos and sketch.</li>
                            <li>Ensure amenity checkboxes (e.g., 'Porch', 'Pool') are not marked if the description is 'None'.</li>
                            <li>Verify 'Physical Deficiencies' checkbox matches the corresponding comments.</li>
                            <li>Ensure all bedroom and bathroom photos are provided and not duplicated.</li>
                            <li>Verify the building sketch is present and labels (e.g., bath labels) are correct.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% include 'key_value_row.html' with key=key value=value %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'reconciliation' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Reconciliation Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Reconciliation</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Verify the final 'Opinion of Market Value' matches the 'Indicated Value by Sales Comparison Approach'.</li>
                            <li>Ensure the 'Effective Date of Value' is correct and matches the inspection date.</li>
                            <li>If the report is 'subject to', verify the correct condition is checked (e.g., 'completion per plans', 'repairs', 'inspection').</li>
                            <li>If 'subject to', ensure a clear explanation and/or cost-to-cure is provided for the conditions.</li>
                            <li>If the report is 'as is', confirm there are no required repairs or health/safety issues noted elsewhere.</li>
                            <li>If Cost or Income approaches were developed, ensure their indicated values are present.</li>
                            <li>Confirm the final 'Opinion of Market Value' is bracketed by the adjusted sales prices of the comparables.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'sales_grid_adjustment' %}
            <div class="custom-analysis-container" style="margin-bottom: 30px;">
                <h3>Adjustment Consistency Analysis</h3>
                <p class="custom-analysis-summary">{{ data.adjustment_analysis.summary }}</p>
                <p><strong>Details:</strong></p>
                {% if data.adjustment_analysis.structured_details %}
                    <div class="validation-list">
                        {% for detail in data.adjustment_analysis.structured_details %}
                            <div class="validation-message validation-{{ detail.status }}" style="margin-bottom: 10px;">
                                {{ detail.message }}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <ul>{% for detail in data.adjustment_analysis.details %}<li>{{ detail }}</li>{% endfor %}</ul>
                {% endif %}
            </div>

            <h3>Adjustment Grid Data</h3>
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'custom_analysis' %}
            <div class="custom-analysis-page-container">
                <div class="analysis-form-column">
                    <div class="analysis-card">
                        <h3>Custom Document Analysis</h3>
                        <p>Enter a question below, or select a suggestion to get started.</p>
                        <div class="suggested-prompts">
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Check for any discrepancies in the Gross Living Area (GLA) across all sections of the report.">GLA Consistency</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Verify that the subject property address is consistent across the Subject section, Sales Grid, Location Map, and Aerial Map

Also please confirm subject street, front and rear photo are present and no duplicates.">Verify Subject Address, Photo(Street, front, rear, Duplicates)</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Compare the bedroom and bathroom counts between the Improvements section, Sales Grid, and all available floor plans/ sketch/ building sketch and all photos.">Compare Room Counts</button>
                            <!-- <button type="button" class="prompt-suggestion-btn" data-prompt="Check Consistent values

Indicated Value by Sales Comparison Approach $ from sales grid

Indicated Value by: Sales Comparison Approach $ from Reconciliation

opinion of the market value $ from Reconciliation

APPRAISED VALUE OF SUBJECT PROPERTY $ from APPRAISER CERTIFICATION">Final value $ Consistency</button> -->
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Match all comparable property addresses between the Sales Grid, photo pages, and the Location Map.

Also please confirm no duplicates.">Verify Comparable Address, Photo(Duplicates)</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Verify all Photo labels and no duplicate photos">Verify Photo Lables</button>
                            <button type="button" class="prompt-suggestion-btn" data-prompt="Check  'One with Accessory Unit' is selected in IMPROVEMENTS section, the following criteria must be met:

1.  This box should be checked if there is an additional dwelling with both a kitchen (containing a stove) and a bath.
    *   If there is interior access, the ADU may be included in the main unit's details.
    *   If there is no interior access, the ADU must be listed as a separate line item.
    *   If the ADU is considered a second floor, it may be included in the main unit's details.

2.  If the additional dwelling lacks either a kitchen or a bath, 'One with Accessory Unit' must be unchecked.

3.  If a basement contains a kitchen and bath, 'One with Accessory Unit' can be checked or unchecked.

4.  A room labeled 'kitchenette' should not have a stove; in this case, no health and safety comment is needed. However, if a kitchenette does contain a stove, escalate with a comment (permitted/health or safety).

    Escalation language: On page #, a room labeled as 'kitchenette' has a stove. Please advise.">ADU Criteria Check</button>
                            <!-- <div class="common-prompt-btn-container"> 
                                <button type="button" class="prompt-suggestion-btn" data-prompt="Please check and verify if below revision requests are addressed in the file.&#10;&#10;The date lease begins of rental comp# 3 is noted as Owner, please revise&#10;&#10;If addressed by comments, please verify if particular section is updated.&#10;&#10;If addressed, provide answer as revision and state corrected or not corrected. Keep it short.&#10;&#10;Below are extra points to confirm, don't address or treat as revision, just verify&#10;&#10;Also, please check if any checkboxes, or field are blank, if yes highlight in short&#10;&#10;consider below,&#10;&#10;if assignment type is refinance, then contract section should be blank, even checkboxes.&#10;&#10;If purchase, the appropriate field and checkboxes should be marked.&#10;&#10;In garage, check and validate according to checkboxes marked. &#10;&#10;Check if appraised value is matched at in total 4 locations.&#10;&#10;The signature date should be greater than effective date. Effective date is as of date.&#10;&#10;In signature page Company Name/AMC Name should include Fastapp&#10;&#10;Check for prior services, exposure comment, check is appraiser invoice is attached if yes need to remove.&#10;&#10;Please answer 1 per line not in paragraph">
                                    Common Prompt
                                </button>
                                <div class="common-prompt-details">
                                    <p><strong>This prompt includes checks for:</strong></p>
                                    <ul>
                                        <li>Specific revision requests</li>
                                        <li>Blank fields/checkboxes</li>
                                        <li>Refinance/Purchase logic</li>
                                        <li>Appraised value consistency</li>
                                        <li>Date validation (Signature vs. Effective)</li>
                                        <li>And more...</li>
                                    </ul>
                                </div>
                            </div> -->
                        </div>

                        <form action="{% url 'extract_section' filename=filename section_name='custom_analysis' %}" method="post" id="custom-analysis-form">
                            {% csrf_token %}
                            <textarea name="custom_prompt" placeholder="e.g., 'Check for any discrepancies in the Gross Living Area (GLA) across all sections of the report.'">{{ custom_prompt|default_if_none:"" }}</textarea>
                            <button type="submit" class="btn-submit">Run Custom Analysis</button>
                            <button type="button" id="finish-review-btn" class="btn-finish">Finish Review</button>
                        </form>
                    </div>
                </div>
                <div class="analysis-results-column">
                    {% if data.analysis_summary %}
                        <div class="custom-analysis-container">
                            {% if custom_prompt %}
                            <div class="query-display">
                                <p><strong>Your Query:</strong></p>
                                <p><em>{{ custom_prompt }}</em></p>
                            </div>
                            {% endif %}

                            <div class="custom-analysis-summary">
                                <p><strong>Analysis Summary:</strong></p>
                                <p>{{ data.analysis_summary }}</p>
                            </div>

                            <h4 style="margin-top: 30px;">Findings:</h4>
                            {% if data.findings %}
                                <table class="findings-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Detail</th>
                                            <th>Finding</th>
                                            <th>Source Location</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for finding in data.findings %}
                                        <tr>
                                            <td>
                                                <span class="status-{{ finding.status|lower }}">{{ finding.status|default:"Info" }}</span>
                                            </td>
                                            <td>{{ finding.finding_detail }}</td>
                                            <td class="finding-title">{{ finding.finding_title }}</td>
                                            <td class="finding-source">{{ finding.source_location }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p>No specific findings were extracted for this query.</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="placeholder-text">
                            <p>Your analysis results will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% elif section_key == 'sale_history' %}
            <div class="revision-helper-card">
                <div class="revision-helper-header">
                    <h3>Sale History Section Revision Helper</h3>
                    <button class="toggle-revision-helper-btn">Show</button>
                </div>
                <div class="revision-helper-content">
                    <p>Use this checklist to verify common revision requests for the <strong>Sale History</strong> section.</p>
                    <ul class="revision-helper-list">
                        <li>Please check that your research "Did" reveal a prior sale, as Comp 3 sold within a year.</li>
                        <li>Please check that your research "Did Not" reveal any prior sales for the comparables.</li>
                        <li>Please check that your research "Did" reveal a prior sale, as the Subject sold within 3 years.</li>
                        <li>Please check that your research "Did Not" reveal a prior sale, as the Subject has not sold within 3 years.</li>
                    </ul>
                </div>
            </div>
            <h3>Prior Sale History Grid</h3>
            {% if data.subject and data.comparables %}
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Subject</th>
                            {% for comp in data.comparables %}
                                <th>Comparable #{{ forloop.counter }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for field, subject_value in data.subject.items %}
                        <tr>
                            <td>{{ field }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                            {% for comp in data.comparables %}
                                <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                    {{ comp|get_item:field|default_if_none:"" }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
            <h3 style="margin-top: 40px;">Research and Analysis</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if key != 'subject' and key != 'comparables' %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'rental_grid' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Rental Grid Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Rental Grid (1007)</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Please have the 1007 form included in the report.</li>
                            <li>Revise subject's lease dates per the lease agreement on the 1007 form.</li>
                            <li>Provide all rental comps photos in the report.</li>
                            <li>Include the rental comparables on the location map.</li>
                            <li>The occupancy is marked as owner; however, the 1007 form says vacant. Please verify.</li>
                            <li>Revise ‘Date Lease Expires’ for rental comp as it is prior to or the same as its ‘Date Lease Begins’.</li>
                            <li>The opinion of market rent is not bracketed by the adjusted rent price of rental comps, please revise.</li>
                            <li>Please have the opinion of market rent noted on the 1007 form.</li>
                            <li>Please review the GLA adjustments made on 1007 form as they appear excessive.</li>
                            <li>Please have the ‘Date Lease Begins’ and ‘Date Lease Expires’ noted for all rental comps.</li>
                            <li>The occupancy is marked as Owner; however, the photos indicate it is vacant, and the 1007 form shows it is currently rented. Please verify/revise.</li>
                            <li>Please attach the 1007 to the original report and upload. The 1007 does not need to be separately uploaded.</li>
                            <li>Please have the 'Proximity to Subject' noted for all rental comps on the 1007 form.</li>
                            <li>Client requires a minimum of 3 closed rentals to develop market rent. Please provide additional rental comps.</li>
                            <li>The subject cannot be used as a rental comp. Please find an alternate comp.</li>
                            <li>Rental comps appear to be long-term rentals; however, their lease date is noted as “Per Night.” Please revise.</li>
                            <li>Market rent is significantly different from the current rent. Please advise.</li>
                            <li>The subject is in rent control; however, all comps used are not. Please provide a similar comp or comment.</li>
                            <li>Rental comps lease dates reflect 'Active Listing'. Please utilize a minimum of 3 closed rentals.</li>
                            <li>For rent schedule, if the order was for short-term rentals, please utilize short-term rentals to develop market rent.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Subject</th>
                        {% for comp in data.comparables %}
                            <th>Comparable #{{ forloop.counter }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for field, subject_value in data.subject.items %}
                    <tr>
                        <td>{{ field }}</td>
                        <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Subject">{{ subject_value|default_if_none:"" }}</td>
                        {% for comp in data.comparables %}
                            <td contenteditable="true" class="editable-value" data-field-name="{{ field }} - Comparable #{{ forloop.counter }}">
                                {{ comp|get_item:field|default_if_none:"" }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {# Display the summary fields at the bottom, spanning all columns #}
                    <tr>
                        <td><strong>Indicated Monthly Market Rent</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Indicated Monthly Market Rent">
                            <strong>{{ data|get_item:"Indicated Monthly Market Rent"|default_if_none:"" }}</strong>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Comments on market data...</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Comments on market data...">
                            {{ data|get_item:"Comments on market data..."|default_if_none:"" }}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Final Reconciliation of Market Rent:</strong></td>
                        <td colspan="{{ data.comparables|length|add:1 }}" contenteditable="true" class="editable-value" data-field-name="Final Reconciliation of Market Rent:">
                            {{ data|get_item:"Final Reconciliation of Market Rent:"|default_if_none:"" }}
                        </td>
                    </tr>
                </tbody>
            </table>
        {% elif section_key == 'consistancy' %}
            <table>
                <thead>
                    <tr>
                        <th>Consistency Check</th>
                        <th>Finding</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% with value_lower=value|lower %}
                        <tr class="consistency-check {% if 'mismatch' in value_lower or 'discrepancies' in value_lower %}consistency-mismatch{% else %}consistency-success{% endif %}">
                            <td class="check-title" data-field-name="{{ key }}">{{ key }}</td>
                            <td class="check-details editable-value" contenteditable="true" data-field-name="{{ key }} - Finding">
                                {{ value|default_if_none:"" }}
                            </td>
                        </tr>
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'market_conditions' %}
            <h3>Market Conditions Analysis Grid</h3>
            <table>
                <thead>
                    <tr>
                        <th>Inventory and Price Analysis</th>
                        <th>Prior 7–12 Months</th>
                        <th>Prior 4–6 Months</th>
                        <th>Current – 3 Months</th>
                        <th>Overall Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 7–12 Months">{{ value|get_item:"Prior 7–12 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 4–6 Months">{{ value|get_item:"Prior 4–6 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Current – 3 Months">{{ value|get_item:"Current – 3 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Overall Trend">{{ value|get_item:"Overall Trend"|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <h3 style="margin-top: 40px;">Additional Market Information</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if not value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'condo' %}
            <h3>Subject Project Data Grid</h3>
            <table>
                <thead>
                    <tr>
                        <th>Project Data Analysis</th>
                        <th>Prior 7–12 Months</th>
                        <th>Prior 4–6 Months</th>
                        <th>Current – 3 Months</th>
                        <th>Overall Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 7–12 Months">{{ value|get_item:"Prior 7–12 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Prior 4–6 Months">{{ value|get_item:"Prior 4–6 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Current – 3 Months">{{ value|get_item:"Current – 3 Months"|default_if_none:"" }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }} - Overall Trend">{{ value|get_item:"Overall Trend"|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <h3 style="margin-top: 40px;">Additional Condo Information</h3>
            <table>
                <tbody>
                    {% for key, value in data.items %}
                        {% if not value|is_dict %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'client_lender_requirements' %}
            <table>
                <thead>
                    <tr>
                        <th>Client Requirement Check</th>
                        <th>Finding</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        {% if 'N/A - Rule does not apply' not in value %}
                            {% with value_lower=value|lower %}
                            <tr class="consistency-check {% if 'fail' in value_lower or 'mismatch' in value_lower %}consistency-mismatch{% else %}consistency-success{% endif %}">
                                <td class="check-title">{{ key }}</td>
                                <td class="check-details editable-value" contenteditable="true" data-field-name="{{ key }} - Finding">{{ value|default_if_none:"" }}</td>
                            </tr>
                            {% endwith %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% elif section_key == 'cost_approach' %}
            {% if show_revision_helper %}
                <div class="revision-helper-card">
                    <div class="revision-helper-header">
                        <h3>Cost Approach Section Revision Helper</h3>
                        <button class="toggle-revision-helper-btn">Show</button>
                    </div>
                    <div class="revision-helper-content">
                        <p>Use this checklist to verify common revision requests for the <strong>Cost Approach</strong> section.</p>
                        <ul class="revision-helper-list">
                            <li>Please include the ‘OPINION OF SITE VALUE’ in the report.</li>
                            <li>Please include the ‘Estimated Remaining Economic Life’ in the report.</li>
                            <li>Please revise the conflicting comment noted on page# 4 which reads “Estimated remaining economic life: 59 Years.” However the same section also comment noted as ‘remaining economic life of 60 years’</li>
                            <li>Please develop the cost approach section of the report per client requirement.</li>
                            <li>1004C: Fannie Mae requires appraisers to complete the cost approach for all manufactured homes. Please include the cost approach.</li>
                            <li>Please have the appropriate checkbox marked in the cost approach section. (i.e. REPRODUCTION OR REPLACEMENT COST NEW)</li>
                            <li>For BPL only: This client requires the Cost Approach to be completed. Even if this approach is not weighted in determining value, it must be completed.</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)</td><td contenteditable="true" class="editable-value" data-field-name="Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)">{{ data|get_item:"Support for the opinion of site value (summary of comparable land sales or other methods for estimating site value)"|default_if_none:"" }}</td></tr>
                    <tr><td>Source of cost data</td><td contenteditable="true" class="editable-value" data-field-name="Source of cost data">{{ data|get_item:"Source of cost data"|default_if_none:"" }}</td></tr>
                    <tr><td>Quality rating from cost service</td><td contenteditable="true" class="editable-value" data-field-name="Quality rating from cost service">{{ data|get_item:"Quality rating from cost service"|default_if_none:"" }}</td></tr>
                    <tr><td>Effective date of cost data</td><td contenteditable="true" class="editable-value" data-field-name="Effective date of cost data">{{ data|get_item:"Effective date of cost data"|default_if_none:"" }}</td></tr>
                    
                    <tr style="background-color: #f9fafb;"><td colspan="2" style="padding: 8px;"></td></tr>

                    <tr><td>Opinion of Site Value</td><td contenteditable="true" class="editable-value" data-field-name="Opinion of Site Value">{{ data|get_item:"Opinion of Site Value"|default_if_none:"" }}</td></tr>
                    
                    <tr><td>ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)</td><td contenteditable="true" class="editable-value" data-field-name="ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)">{{ data|get_item:"ESTIMATED (REPRODUCTION / REPLACEMENT COST NEW)"|default_if_none:"" }}</td></tr>
                    
                    <tr><td>Dwelling</td><td contenteditable="true" class="editable-value" data-field-name="Dwelling">{{ data|get_item:"Dwelling"|default_if_none:"" }}</td></tr>
                    <tr><td>Garage/Carport</td><td contenteditable="true" class="editable-value" data-field-name="Garage/Carport">{{ data|get_item:"Garage/Carport"|default_if_none:"" }}</td></tr>
                    <tr><td><strong>Total Estimate of Cost-New</strong></td><td contenteditable="true" class="editable-value" data-field-name="Total Estimate of Cost-New"><strong>{{ data|get_item:"Total Estimate of Cost-New"|default_if_none:"" }}</strong></td></tr>
                    
                    <tr style="background-color: #f9fafb;"><td colspan="2" style="padding: 8px;"></td></tr>

                    <tr><td>Depreciation</td><td contenteditable="true" class="editable-value" data-field-name="Depreciation">{{ data|get_item:"Depreciation"|default_if_none:"" }}</td></tr>
                    <tr><td><strong>Depreciated Cost of Improvements</strong></td><td contenteditable="true" class="editable-value" data-field-name="Depreciated Cost of Improvements"><strong>{{ data|get_item:"Depreciated Cost of Improvements"|default_if_none:"" }}</strong></td></tr>
                    <tr><td>As-is Value of Site Improvements</td><td contenteditable="true" class="editable-value" data-field-name="As-is Value of Site Improvements">{{ data|get_item:"As-is Value of Site Improvements"|default_if_none:"" }}</td></tr>
                    
                    <tr style="background-color: #f3f4f6;">
                        <td><strong>Indicated Value By Cost Approach</strong></td>
                        <td contenteditable="true" class="editable-value" data-field-name="Indicated Value By Cost Approach"><strong>{{ data|get_item:"Indicated Value By Cost Approach"|default_if_none:"" }}</strong></td>
                    </tr>
                    <tr><td>Comments on Cost Approach (gross living area calculations, depreciation, etc.)</td><td contenteditable="true" class="editable-value" data-field-name="Comments on Cost Approach (gross living area calculations, depreciation, etc.)">{{ data|get_item:"Comments on Cost Approach (gross living area calculations, depreciation, etc.)"|default_if_none:"" }}</td></tr>
                    <tr><td>Estimated Remaining Economic Life (HUD and VA only)</td><td contenteditable="true" class="editable-value" data-field-name="Estimated Remaining Economic Life (HUD and VA only)">{{ data|get_item:"Estimated Remaining Economic Life (HUD and VA only)"|default_if_none:"" }}</td></tr>
                </tbody>
            </table>
        {% else %}
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in data.items %}
                        <tr>
                            <td>{{ key }}</td>
                            <td contenteditable="true" class="editable-value" data-field-name="{{ key }}">{{ value|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <script>
    /* ================= Django → JS Safe Variable ================= */
    const sectionKey = "{{ section_key }}";
    const filename = "{{ filename }}";

    /* ================= DOM READY ================= */
    document.addEventListener('DOMContentLoaded', function () {

        // Delay to ensure table is rendered
        setTimeout(runValidations, 0);

        // Custom Analysis Section Logic
        const customForm = document.getElementById('custom-analysis-form');
        if (customForm) {
            // Prompt Suggestions
            const promptBtns = document.querySelectorAll('.prompt-suggestion-btn');
            const customTextarea = customForm.querySelector('textarea[name="custom_prompt"]');
            
            promptBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    if (customTextarea) {
                        customTextarea.value = prompt;
                        customTextarea.focus();
                    }
                });
            });

            // Loader on Submit
            customForm.addEventListener('submit', function() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            });
        }

        // Finish Review Button
        const finishBtn = document.getElementById('finish-review-btn');
        if (finishBtn) {
            finishBtn.addEventListener('click', function() {
                window.location.href = "{% url 'upload_pdf' %}";
            });
        }

        // Timer logic
        const timerDisplay = document.getElementById('review-timer');
        if (timerDisplay) {
            let startTime = sessionStorage.getItem('reviewStartTime');
            if (!startTime) {
                startTime = Date.now();
                sessionStorage.setItem('reviewStartTime', startTime);
            }
            function updateTimer() {
                const now = Date.now();
                const elapsed = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const secs = elapsed % 60;
                timerDisplay.textContent =
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(secs).padStart(2, '0');
            }
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Validate Button
        const validateBtn = document.getElementById('validate-btn');
        if (validateBtn) {
            validateBtn.addEventListener('click', runValidations);
        }

        async function runValidations() {

            const validationContainer = document.getElementById('validation-container');
            if (!validationContainer) return;
            validationContainer.innerHTML = '';

            /* Get ALL rows safely (works for all sections) */
            const tableRows = document.querySelectorAll('table tr');
            if (!tableRows.length && sectionKey !== 'custom_analysis') return;

            /* ================= Utilities ================= */

            const normalize = (text) =>
                (text || '')
                    .replace(/\s+/g, ' ')
                    .replace(':', '')
                    .trim()
                    .toLowerCase();

            const getFieldValue = (fieldName) => {
                const key = normalize(fieldName);
                // Try exact match first
                let row = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent) === key;
                });
                // Fallback to includes
                if (!row) {
                    row = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent).includes(key);
                });
                }
                const valueText = row?.querySelector('td:last-child')?.textContent;
                return valueText ? valueText.trim() : null;
            };

            const addMessage = (type, message) => {
                const div = document.createElement('div');
                div.className = `validation-message validation-${type}`;
                div.innerHTML = message;
                validationContainer.appendChild(div);
            };

            const isEmpty = (val) => !val || val === '--' || val === 'null' || val === 'N/A' || val.trim() === '';
            
            const normalizeNumericValue = (val) => {
                if (isEmpty(val)) return null;
                const cleaned = String(val).replace(/[$,]/g, '').trim();
                const num = parseFloat(cleaned);
                return isNaN(num) ? null : num;
            };

            const parseDate = (dateStr) => {
                if (isEmpty(dateStr)) return null;
                
                const cleanedDateStr = String(dateStr).trim();

                // Regex for MM/DD/YYYY or M/D/YYYY
                let parts = cleanedDateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (parts) {
                    // new Date(year, monthIndex, day) - handles timezone correctly for UTC comparison
                    return new Date(Date.UTC(parts[3], parts[1] - 1, parts[2]));
                }

                // Regex for YYYY-MM-DD
                parts = cleanedDateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                if (parts) {
                    return new Date(Date.UTC(parts[1], parts[2] - 1, parts[3]));
                }

                // Regex for MM-DD-YYYY
                parts = cleanedDateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
                if (parts) {
                    return new Date(Date.UTC(parts[3], parts[1] - 1, parts[2]));
                }

                // Try generic parsing as a fallback
                const genericDate = new Date(cleanedDateStr);
                if (!isNaN(genericDate.getTime())) {
                    return genericDate;
                }

                return null; // Return null if no format matches
            };
            /* ==========================================================
            ================= SUBJECT VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'subject') {
                // Clear session storage flags on subject load
                sessionStorage.removeItem('isPurchaseTransaction');
                sessionStorage.removeItem('isRefinanceTransaction');
                sessionStorage.removeItem('isPUD');
                sessionStorage.removeItem('subjectLenderClient');
                sessionStorage.removeItem('subjectLenderAddress');
                sessionStorage.removeItem('subjectFullAddress');
                sessionStorage.removeItem('subjectState');
                sessionStorage.removeItem('isFhaCase');

                const assignmentType = getFieldValue('assignment type');
                const lenderClient = getFieldValue('lender/client');
                const state = getFieldValue('state');
                const pudValue = getFieldValue('pud');
                const offeredForSale = getFieldValue('offered for sale in last 12 months');

                // Store flags
                if (assignmentType) {
                    if (assignmentType.toLowerCase().includes('purchase')) sessionStorage.setItem('isPurchaseTransaction', 'true');
                    if (assignmentType.toLowerCase().includes('refinance')) sessionStorage.setItem('isRefinanceTransaction', 'true');
                }
                if (lenderClient && !isEmpty(lenderClient)) sessionStorage.setItem('subjectLenderClient', lenderClient);
                if (state && !isEmpty(state)) sessionStorage.setItem('subjectState', state.toUpperCase());

                // 1. Required Fields Check
                const requiredFields = [
                    'Property Address', 'City', 'County', 'State', 'Zip Code', 
                    'Borrower', 'Owner of Public Record', 'Legal Description', 
                    "Assessor's Parcel #", 'Tax Year', 'R.E. Taxes $', 
                    'Neighborhood Name', 'Map Reference', 'Census Tract', 
                    'Occupant', 'Special Assessments $', 'PUD', 
                    'Property Rights Appraised', 'Assignment Type', 
                    'Lender/Client', 'Address (Lender/Client)', 
                    'Offered for Sale in Last 12 Months',
                    'ANSI Standard Confirmation', 'Reasonable Exposure Time Comment', 
                    'Prior Service Certification'
                ];

                const missingFields = [];
                requiredFields.forEach(field => {
                    const val = getFieldValue(field);
                    if (isEmpty(val)) {
                        missingFields.push(field);
                    }
                });

                if (missingFields.length > 0) {
                    addMessage('error', `⚠️ The following required fields are blank: ${missingFields.join(', ')}.`);
                } else {
                    addMessage('success', "✅ All required fields are present.");
                }

                // R.E. Taxes Validation
                const reTaxes = getFieldValue('R.E. Taxes $');
                if (!isEmpty(reTaxes)) {
                    const taxVal = normalizeNumericValue(reTaxes);
                    if (taxVal !== null && Math.floor(taxVal).toString().length > 4) {
                        addMessage('error', `⚠️ 'R.E. Taxes $' value (${reTaxes}) exceeds 4 digits (excluding decimals).`);
                    }
                }

                // 2. Assignment Type Logic
                if (sessionStorage.getItem('isPurchaseTransaction')) {
                    addMessage(
                        'warning',
                        "⚠️ Assignment Type is Purchase Transaction. Please ensure the 'Contract' section is filled."
                    );
                } else if (sessionStorage.getItem('isRefinanceTransaction')) {
                    addMessage(
                        'info',
                        "ℹ️ Assignment Type is Refinance Transaction. The 'Contract' section should be blank."
                    );
                }

                // 3. Address Consistency
                const addressParts = [
                    getFieldValue('property address'),
                    getFieldValue('city'),
                    getFieldValue('state'),
                    getFieldValue('zip code')
                ];

                if (addressParts.every(p => !isEmpty(p))) {
                    const fullAddr = addressParts.join(', ');
                    sessionStorage.setItem('subjectFullAddress', fullAddr);
                    addMessage(
                        'warning',
                        `ℹ️ Address Consistency: Verify that "${fullAddr}" matches the Sales Grid, Location Map, Aerial Map, and Subject Photos.`
                    );
                }

                // 4. PUD Validation
                if (pudValue && pudValue.toLowerCase() === 'yes') {
                    sessionStorage.setItem('isPUD', 'true');
                    const hoaAmt = normalizeNumericValue(getFieldValue('hoa $'));
                    const hoaTerm = getFieldValue('hoa(per year/per month)');
                    
                    if (hoaAmt !== null && hoaAmt > 0 && !isEmpty(hoaTerm)) {
                        addMessage('success', "✅ PUD is 'Yes': HOA $ is > 0 and terms are filled.");
                    } else {
                        addMessage('error', "⚠️ PUD is 'Yes': Verify that 'HOA $' is a number > 0 and 'HOA(per year/per month)' is filled.");
                    }
                    addMessage('warning', "ℹ️ PUD is 'Yes'. Ensure 'PUD Info' section is filled.");
                }

                // 5. Offered for Sale Details
                if (offeredForSale && offeredForSale.toLowerCase() === 'yes') {
                    const details = getFieldValue('report data source(s) used'); // Maps to 'Report data source(s) used, offering price(s), and date(s)'
                    if (isEmpty(details)) {
                        addMessage('error', "⚠️ 'Offered for Sale' is 'Yes' but details are missing.");
                    } else {
                        const detailsLower = details.toLowerCase();
                        const hasDOM = detailsLower.includes('dom') || detailsLower.includes('days on market');
                        const hasListingDate = detailsLower.includes('listing date') || detailsLower.includes('listed');
                        const hasMLS = detailsLower.includes('mls');

                        if (hasDOM && hasListingDate && hasMLS) {
                            addMessage('success', "✅ 'Offered for Sale' details include DOM, Listing Date, and MLS.");
                        } else {
                            let missing = [];
                            if (!hasDOM) missing.push("DOM");
                            if (!hasListingDate) missing.push("Listing Date");
                            if (!hasMLS) missing.push("MLS");
                            addMessage('error', `⚠️ 'Offered for Sale' is 'Yes' but missing details: ${missing.join(', ')}.`);
                        }
                    }
                }

                /* FHA */
                const fhaValue = getFieldValue('fha');
                if (fhaValue && !isEmpty(fhaValue)) {
                    sessionStorage.setItem('isFhaCase', 'true');
                    addMessage(
                        'warning',
                        "ℹ️ FHA case detected. Review FHA instructions in Custom Analysis section."
                    );
                }

                /* State */
                if (!isEmpty(state)) {
                    addMessage(
                        'success',
                        `✅ Subject property state detected: ${state}`
                    );
                }
            }

            /* ==========================================================
            ================= BASE INFO VALIDATIONS ==================
            ========================================================== */
            if (sectionKey === 'base_info') {

                const appraisalFormType = getFieldValue('appraisal form type');
                const additionalForm = getFieldValue('additional form');
                const ansiValue = getFieldValue('ansi standard confirmation')?.toLowerCase();
                const exposureComment = getFieldValue('reasonable exposure time');
                const priorService = getFieldValue('prior service certification')?.toLowerCase();

                /* Appraisal Form Type */
                if (isEmpty(appraisalFormType)) {
                    addMessage('error', "⚠️ 'APPRAISAL FORM TYPE' cannot be blank.");
                } else {
                    const validForms = ['1004', '1025', '1004d', '1073'];
                    if (!validForms.some(v => appraisalFormType.toLowerCase().includes(v))) {
                        addMessage('error', `⚠️ Invalid APPRAISAL FORM TYPE: ${appraisalFormType}`);
                    } else {
                        addMessage('success', `✅ APPRAISAL FORM TYPE: ${appraisalFormType}`);
                    }
                }

                /* Additional Form */
                if (isEmpty(additionalForm)) {
                    addMessage('error', "⚠️ 'Additional Form' cannot be blank.");
                } else {
                    const validAdditional = ['1007', '216', 'rental', 'str', 'none'];
                    if (!validAdditional.some(v => additionalForm.toLowerCase().includes(v))) {
                        addMessage('error', `⚠️ Invalid Additional Form: ${additionalForm}`);
                    } else {
                        addMessage('success', `✅ Additional Form: ${additionalForm}`);
                    }
                }

                /* ANSI */
                if (ansiValue === 'did' || ansiValue === 'did not') {
                    addMessage('success', `✅ ANSI Standard Confirmation: ${ansiValue}`);
                } else {
                    addMessage('error', "⚠️ ANSI Standard Confirmation must be 'did' or 'did not'.");
                }

                /* Exposure Time */
                if (!isEmpty(exposureComment)) {
                    addMessage('success', "✅ Reasonable Exposure Time Comment present.");
                } else {
                    addMessage('error', "⚠️ Reasonable Exposure Time Comment cannot be blank.");
                }

                /* Prior Service */
                if (priorService === 'have' || priorService === 'have not') {
                    addMessage('success', `✅ Prior Service Certification: ${priorService}`);
                } else {
                    addMessage('error', "⚠️ Prior Service Certification must be 'have' or 'have not'.");
                }
            }

            /* ==========================================================
            ================= CONTRACT VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'contract') {
                // Refinance Check
                if (sessionStorage.getItem('isRefinanceTransaction') === 'true') {
                    let hasValue = false;
                    const nonEmptyFields = [];
                    tableRows.forEach(row => {
                        const val = row.querySelector('td:last-child')?.textContent;
                        if (!isEmpty(val)) {
                            hasValue = true;
                            nonEmptyFields.push(row.querySelector('td:first-child')?.textContent.trim());
                        }
                    });
                    
                    if (hasValue) {
                        addMessage('error', `⚠️ Refinance Transaction: Contract section should be blank. Found values in: ${nonEmptyFields.join(', ')}.`);
                    } else {
                        addMessage('success', "✅ Refinance Transaction: Contract section is blank.");
                    }
                } 
                
                // Purchase Transaction Checks
                if (sessionStorage.getItem('isPurchaseTransaction') === 'true') {
                    // Contract Analysis
                    const analysis = getFieldValue('analyze the contract');
                    if (analysis && analysis.toLowerCase() === 'did') {
                        addMessage('success', "✅ Contract analysis marked 'did'.");
                    } else {
                        addMessage('error', "⚠️ Purchase Transaction: 'I _____ analyze the contract...' must be marked 'did'.");
                    }
                    
                    // Financial Assistance
                    const assistance = getFieldValue('financial assistance'); // Matches 'Is there any financial assistance...'
                    const assistanceDetails = getFieldValue('report the total dollar amount'); // Matches 'If Yes, report...'

                    if (assistance && assistance.toLowerCase() === 'yes') {
                        if (isEmpty(assistanceDetails)) {
                            addMessage('error', "⚠️ Financial Assistance is 'Yes', but details are missing.");
                        } else {
                            // Check for dollar amount and description
                            const hasDollar = /[\d]+/.test(assistanceDetails) || /\$/.test(assistanceDetails);
                            const hasText = /[a-zA-Z]+/.test(assistanceDetails);
                            
                            if (hasDollar && hasText) {
                                addMessage('success', "✅ Financial Assistance details include dollar amount and description.");
                            } else {
                                addMessage('error', "⚠️ Financial Assistance is 'Yes': Details must contain both a dollar amount and a description.");
                            }
                        }
                    } else if (assistance && assistance.toLowerCase() === 'no') {
                        if (isEmpty(assistanceDetails) || assistanceDetails.trim() === '$0;;') {
                            addMessage('success', "✅ Financial Assistance is 'No' and details are blank (or '$0;;').");
                        } else {
                            addMessage('error', `⚠️ Financial Assistance is 'No', but details field has value: '${assistanceDetails}'. Should be blank.`);
                        }
                    }
                }
            }

            /* ==========================================================
            ================= NEIGHBORHOOD VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'neighborhood') {
                const oneUnit = normalizeNumericValue(getFieldValue('one-unit')) || 0;
                const twoFour = normalizeNumericValue(getFieldValue('2-4 unit')) || 0;
                const multi = normalizeNumericValue(getFieldValue('multi-family')) || 0;
                const comm = normalizeNumericValue(getFieldValue('commercial')) || 0;
                const other = normalizeNumericValue(getFieldValue('other')) || 0;
                
                const total = oneUnit + twoFour + multi + comm + other;
                if (Math.abs(total - 100) > 0.1) {
                    addMessage('error', `⚠️ Land Use Sum is ${total}%, should be 100%.`);
                } else {
                    addMessage('success', `✅ Land Use Sum is 100%.`);
                }

                if (other > 0 && isEmpty(getFieldValue('present land use other description'))) {
                    addMessage('error', "⚠️ 'Other' land use > 0% but description is missing.");
                }

                // Boundaries
                const boundaries = getFieldValue('neighborhood boundaries');
                if (isEmpty(boundaries)) {
                    addMessage('error', "⚠️ 'Neighborhood Boundaries' cannot be blank.");
                } else {
                    const boundariesLower = boundaries.toLowerCase();
                    const directions = ['north', 'south', 'east', 'west'];
                    const missingDirections = directions.filter(d => !boundariesLower.includes(d));
                    
                    if (missingDirections.length > 0) {
                        addMessage('error', `⚠️ 'Neighborhood Boundaries' missing directional words: ${missingDirections.join(', ')}.`);
                    } else {
                        addMessage('success', "✅ 'Neighborhood Boundaries' includes all directional words.");
                    }

                    if (boundaries.length < 50) {
                        addMessage('warning', "⚠️ 'Neighborhood Boundaries' description is short (< 50 chars). Ideally should be more detailed.");
                    }
                }
            }

            /* ==========================================================
            ================= SITE VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'site') {
                // 1. Required Fields
                const requiredFields = [
                    'Dimensions', 'Area', 'Shape', 'View', 
                    'Specific Zoning Classification', 'Zoning Description'
                ];
                const missingFields = [];
                
                requiredFields.forEach(field => {
                    if (isEmpty(getFieldValue(field))) {
                        missingFields.push(field);
                    }
                });

                if (missingFields.length > 0) {
                    addMessage('error', `⚠️ The following required fields are blank: ${missingFields.join(', ')}.`);
                } else {
                    addMessage('success', "✅ All required fields (Dimensions, Area, Shape, View, Zoning) are present.");
                }

                // 2. Utilities Typical
                const utilitiesTypical = getFieldValue('utilities and off-site improvements typical');
                if (isEmpty(utilitiesTypical)) {
                    addMessage('error', "⚠️ 'Utilities typical for market area' must be marked 'Yes' or 'No'.");
                } else if (utilitiesTypical.toLowerCase() === 'yes') {
                    addMessage('success', "✅ Utilities are typical for the market area.");
                } else if (utilitiesTypical.toLowerCase() === 'no') {
                    addMessage('warning', "⚠️ Utilities are marked 'No' (not typical). Verify explanation.");
                }

                // 3. Adverse Conditions
                const adverse = getFieldValue('adverse site conditions');
                if (isEmpty(adverse)) {
                    addMessage('error', "⚠️ 'Adverse Site Conditions' must be marked 'Yes' or 'No'.");
                } else if (adverse.toLowerCase() === 'no') {
                    addMessage('success', "✅ No adverse site conditions reported.");
                } else if (adverse.toLowerCase() === 'yes') {
                    addMessage('warning', "⚠️ Adverse site conditions marked 'Yes'. Verify description.");
                }

                const zoning = getFieldValue('zoning compliance');
                const highestBest = getFieldValue('highest and best use');
                const area = getFieldValue('area');

                if (zoning === 'Illegal') addMessage('error', "<strong>⚠️ CRITICAL: Zoning Compliance is 'Illegal'.</strong>");
                else if (zoning && !isEmpty(zoning)) addMessage('success', `✅ Zoning Compliance: ${zoning}`);
                else if (isEmpty(zoning)) addMessage('error', "⚠️ Zoning Compliance missing.");

                if (highestBest && highestBest.toLowerCase() === 'no') addMessage('error', "<strong>⚠️ CRITICAL: Highest and Best Use is 'No'.</strong>");
                
                if (area) {
                    const areaNum = normalizeNumericValue(area);
                    if (areaNum > 43500 && !area.toLowerCase().includes('ac')) {
                        addMessage('warning', `⚠️ Area is ${area}. Consider using Acres (AC) for > 43,500 sq ft.`);
                    }
                }
            }

            /* ==========================================================
            ================= IMPROVEMENTS VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'improvements') {
                // 1. General Description & Required Fields
                const generalRequired = [
                    'Units', 'Type', '# of Stories', 'Existing/Proposed/Under Const.', 
                    'Design (Style)', 'Year Built', 'Effective Age (Yrs)'
                ];
                const missingGeneral = generalRequired.filter(f => isEmpty(getFieldValue(f)));
                
                if (missingGeneral.length > 0) {
                    addMessage('error', `⚠️ Missing General Description fields: ${missingGeneral.join(', ')}.`);
                } else {
                    addMessage('success', "✅ General Description fields are complete.");
                }

                // 2. Improvement Status Storage
                sessionStorage.removeItem('improvementStatus');
                const status = getFieldValue('existing/proposed/under const.');
                if (status) {
                    if (status.split(/[/,]/).length > 1) {
                        addMessage('error', "⚠️ Select only one status (Existing/Proposed/Under Const).");
                    } else {
                        sessionStorage.setItem('improvementStatus', status.toLowerCase());
                        addMessage('info', `ℹ️ Status: ${status}`);
                    }
                }

                const dwellingType = getFieldValue('type');
                if (dwellingType && !isEmpty(dwellingType)) {
                    sessionStorage.setItem('dwellingType', dwellingType.toLowerCase());
                    addMessage('info', `ℹ️ Dwelling Type: ${dwellingType}`);
                }

                // 3. Foundation & Basement
                const foundation = getFieldValue('foundation type');
                const bsmtArea = normalizeNumericValue(getFieldValue('basement area sq.ft.'));
                
                if (foundation) {
                    const fLower = foundation.toLowerCase();
                    if (fLower.includes('slab') && fLower.includes('crawl')) {
                        addMessage('error', "⚠️ Foundation Type conflict: Selected both 'Slab' and 'Crawl Space'.");
                    }
                    if (fLower.includes('slab') && bsmtArea > 0) {
                        addMessage('error', `⚠️ Foundation is 'Slab' but Basement Area is ${bsmtArea} sq.ft.`);
                    }
                }

                // 4. Material/Condition
                const conditionFields = [
                    'Foundation Walls (Material/Condition)', 'Exterior Walls (Material/Condition)', 
                    'Roof Surface (Material/Condition)', 'Gutters & Downspouts (Material/Condition)', 
                    'Window Type (Material/Condition)', 'Floors (Material/Condition)', 
                    'Walls (Material/Condition)', 'Trim/Finish (Material/Condition)', 
                    'Bath Floor (Material/Condition)', 'Bath Wainscot (Material/Condition)'
                ];
                const validConditions = ['good', 'average', 'fair', 'poor', 'c1', 'c2', 'c3', 'c4', 'c5', 'c6'];
                
                conditionFields.forEach(field => {
                    const val = getFieldValue(field);
                    if (!isEmpty(val)) {
                        const parts = val.split('/');
                        if (parts.length > 1) {
                            const condition = parts[parts.length - 1].trim().toLowerCase();
                            if (!validConditions.some(vc => condition.includes(vc))) {
                                addMessage('warning', `⚠️ '${field}' condition '${parts[parts.length - 1]}' might not be standard.`);
                            }
                        }
                    }
                });

                // 5. Heating/Cooling
                const heating = getFieldValue('heating type');
                const cooling = getFieldValue('cooling type');
                if (heating && heating.toLowerCase().includes('other') && heating.length < 10) {
                     addMessage('warning', "⚠️ Heating Type is 'Other' but description seems missing or short.");
                }
                if (cooling && cooling.toLowerCase().includes('other') && cooling.length < 10) {
                     addMessage('warning', "⚠️ Cooling Type is 'Other' but description seems missing or short.");
                }

                // 6. Car Storage
                const carStorage = getFieldValue('car storage');
                const drivewayCount = normalizeNumericValue(getFieldValue('driveway # of cars'));
                const garageCount = normalizeNumericValue(getFieldValue('garage # of cars'));
                const carportCount = normalizeNumericValue(getFieldValue('carport # of cars'));

                if (carStorage) {
                    const csLower = carStorage.toLowerCase();
                    if (csLower.includes('driveway') && (!drivewayCount || drivewayCount <= 0)) {
                        addMessage('error', "⚠️ 'Driveway' selected but count is 0 or missing.");
                    }
                    if (csLower.includes('garage') && (!garageCount || garageCount <= 0)) {
                        addMessage('error', "⚠️ 'Garage' selected but count is 0 or missing.");
                    }
                    if (csLower.includes('carport') && (!carportCount || carportCount <= 0)) {
                        addMessage('error', "⚠️ 'Carport' selected but count is 0 or missing.");
                    }
                    if (csLower.includes('none')) {
                        if ((drivewayCount && drivewayCount > 0) || (garageCount && garageCount > 0) || (carportCount && carportCount > 0)) {
                            addMessage('error', "⚠️ 'None' selected for Car Storage but counts are present.");
                        }
                    }
                }

                // 7. Room Counts & GLA
                const roomCounts = [
                    'Finished area above grade Rooms', 'Finished area above grade Bedrooms',
                    'Finished area above grade Bath(s)', 'Square Feet of Gross Living Area Above Grade'
                ];
                const missingRooms = roomCounts.filter(f => isEmpty(getFieldValue(f)));
                if (missingRooms.length > 0) {
                    addMessage('error', `⚠️ Missing Room Count/GLA fields: ${missingRooms.join(', ')}.`);
                } else {
                    addMessage('success', "✅ Room counts and GLA are present.");
                }

                // 8. Property Condition
                const conditionDesc = getFieldValue('describe the condition of the property');
                if (isEmpty(conditionDesc)) {
                    addMessage('error', "⚠️ Property condition description is missing.");
                } else {
                    const cRatings = ['c1', 'c2', 'c3', 'c4', 'c5', 'c6'];
                    const foundRating = cRatings.find(r => conditionDesc.toLowerCase().includes(r));
                    
                    if (!foundRating) {
                        addMessage('warning', "⚠️ Condition description does not explicitly state a C-rating (C1-C6).");
                    } else {
                        if (foundRating === 'c5' || foundRating === 'c6') {
                            addMessage('error', `⚠️ CRITICAL: Property condition is rated ${foundRating.toUpperCase()}. This may impact loan eligibility.`);
                        } else {
                            addMessage('success', `✅ Property condition rated ${foundRating.toUpperCase()}.`);
                        }
                    }
                }

                // 9. Physical Deficiencies
                const deficiencies = getFieldValue('are there any physical deficiencies or adverse conditions that affect the livability, soundness, or structural integrity of the property?');
                if (deficiencies && deficiencies.toLowerCase() === 'yes') {
                    const defDesc = getFieldValue('if yes, describe');
                    if (isEmpty(defDesc)) {
                        addMessage('error', "⚠️ Physical deficiencies marked 'Yes' but description is missing.");
                    } else {
                        addMessage('warning', "⚠️ Physical deficiencies marked 'Yes'. Verify description.");
                    }
                }

                // 10. Neighborhood Conformity
                const conformity = getFieldValue('does the property generally conform to the neighborhood (functional utility, style, condition, use, construction, etc.)?');
                if (conformity && conformity.toLowerCase() === 'no') {
                    const confDesc = getFieldValue('if no, describe');
                    if (isEmpty(confDesc)) {
                        addMessage('error', "⚠️ Property does not conform to neighborhood, but description is missing.");
                    } else {
                        addMessage('success', "✅ Property does not conform, description provided.");
                    }
                }
            }

            /* ==========================================================
            ================= SALES GRID VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'sales_grid') {
                // Find indicated value row specifically
                const indicatedRow = Array.from(tableRows).find(r => r.querySelector('td:first-child')?.textContent.includes('Indicated Value by Sales Comparison Approach'));
                if (indicatedRow) {
                    const val = indicatedRow.querySelector('td:last-child')?.textContent.trim();
                    if (val) {
                        sessionStorage.setItem('salesGridIndicatedValue', val);
                        addMessage('info', `ℹ️ Stored Indicated Value: ${val}`);
                    }
                }

                // Net and Gross Adjustment Validation
                const salePriceRow = Array.from(tableRows).find(r => normalize(r.querySelector('td:first-child').textContent) === 'sale price');
                const netAdjRow = Array.from(tableRows).find(r => normalize(r.querySelector('td:first-child').textContent) === 'net adjustment (total)');
                
                // Find all individual adjustment rows (excluding Net Adjustment)
                const adjustmentRows = Array.from(tableRows).filter(r => {
                    const label = normalize(r.querySelector('td:first-child').textContent);
                    return label.includes('adjustment') && label !== 'net adjustment (total)';
                });

                if (salePriceRow && netAdjRow) {
                    const cells = salePriceRow.querySelectorAll('td');
                    // Columns: 0=Feature, 1=Subject, 2=Comp1, 3=Comp2...
                    // We iterate starting from index 2 (Comparables)
                    for (let i = 2; i < cells.length; i++) {
                        const compIndex = i - 1; // 1-based index for display
                        
                        const salePriceVal = normalizeNumericValue(cells[i].textContent);
                        const netAdjVal = normalizeNumericValue(netAdjRow.querySelectorAll('td')[i]?.textContent);

                        if (salePriceVal && salePriceVal > 0) {
                            // Check Net Adjustment > 15%
                            if (netAdjVal !== null) {
                                const netPct = (Math.abs(netAdjVal) / salePriceVal) * 100;
                                if (netPct > 15) {
                                    addMessage('warning', `⚠️ Comparable #${compIndex}: Net Adjustment (${netPct.toFixed(1)}%) exceeds 15% of Sale Price.`);
                                }
                            }

                            // Calculate and Check Gross Adjustment > 25%
                            let grossAdj = 0;
                            adjustmentRows.forEach(row => {
                                const val = normalizeNumericValue(row.querySelectorAll('td')[i]?.textContent);
                                if (val !== null) grossAdj += Math.abs(val);
                            });
                            const grossPct = (grossAdj / salePriceVal) * 100;
                            if (grossPct > 25) {
                                addMessage('warning', `⚠️ Comparable #${compIndex}: Gross Adjustment (${grossPct.toFixed(1)}%) exceeds 25% of Sale Price.`);
                            }
                        }
                    }
                }
            }

            /* ==========================================================
            ================= RECONCILIATION VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'reconciliation') {
                // Store effective date for other sections to use
                const effDate = getFieldValue('effective date of value');
                if (effDate) sessionStorage.setItem('reconciliationEffectiveDate', effDate);

                // 1. Status Consistency Check
                const improvementStatus = sessionStorage.getItem('improvementStatus');
                const appraisalMadeAs = getFieldValue("this appraisal is made ('as is'").toLowerCase();

                if (improvementStatus) {
                    if (improvementStatus.includes('existing')) {
                        if (appraisalMadeAs.includes('as is')) {
                            addMessage('success', "✅ Status Consistency: 'Existing' improvement status matches 'as is' appraisal condition.");
                        } else {
                            addMessage('error', `⚠️ Status Inconsistency: Improvement status is 'Existing', but appraisal condition is not 'as is' (it's '${appraisalMadeAs}').`);
                        }
                    } else if (improvementStatus.includes('proposed') || improvementStatus.includes('under const')) {
                        if (appraisalMadeAs.includes('subject to')) {
                            addMessage('success', "✅ Status Consistency: 'Proposed/Under Const.' status matches 'subject to' appraisal condition.");
                        } else {
                            addMessage('error', `⚠️ Status Inconsistency: Improvement status is '${improvementStatus}', but appraisal condition is not 'subject to...' (it's '${appraisalMadeAs}').`);
                        }
                    }
                } else {
                    addMessage('warning', "⚠️ Could not verify status consistency. Improvement status not found from Improvements section.");
                }

                // 2. "Four Value Check"
                async function fourValueCheck() {
                    const salesGridVal = normalizeNumericValue(sessionStorage.getItem('salesGridIndicatedValue'));
                    const reconSalesVal = normalizeNumericValue(getFieldValue('indicated value by: sales comparison approach $'));
                    const reconOpinionVal = normalizeNumericValue(getFieldValue('opinion of market value $'));
                    
                    let certAppraisedVal = null;
                    let certDataError = null;

                    try {
                        const response = await fetch(`/api/data/${filename}/certification/`);
                        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                        const certData = await response.json();
                        if (certData.error) certDataError = certData.error;
                        else certAppraisedVal = normalizeNumericValue(certData['APPRAISED VALUE OF SUBJECT PROPERTY $']);
                    } catch (e) {
                        certDataError = e.message;
                    }

                    const values = { "Sales Grid": salesGridVal, "Recon (Sales Approach)": reconSalesVal, "Recon (Opinion)": reconOpinionVal, "Certification": certAppraisedVal };
                    const presentValues = Object.entries(values).filter(([key, val]) => val !== null);
                    
                    if (certDataError) addMessage('error', `⚠️ Could not fetch Certification value for 4-way check: ${certDataError}`);
                    if (presentValues.length < 4) addMessage('warning', `⚠️ Four-Value Check incomplete. Missing values for: ${Object.keys(values).filter(key => values[key] === null).join(', ')}.`);

                    if (presentValues.length > 1) {
                        const firstValue = presentValues[0][1];
                        if (presentValues.every(([, val]) => val === firstValue)) {
                            addMessage('success', `✅ Four-Value Check Passed: All values match at ${firstValue}.`);
                        } else {
                            let mismatchMessage = '⚠️ Four-Value Check Failed. Mismatched values found:<ul>';
                            for (const [key, val] of Object.entries(values)) mismatchMessage += `<li>${key}: ${val !== null ? val : 'Not Found'}</li>`;
                            mismatchMessage += '</ul>';
                            addMessage('error', mismatchMessage);
                        }
                    }
                }
                fourValueCheck(); // Execute the async check
            }

            /* ==========================================================
            ================= CERTIFICATION VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'certification') {
                // 1. Date Logic
                const sigDate = parseDate(getFieldValue('date of signature and report'));
                const effDate = parseDate(getFieldValue('effective date of appraisal'));
                if (sigDate && effDate) {
                    if (sigDate >= effDate) {
                        addMessage('success', "✅ Signature Date is on or after Effective Date.");
                    } else {
                        addMessage('error', "⚠️ Signature Date is before Effective Date.");
                    }
                }

                // 2. Effective Date Match
                const reconDateStr = sessionStorage.getItem('reconciliationEffectiveDate');
                if (reconDateStr) {
                    const reconDate = parseDate(reconDateStr);
                    if (effDate && reconDate) {
                        if (effDate.getTime() === reconDate.getTime()) {
                            addMessage('success', "✅ Effective Date matches Reconciliation section.");
                        } else {
                            addMessage('error', `⚠️ Effective Date mismatch: Certification (${getFieldValue('effective date of appraisal')}) vs. Reconciliation (${reconDateStr}).`);
                        }
                    }
                } else {
                    addMessage('warning', "⚠️ Could not find Effective Date from Reconciliation to compare.");
                }

                // 3. Lender Name Check
                const lenderName = getFieldValue('lender/client name');
                if (lenderName && !lenderName.toLowerCase().includes('fastapp')) {
                    addMessage('warning', "⚠️ 'Lender/Client Name' does not contain 'fastapp'.");
                } else if (lenderName) {
                    addMessage('success', "✅ Lender/Client Name contains 'fastapp'.");
                }

                // 4. Lender Consistency
                const certLenderName = getFieldValue('lender/client name');
                const certLenderAddr = getFieldValue('lender/client company address');
                const subjectLenderName = sessionStorage.getItem('subjectLenderClient');
                const subjectLenderAddr = sessionStorage.getItem('subjectLenderAddress');

                if (subjectLenderName) {
                    if (normalize(certLenderName) === normalize(subjectLenderName)) {
                        addMessage('success', "✅ Lender Name matches Subject section.");
                    } else {
                        addMessage('error', `⚠️ Lender Name mismatch: Cert ('${certLenderName}') vs. Subject ('${subjectLenderName}').`);
                    }
                }
                if (subjectLenderAddr) {
                    if (normalize(certLenderAddr) === normalize(subjectLenderAddr)) {
                        addMessage('success', "✅ Lender Address matches Subject section.");
                    } else {
                        addMessage('error', `⚠️ Lender Address mismatch: Cert ('${certLenderAddr}') vs. Subject ('${subjectLenderAddr}').`);
                    }
                }

                // 5. Address Consistency
                const certPropAddr = getFieldValue('address of property appraised');
                const subjectPropAddr = sessionStorage.getItem('subjectFullAddress');
                if (subjectPropAddr) {
                    const normCert = (certPropAddr || '').replace(/[^a-z0-9]/gi, '').toLowerCase();
                    const normSub = subjectPropAddr.replace(/[^a-z0-9]/gi, '').toLowerCase();
                    if (normCert === normSub) {
                        addMessage('success', "✅ Property Address matches Subject section.");
                    } else {
                        addMessage('error', `⚠️ Property Address mismatch: Cert ('${certPropAddr}') vs. Subject ('${subjectPropAddr}').`);
                    }
                }

                // 6. License Validation
                const certName = getFieldValue('name');
                const certLicenseNum = getFieldValue('state certification # or state license #');
                const certExpDate = getFieldValue('expiration date of certification or license');
                const docName = getFieldValue('appraiser name on license');
                const docLicenseNum = getFieldValue('license number on license');
                const docExpDate = getFieldValue('license expiration date on license');

                if (!isEmpty(docName) || !isEmpty(docLicenseNum) || !isEmpty(docExpDate)) {
                    addMessage('info', "ℹ️ Appraiser license document found. Performing validation...");
                    if (!isEmpty(certName) && !isEmpty(docName)) {
                        if (normalize(certName) === normalize(docName)) addMessage('success', "✅ Appraiser Name matches license document.");
                        else addMessage('error', `⚠️ Appraiser Name mismatch: Cert ('${certName}') vs. License Doc ('${docName}').`);
                    }
                    if (!isEmpty(certLicenseNum) && !isEmpty(docLicenseNum)) {
                        if (normalize(certLicenseNum) === normalize(docLicenseNum)) addMessage('success', "✅ License Number matches license document.");
                        else addMessage('error', `⚠️ License Number mismatch: Cert ('${certLicenseNum}') vs. License Doc ('${docLicenseNum}').`);
                    }
                    if (!isEmpty(certExpDate) && !isEmpty(docExpDate)) {
                        if (normalize(certExpDate) === normalize(docExpDate)) addMessage('success', "✅ Expiration Date matches license document.");
                        else addMessage('error', `⚠️ Expiration Date mismatch: Cert ('${certExpDate}') vs. License Doc ('${docExpDate}').`);
                    }
                } else {
                    addMessage('info', "ℹ️ No appraiser license document data found for comparison.");
                }

                // 7. E&O Insurance
                const eoExpDateStr = getFieldValue('e&o expiration date on document');
                if (!isEmpty(eoExpDateStr)) {
                    const eoExpDate = parseDate(eoExpDateStr);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (eoExpDate) {
                        if (eoExpDate < today) {
                            addMessage('error', `⚠️ E&O Insurance appears to be expired (Expiration: ${eoExpDateStr}).`);
                        } else {
                            addMessage('success', `✅ E&O Insurance is not expired (Expiration: ${eoExpDateStr}).`);
                        }
                    } else {
                        addMessage('warning', `⚠️ Could not parse E&O Expiration Date: '${eoExpDateStr}'.`);
                    }
                } else {
                    addMessage('info', "ℹ️ No E&O insurance document data found for comparison.");
                }
            }
            
            /* ==========================================================
            ================= SALE HISTORY VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'sale_history') {
                // This function will contain all the logic, including async calls
                async function validateSaleHistory() {
                    // Helper to get data from the grid part of the sale history
                    const getGridData = () => {
                        const gridHeader = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('Prior Sale History Grid'));
                        if (!gridHeader) return { subject: {}, comparables: [] };
                        const gridTable = gridHeader.nextElementSibling;
                        if (!gridTable || gridTable.tagName !== 'TABLE') return { subject: {}, comparables: [] };

                        const subjectData = {};
                        const comparablesData = [];
                        
                        const rows = gridTable.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length < 2) return;

                            const feature = cells[0].textContent.trim();
                            subjectData[feature] = cells[1].textContent.trim();

                            for (let i = 2; i < cells.length; i++) {
                                if (!comparablesData[i - 2]) {
                                    comparablesData[i - 2] = {};
                                }
                                comparablesData[i - 2][feature] = cells[i].textContent.trim();
                            }
                        });

                        return { subject: subjectData, comparables: comparablesData };
                    };

                    const gridData = getGridData();

                    // 1. Data Sources and Research Status
                    const researchPerformed = getFieldValue("I ____ research the sale or transfer history of the subject property and comparable sales.(did/did not)");
                    const subjectDataSource = getFieldValue("Data Source(s) for subject property research");
                    const compDataSource = getFieldValue("Data Source(s) for comparable sales research");

                    if (researchPerformed && researchPerformed.toLowerCase() === 'did') {
                        addMessage('success', "✅ Research Status: Research was performed ('did').");
                    } else {
                        addMessage('error', "⚠️ Research Status: 'I ____ research...' must be 'did'.");
                    }

                    if (isEmpty(subjectDataSource)) {
                        addMessage('error', "⚠️ Data Sources: Source for subject property research is missing.");
                    } else {
                        addMessage('success', "✅ Data Sources: Source for subject property is present.");
                    }

                    if (isEmpty(compDataSource)) {
                        addMessage('error', "⚠️ Data Sources: Source for comparable sales research is missing.");
                    } else {
                        addMessage('success', "✅ Data Sources: Source for comparable sales is present.");
                    }

                    // Fetch external data needed for date validations
                    let reconData, salesGridData;
                    try {
                        [reconData, salesGridData] = await Promise.all([
                            fetch(`/api/data/${filename}/reconciliation/`).then(res => res.json()),
                            fetch(`/api/data/${filename}/sales_grid/`).then(res => res.json())
                        ]);
                    } catch (e) {
                        addMessage('error', `⚠️ Could not fetch data for validation: ${e.message}`);
                        return; // Stop validation if fetches fail
                    }

                    // 2. Subject Prior Sale Validation
                    const subjectHistoryFound = getFieldValue("My research _____ reveal any prior sales or transfers of the subject property for the three years prior to the effective date of this appraisal.(did/did not)");
                    if (subjectHistoryFound && subjectHistoryFound.toLowerCase() === 'did') {
                        const priorSaleDateStr = gridData.subject['Date of Prior Sale/Transfer'];
                        const priorSalePrice = gridData.subject['Price of Prior Sale/Transfer'];

                        if (isEmpty(priorSaleDateStr) || isEmpty(priorSalePrice)) {
                            addMessage('error', "⚠️ Subject Prior Sale: Report indicates a prior sale, but 'Date' or 'Price' is missing in the grid.");
                        } else {
                            addMessage('success', "✅ Subject Prior Sale: Date and Price are present as required.");
                            
                            if (reconData.error) {
                                addMessage('warning', `⚠️ Subject Prior Sale: Could not fetch Reconciliation data to validate sale date.`);
                            } else {
                                const effectiveDateStr = reconData['Effective Date of Value'];
                                const effectiveDate = parseDate(effectiveDateStr);
                                const priorSaleDate = parseDate(priorSaleDateStr);

                                if (effectiveDate && priorSaleDate) {
                                    const threeYearsInMillis = 3 * 365.25 * 24 * 60 * 60 * 1000;
                                    if (effectiveDate.getTime() - priorSaleDate.getTime() <= threeYearsInMillis) {
                                        addMessage('success', `✅ Subject Prior Sale: Date (${priorSaleDateStr}) is within 3 years of the effective date.`);
                                    } else {
                                        addMessage('error', `⚠️ Subject Prior Sale: Date (${priorSaleDateStr}) is NOT within 3 years of the effective date.`);
                                    }
                                } else {
                                    addMessage('warning', "⚠️ Subject Prior Sale: Could not parse dates to validate 3-year history.");
                                }
                            }
                        }
                    }

                    // 3. Comparable Prior Sale Validation
                    const compHistoryFound = getFieldValue("My research ______ reveal any prior sales or transfers of the comparable sales for the year prior to the date of sale of the comparable sale.(did/did not)");
                    if (compHistoryFound && compHistoryFound.toLowerCase() === 'did') {
                        if (salesGridData.error) {
                            addMessage('warning', `⚠️ Comparable Prior Sale: Could not fetch Sales Grid data to validate sale dates.`);
                        } else {
                            const historyComps = gridData.comparables;
                            const gridComps = salesGridData.comparables;
                            let atLeastOneCompHasPriorSale = false;

                            if (!historyComps || !gridComps || historyComps.length === 0 || gridComps.length === 0) {
                                addMessage('error', "⚠️ Comparable Prior Sale: Could not retrieve comparable data from Sale History or Sales Grid.");
                            } else {
                                historyComps.forEach((histComp, i) => {
                                    const priorSaleDateStr = histComp['Date of Prior Sale/Transfer'];
                                    const priorSalePrice = histComp['Price of Prior Sale/Transfer'];
                                    
                                    if (!isEmpty(priorSaleDateStr) || !isEmpty(priorSalePrice)) {
                                        atLeastOneCompHasPriorSale = true;

                                        if (isEmpty(priorSaleDateStr) || isEmpty(priorSalePrice)) {
                                            addMessage('error', `⚠️ Comp #${i + 1} Prior Sale: Incomplete entry (missing Date or Price).`);
                                            return; // continue to next comp
                                        }

                                        const gridComp = gridComps[i];
                                        if (!gridComp) {
                                            addMessage('error', `⚠️ Comp #${i + 1} Prior Sale: Mismatch in comparable count. Cannot validate.`);
                                            return;
                                        }

                                        const compSaleDateStr = gridComp['Date of Sale/Time'];
                                        const compSaleDate = parseDate(compSaleDateStr);
                                        const compPriorSaleDate = parseDate(priorSaleDateStr);

                                        if (compSaleDate && compPriorSaleDate) {
                                            const oneYearInMillis = 365 * 24 * 60 * 60 * 1000;
                                            if (compSaleDate.getTime() - compPriorSaleDate.getTime() <= oneYearInMillis) {
                                                addMessage('success', `✅ Comp #${i + 1} Prior Sale: Date (${priorSaleDateStr}) is within 1 year of its sale date.`);
                                            } else {
                                                addMessage('error', `⚠️ Comp #${i + 1} Prior Sale: Date (${priorSaleDateStr}) is NOT within 1 year of its sale date.`);
                                            }
                                        } else {
                                            addMessage('warning', `⚠️ Comp #${i + 1} Prior Sale: Could not parse dates to validate 1-year history.`);
                                        }
                                    }
                                });

                                if (!atLeastOneCompHasPriorSale) {
                                    addMessage('error', "⚠️ Comparable Prior Sale: Report indicates prior sales were found, but no comparable has prior sale data in the grid.");
                                }
                            }
                        }
                    }
                }

                // Run the main validation function
                validateSaleHistory();
            }

            /* ==========================================================
            ================= RENTAL GRID VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'rental_grid') {
                // 1. Subject Address Consistency
                const addressRow = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent) === 'address';
                });
                const subjectAddressInGrid = addressRow ? addressRow.querySelector('td:nth-child(2)')?.textContent.trim() : null;
                const storedSubjectAddress = sessionStorage.getItem('subjectFullAddress');

                if (subjectAddressInGrid && storedSubjectAddress) {
                    const normGrid = normalize(subjectAddressInGrid).replace(/,/g, '');
                    const normStored = normalize(storedSubjectAddress).replace(/,/g, '');
                    if (normGrid === normStored) {
                        addMessage('success', "✅ Subject Address in Rental Grid matches Property Address.");
                    } else {
                        addMessage('error', `⚠️ Subject Address mismatch: Rental Grid has '${subjectAddressInGrid}', Subject section has '${storedSubjectAddress}'.`);
                    }
                }

                // 2. Proximity Check
                const proximityRow = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent).includes('proximity to subject');
                });
                if (proximityRow) {
                    const cells = Array.from(proximityRow.querySelectorAll('td')).slice(2); // Skip Feature and Subject
                    let maxDistExceeded = false;
                    let missingProximity = false;
                    
                    cells.forEach((td, idx) => {
                        const val = td.textContent.trim();
                        if (isEmpty(val)) {
                            addMessage('error', `⚠️ Comparable #${idx + 1}: Proximity is missing.`);
                            missingProximity = true;
                        } else {
                            const match = val.match(/([\d.]+)/);
                            if (match && parseFloat(match[1]) > 1.0) {
                                addMessage('warning', `⚠️ Comparable #${idx + 1} proximity (${val}) exceeds 1.0 mile.`);
                                maxDistExceeded = true;
                            }
                        }
                    });
                    if (!maxDistExceeded && !missingProximity && cells.length > 0) {
                        addMessage('success', "✅ All comparables have valid proximity (<= 1.0 mile).");
                    }
                }

                // 3. Lease Date Chronology
                const beginRow = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent).includes('date lease begins');
                });
                const expireRow = Array.from(tableRows).find(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent).includes('date lease expires');
                });
                
                if (beginRow && expireRow) {
                    const beginCells = Array.from(beginRow.querySelectorAll('td')).slice(2);
                    const expireCells = Array.from(expireRow.querySelectorAll('td')).slice(2);
                    let dateError = false;

                    beginCells.forEach((td, i) => {
                        const bVal = td.textContent.trim();
                        const eVal = expireCells[i]?.textContent.trim();
                        
                        if (!isEmpty(bVal) && !isEmpty(eVal)) {
                            const bDate = parseDate(bVal);
                            const eDate = parseDate(eVal);
                            
                            if (bDate && eDate) {
                                if (bDate >= eDate) {
                                    addMessage('error', `⚠️ Comparable #${i + 1}: Date Lease Begins (${bVal}) must be earlier than Date Lease Expires (${eVal}).`);
                                    dateError = true;
                                }
                            }
                        }
                    });

                    if (!dateError) addMessage('success', "✅ Lease dates are valid (Begins < Expires).");
                }

                // 4. Other Features Consistency
                const otherRows = Array.from(tableRows).filter(r => {
                    const cell = r.querySelector('td:first-child');
                    return cell && normalize(cell.textContent).startsWith('other');
                });

                otherRows.forEach(row => {
                    const label = row.querySelector('td:first-child').textContent.trim();
                    const subjectCell = row.querySelector('td:nth-child(2)');
                    const subjectVal = normalize(subjectCell?.textContent);
                    
                    if (!isEmpty(subjectVal)) {
                        const compCells = Array.from(row.querySelectorAll('td')).slice(2);
                        compCells.forEach((td, idx) => {
                            const compValRaw = td.textContent.trim();
                            const compValNorm = normalize(compValRaw);
                            // If different and no number (adjustment) found in comp value
                            if (compValNorm !== subjectVal && !/[1-9]/.test(compValRaw)) {
                                addMessage('warning', `⚠️ '${label}' mismatch for Comp #${idx + 1}: Subject '${subjectCell.textContent}' vs Comp '${compValRaw}'. Adjustment may be required.`);
                            }
                        });
                    }
                });

                // 5. Bracketing Check
                const indicatedRent = normalizeNumericValue(getFieldValue('indicated monthly market rent'));
                if (indicatedRent !== null) {
                    // Collect adjusted rents from table
                    const rents = [];
                    const adjRentRow = Array.from(tableRows).find(r => {
                        const cell = r.querySelector('td:first-child');
                        return cell && normalize(cell.textContent).includes('adjusted monthly rent');
                    });
                    if (adjRentRow) {
                        adjRentRow.querySelectorAll('td').forEach((td, idx) => {
                            if (idx > 1) { // Skip label and subject
                                const val = normalizeNumericValue(td.textContent);
                                if (val !== null) rents.push(val);
                            }
                        });
                    }
                    if (rents.length > 0) {
                        const min = Math.min(...rents);
                        const max = Math.max(...rents);
                        if (indicatedRent >= min && indicatedRent <= max) {
                            addMessage('success', "✅ Indicated Rent is bracketed by comps.");
                        } else {
                            addMessage('error', `⚠️ Indicated Rent (${indicatedRent}) not bracketed (${min} - ${max}).`);
                        }
                    }
                }
            }

            /* ==========================================================
            ================= COST APPROACH VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'cost_approach') {
                const totalCostNew = normalizeNumericValue(getFieldValue('Total Estimate of Cost-New'));
                const depreciation = normalizeNumericValue(getFieldValue('Depreciation'));
                const depreciatedCost = normalizeNumericValue(getFieldValue('Depreciated Cost of Improvements'));

                if (totalCostNew !== null && depreciation !== null && depreciatedCost !== null) {
                    const calculatedDepreciatedCost = totalCostNew - depreciation;
                    // Allow for small floating point differences or rounding (e.g. +/- 1)
                    if (Math.abs(calculatedDepreciatedCost - depreciatedCost) <= 1) {
                        addMessage('success', `✅ Depreciation calculation is correct: ${totalCostNew} - ${depreciation} = ${depreciatedCost}.`);
                    } else {
                        addMessage('error', `⚠️ Depreciation calculation mismatch: ${totalCostNew} - ${depreciation} = ${calculatedDepreciatedCost}, but report says ${depreciatedCost}.`);
                    }
                } else {
                    // Check if fields are missing (only warn if at least one is present, implying the section is being used)
                    if (totalCostNew !== null || depreciation !== null || depreciatedCost !== null) {
                        addMessage('warning', "⚠️ Cannot verify depreciation calculation. Ensure 'Total Estimate of Cost-New', 'Depreciation', and 'Depreciated Cost of Improvements' are numeric.");
                    }
                }

                // Async validation against Reconciliation
                async function validateCostApproachValue() {
                    const costApproachValue = getFieldValue('Indicated Value By Cost Approach');
                    if (isEmpty(costApproachValue)) return;

                    try {
                        const response = await fetch(`/api/data/${filename}/reconciliation/`);
                        if (!response.ok) return;
                        const reconData = await response.json();

                        if (reconData && !reconData.error) {
                            const reconValue = reconData["Cost Approach (if developed) $"];
                            const normCost = normalizeNumericValue(costApproachValue);
                            const normRecon = normalizeNumericValue(reconValue);

                            if (normCost !== null && normRecon !== null) {
                                if (normCost === normRecon) {
                                    addMessage('success', `✅ Value matches Reconciliation: ${costApproachValue}`);
                                } else {
                                    addMessage('error', `⚠️ Mismatch: Cost Approach (${costApproachValue}) vs Reconciliation (${reconValue}).`);
                                }
                            } else if (normCost !== null && isEmpty(reconValue)) {
                                addMessage('warning', `⚠️ Cost Approach value is ${costApproachValue}, but Reconciliation field is empty.`);
                            }
                        }
                    } catch (error) { console.error(error); }
                }
                validateCostApproachValue();
            }
            
            /* ==========================================================
            ================= INCOME APPROACH VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'income_approach') {
                const rent = normalizeNumericValue(getFieldValue('Estimated Monthly Market Rent $'));
                const grm = normalizeNumericValue(getFieldValue('X Gross Rent Multiplier = $'));
                const indicatedVal = normalizeNumericValue(getFieldValue('Indicated Value by Income Approach'));

                if (rent !== null && grm !== null && indicatedVal !== null) {
                    const calculated = rent * grm;
                    if (Math.abs(calculated - indicatedVal) <= 5) {
                        addMessage('success', `✅ Calculation correct: ${rent} * ${grm} = ${indicatedVal}.`);
                    } else {
                        addMessage('error', `⚠️ Calculation mismatch: ${rent} * ${grm} = ${calculated}, but report says ${indicatedVal}.`);
                    }
                } else if (rent !== null || grm !== null || indicatedVal !== null) {
                    addMessage('warning', "⚠️ Incomplete Income Approach data. Cannot verify calculation.");
                }

                // Async validation against Reconciliation
                async function validateIncomeApproachValue() {
                    const incomeApproachValue = getFieldValue('Indicated Value by Income Approach');
                    if (isEmpty(incomeApproachValue)) return;

                    try {
                        const response = await fetch(`/api/data/${filename}/reconciliation/`);
                        if (!response.ok) return;
                        const reconData = await response.json();

                        if (reconData && !reconData.error) {
                            const reconValue = reconData["Income Approach (if developed) $"];
                            const normIncome = normalizeNumericValue(incomeApproachValue);
                            const normRecon = normalizeNumericValue(reconValue);

                            if (normIncome !== null && normRecon !== null) {
                                if (normIncome === normRecon) {
                                    addMessage('success', `✅ Value matches Reconciliation: ${incomeApproachValue}`);
                                } else {
                                    addMessage('error', `⚠️ Mismatch: Income Approach (${incomeApproachValue}) vs Reconciliation (${reconValue}).`);
                                }
                            } else if (normIncome !== null && isEmpty(reconValue)) {
                                addMessage('warning', `⚠️ Income Approach value is ${incomeApproachValue}, but Reconciliation field is empty.`);
                            }
                        }
                    } catch (error) { console.error(error); }
                }
                validateIncomeApproachValue();
            }

            /* ==========================================================
            ================= PUD INFO VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'pud_info') {
                const isPud = sessionStorage.getItem('isPUD') === 'true';
                const dwellingType = sessionStorage.getItem('dwellingType');
                const isAttached = dwellingType ? dwellingType.includes('attached') : false;

                if (isPud) {
                    const devControl = getFieldValue("Is the developer/builder in control of the Homeowners' Association (HOA)?");
                    
                    if (devControl && devControl.toLowerCase() === 'yes') {
                        addMessage('info', "ℹ️ Developer is in control of the HOA.");

                        if (isAttached) {
                            addMessage('info', "ℹ️ Subject is an attached dwelling. Validating required project details...");
                            const projectDetailFields = [
                                "Legal Name of Project", "Total number of phases", "Total number of units", 
                                "Total number of units sold", "Total number of units rented", 
                                "Total number of units for sale", "Data source(s)"
                            ];

                            const missingFields = projectDetailFields.filter(field => isEmpty(getFieldValue(field)));

                            if (missingFields.length > 0) {
                                addMessage('error', `⚠️ Developer is in control and unit is attached, but the following project details are missing: ${missingFields.join(', ')}.`);
                            } else {
                                addMessage('success', "✅ All required project details for a developer-controlled, attached-unit PUD are present.");
                            }
                        } else {
                             addMessage('info', "ℹ️ Subject is not an attached dwelling, so detailed project information is not strictly required by the form, but should be reviewed.");
                        }
                    }
                } else {
                    addMessage('info', "ℹ️ Property is not identified as a PUD in the Subject section. No PUD-specific validation applied.");
                }
            }

            /* ==========================================================
            ================= MARKET CONDITIONS & CONDO VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'market_conditions' || sectionKey === 'condo') {
                const gridTitle = sectionKey === 'market_conditions' ? 'Market Conditions Analysis Grid' : 'Subject Project Data Grid';
                const gridHeader = Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes(gridTitle));
                
                if (gridHeader) {
                    const gridTable = gridHeader.nextElementSibling;
                    const headerCells = Array.from(gridTable.querySelectorAll('thead th'));
                    const bodyRows = Array.from(gridTable.querySelectorAll('tbody tr'));
                    const missingCells = [];

                    bodyRows.forEach(row => {
                        const rowLabel = row.querySelector('td:first-child')?.textContent.trim();
                        const dataCells = Array.from(row.querySelectorAll('td')).slice(1);

                        dataCells.forEach((cell, index) => {
                            if (isEmpty(cell.textContent)) {
                                const colLabel = headerCells[index + 1]?.textContent.trim(); // +1 to account for sliced cells
                                missingCells.push(`'${rowLabel}' for '${colLabel}'`);
                            }
                        });
                    });

                    if (missingCells.length > 0) {
                        addMessage('error', `⚠️ The following grid cells are empty: ${missingCells.join(', ')}.`);
                    } else {
                        addMessage('success', `✅ The ${gridTitle} is complete.`);
                    }
                }
            }

            /* ==========================================================
            ================= CLIENT/LENDER VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'client_lender_requirements') {
                let clientIdentified = true;

                tableRows.forEach(row => {
                    const label = row.querySelector('td:first-child')?.textContent.trim();
                    const valRaw = row.querySelector('td:last-child')?.textContent?.trim();
                    if (!valRaw) return;
                    const val = valRaw.toLowerCase();

                    if (val.includes('n/a - client not identified')) {
                        clientIdentified = false;
                        row.style.backgroundColor = '#f3f4f6';
                    } else if (val.includes('failed:')) {
                        row.style.backgroundColor = '#fee2e2';
                        addMessage('error', `❌ ${label}: ${valRaw}`);
                    } else if (val.includes('escalate:')) {
                        row.style.backgroundColor = '#fee2e2';
                        addMessage('error', `⚠️ ESCALATION REQUIRED: ${label}: ${valRaw}`);
                    } else if (val.includes('passed:') || val.includes('n/a - rule does not apply')) {
                        row.style.backgroundColor = '#dcfce7';
                    } else if (val.includes('advisory:') || val.includes('info:') || val.includes('reviewer reminders:') || val.includes('rov handling:')) {
                        row.style.backgroundColor = '#e0f2fe';
                        addMessage('info', `ℹ️ ${label}: ${valRaw}`);
                    }
                });

                if (!clientIdentified) {
                    addMessage('error', "⚠️ Could not identify a specific client or apply any rules. Please verify the client name in the report.");
                }
            }

            /* ==========================================================
            ================= STATE REQUIREMENT VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'state_requirement') {
                const state = sessionStorage.getItem('subjectState');

                if (!state) {
                    addMessage('error', "⚠️ Could not determine Subject State. Please review the Subject section first.");
                } else {
                    let rulesFound = false;

                    const checkField = (fieldName) => {
                        const val = getFieldValue(fieldName);
                        // Find the row to highlight it
                        const row = Array.from(tableRows).find(r => {
                            const cell = r.querySelector('td:first-child');
                            return cell && normalize(cell.textContent).includes(normalize(fieldName));
                        });

                        if (val) {
                            const vLower = val.toLowerCase();
                            let status = 'warning';

                            // Check failure keywords first
                            if (vLower.includes('not found') || vLower.includes('missing') || vLower.includes('not present') || vLower.includes('failed')) {
                                status = 'failed';
                            } 
                            // Check success keywords if not failed
                            else if (vLower.includes('found') || vLower.includes('disclosed') || vLower.includes('present') || vLower.includes('verified') || vLower.includes('passed')) {
                                status = 'passed';
                            }

                            if (status === 'passed') {
                                if (row) row.style.backgroundColor = '#dcfce7';
                                addMessage('success', `✅ ${fieldName}: ${val}`);
                            } else if (status === 'failed') {
                                if (row) row.style.backgroundColor = '#fee2e2';
                                addMessage('error', `❌ ${fieldName}: ${val}`);
                            } else {
                                addMessage('warning', `⚠️ ${fieldName}: ${val}`);
                            }
                        }
                    };

                    // Group 1: Appraiser Fee Disclosure
                    const feeStates = ['AZ', 'CO', 'CT', 'GA', 'IL', 'LA', 'NJ', 'NV', 'NM', 'ND', 'OH', 'UT', 'VA', 'VT', 'WV'];
                    if (feeStates.includes(state)) {
                        checkField('Appraiser Fee Disclosure');
                        rulesFound = true;
                    }

                    // Group 2: AMC License Disclosure
                    const amcLicStates = ['GA', 'IL', 'MT', 'NJ', 'OH', 'VT'];
                    if (amcLicStates.includes(state)) {
                        checkField('AMC License Disclosure');
                        rulesFound = true;
                    }

                    // Group 3: AMC Fee Disclosure
                    const amcFeeStates = ['NV', 'NM', 'UT'];
                    if (amcFeeStates.includes(state)) {
                        checkField('AMC Fee Disclosure');
                        rulesFound = true;
                    }

                    // Specific State Rules
                    if (state === 'CA') { checkField('Smoke/CO Detector Requirements'); checkField('Water Heater Strapping'); rulesFound = true; }
                    else if (state === 'GA') { addMessage('info', "ℹ️ Advisory: Appraiser’s fee & AMC License # are required."); rulesFound = true; }
                    else if (state === 'IL') { checkField('Smoke/CO Detector Requirements'); checkField('State-Specific Legal Statements'); rulesFound = true; }
                    else if (state === 'NY') { checkField('Invoice Copy Requirement'); rulesFound = true; }
                    else if (state === 'OH' || state === 'VT') { addMessage('info', "ℹ️ Advisory: Appraiser’s fee & AMC License # are required."); rulesFound = true; }
                    else if (state === 'UT') { checkField('Water Heater Strapping'); rulesFound = true; }
                    else if (state === 'VA') { checkField('Smoke/CO Detector Requirements'); rulesFound = true; }
                    else if (state === 'WI') { checkField('Smoke/CO Detector Requirements'); rulesFound = true; }

                    if (!rulesFound) {
                        addMessage('success', `✅ No specific state-level requirements found for ${state} in the defined rules.`);
                    }
                }
            }

            /* ==========================================================
            ================= REPORT DETAILS VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'report_details') {
                const missingItems = [];
                tableRows.forEach(row => {
                    const label = row.querySelector('td:first-child')?.textContent.trim();
                    const value = (row.querySelector('td:last-child')?.textContent || '').trim().toLowerCase();

                    if (value.includes('missing')) {
                        missingItems.push(label);
                        row.style.backgroundColor = '#fee2e2';
                    } else if (value.includes('present')) {
                        row.style.backgroundColor = '#dcfce7';
                    }
                });

                if (missingItems.length > 0) {
                    addMessage('error', `⚠️ The following items are marked as Missing: ${missingItems.join(', ')}.`);
                } else {
                    addMessage('success', "✅ All checked report details are present.");
                }
            }

            /* ==========================================================
            ================= ESCALATION CHECK VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'escalation_check') {
                const failedChecks = [];
                tableRows.forEach(row => {
                    const checkName = (row.querySelector('td:first-child')?.textContent || '').trim();
                    const finding = (row.querySelector('td:last-child')?.textContent || '').trim().toLowerCase();

                    if (finding.includes('failed') || finding.includes('critical warning')) {
                        failedChecks.push(checkName);
                        row.style.backgroundColor = '#fee2e2';
                    } else if (finding.includes('passed')) {
                        row.style.backgroundColor = '#dcfce7';
                    }
                });

                if (failedChecks.length > 0) {
                    addMessage('error', `⚠️ <strong>Escalation Required:</strong> The following checks failed:<br><ul>${failedChecks.map(c => `<li>${c}</li>`).join('')}</ul>`);
                } else {
                    addMessage('success', "✅ No critical escalation failures detected.");
                }
            }

            /* ==========================================================
            ================= CUSTOM ANALYSIS VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'custom_analysis') {
                const summaryEl = document.querySelector('.custom-analysis-summary p:last-child');
                const promptEl = document.querySelector('.query-display p:last-child');

                if (summaryEl && promptEl) {
                    const summary = normalize(summaryEl.textContent);
                    const prompt = normalize(promptEl.textContent);

                    // 1. GLA Consistency
                    if (prompt.includes('gla') || prompt.includes('gross living area')) {
                        if (summary.includes('inconsistency') || summary.includes('discrepancy') || summary.includes('mismatch') || summary.includes('different')) {
                            addMessage('error', "⚠️ GLA Consistency Check Failed: Discrepancies found.");
                        } else if (summary.includes('consistent') || summary.includes('no discrepancies') || summary.includes('match')) {
                            addMessage('success', "✅ GLA Consistency Check Passed.");
                        }
                    }
                    // 2. Subject Address/Photo
                    else if (prompt.includes('subject') && (prompt.includes('address') || prompt.includes('photo'))) {
                        if (summary.includes('duplicate') || summary.includes('mismatch') || summary.includes('inconsistent') || summary.includes('different')) {
                            addMessage('error', "⚠️ Subject Address/Photo Check Failed: Issues found.");
                        } else if (summary.includes('consistently') || summary.includes('consistent') || summary.includes('verified') || summary.includes('no duplicates') || summary.includes('match')) {
                            addMessage('success', "✅ Subject Address/Photo Check Passed.");
                        }
                    }
                    // 3. Room Counts
                    else if (prompt.includes('room') || prompt.includes('bedroom') || prompt.includes('bathroom')) {
                        if (summary.includes('discrepancy') || summary.includes('mismatch') || summary.includes('inconsistent')) {
                            addMessage('error', "⚠️ Room Count Check Failed: Discrepancies found.");
                        } else if (summary.includes('consistent') || summary.includes('match')) {
                            addMessage('success', "✅ Room Count Check Passed.");
                        }
                    }
                    // 4. Comparable Address/Photos
                    else if (prompt.includes('comparable') && (prompt.includes('address') || prompt.includes('photo'))) {
                        if (summary.includes('duplicate') || summary.includes('same photo') || summary.includes('mismatch')) {
                            addMessage('error', "⚠️ Comparable Address/Photo Check Failed: Duplicates or mismatches found.");
                        } else if (summary.includes('distinct') || summary.includes('no duplicate')) {
                            addMessage('success', "✅ Comparable Address/Photo Check Passed.");
                        }
                    }
                    // 5. Photo Labels
                    else if (prompt.includes('label')) {
                        if (summary.includes('incorrect') || summary.includes('duplicate') || summary.includes('mismatch')) {
                            addMessage('error', "⚠️ Photo Label Check Failed.");
                        } else if (summary.includes('correctly labeled') || summary.includes('no duplicate')) {
                            addMessage('success', "✅ Photo Label Check Passed.");
                        }
                    }
                    // 6. ADU Criteria
                    else if (prompt.includes('adu') || prompt.includes('accessory unit')) {
                        if (summary.includes('does not align') || summary.includes('fail') || summary.includes('uncheck') || summary.includes('escalate')) {
                            addMessage('error', "⚠️ ADU Criteria Check Failed.");
                        } else if (summary.includes('aligns') || summary.includes('criteria met') || summary.includes('met')) {
                            addMessage('success', "✅ ADU Criteria Check Passed.");
                        }
                    }
                }
            }

            /* ==========================================================
            ================= ALL IN ONE CHECK VALIDATIONS ===================
            ========================================================== */
            if (sectionKey === 'all_in_one_check') {
                let issueCount = 0;
                tableRows.forEach(row => {
                    const statusCell = row.querySelector('td:first-child');
                    if (statusCell) {
                        const statusText = (statusCell.textContent || '').trim().toLowerCase();
                        if (statusText.includes('inconsistent') || statusText.includes('missing') || statusText.includes('failed') || statusText.includes('fail')) {
                            issueCount++;
                            row.style.backgroundColor = '#fee2e2';
                        }
                    }
                });

                if (issueCount > 0) {
                    addMessage('error', `⚠️ Found ${issueCount} issues in the comprehensive check (Inconsistent, Missing, or Failed).`);
                } else {
                    addMessage('success', "✅ All comprehensive checks passed.");
                }
            }
        }
    });
    </script>
</body>
</html>